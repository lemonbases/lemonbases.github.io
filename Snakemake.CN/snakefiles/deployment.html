

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Distribution and Reproducibility &mdash; Snakemake 5.6.0+8.g89bc383.dirty documentation</title>
  

  
  
  
  

  
  <script type="text/javascript" src="../_static/js/modernizr.min.js"></script>
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>
        <script type="text/javascript" src="../_static/jquery.js"></script>
        <script type="text/javascript" src="../_static/underscore.js"></script>
        <script type="text/javascript" src="../_static/doctools.js"></script>
        <script type="text/javascript" src="../_static/language_data.js"></script>
    
    <script type="text/javascript" src="../_static/js/theme.js"></script>

    

  
  <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../_static/sphinx-argparse.css" type="text/css" />
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Reports" href="reporting.html" />
    <link rel="prev" title="Utils" href="utils.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../index.html" class="icon icon-home"> Snakemake
          

          
          </a>

          
            
            
              <div class="version">
                5.6.0+8.g89bc383.dirty
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">Getting started</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../getting_started/installation.html">安装</a></li>
<li class="toctree-l1"><a class="reference internal" href="../getting_started/examples.html">Examples</a></li>
<li class="toctree-l1"><a class="reference internal" href="../tutorial/tutorial.html">Snakemake Tutorial</a></li>
<li class="toctree-l1"><a class="reference internal" href="../tutorial/short.html">Short tutorial</a></li>
</ul>
<p class="caption"><span class="caption-text">Executing workflows</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../executable.html">Executing Snakemake</a></li>
</ul>
<p class="caption"><span class="caption-text">Defining workflows</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="writing_snakefiles.html">Writing Workflows</a></li>
<li class="toctree-l1"><a class="reference internal" href="rules.html">Rules</a></li>
<li class="toctree-l1"><a class="reference internal" href="configuration.html">Configuration</a></li>
<li class="toctree-l1"><a class="reference internal" href="modularization.html">Modularization</a></li>
<li class="toctree-l1"><a class="reference internal" href="remote_files.html">Remote files</a></li>
<li class="toctree-l1"><a class="reference internal" href="utils.html">Utils</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">Distribution and Reproducibility</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#integrated-package-management">Integrated Package Management</a></li>
<li class="toctree-l2"><a class="reference internal" href="#running-jobs-in-containers">Running jobs in containers</a></li>
<li class="toctree-l2"><a class="reference internal" href="#combining-conda-package-management-with-containers">Combining Conda package management with containers</a></li>
<li class="toctree-l2"><a class="reference internal" href="#sustainable-and-reproducible-archiving">Sustainable and reproducible archiving</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="reporting.html">Reports</a></li>
</ul>
<p class="caption"><span class="caption-text">API Reference</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../api_reference/snakemake.html">The Snakemake API</a></li>
<li class="toctree-l1"><a class="reference internal" href="../api_reference/snakemake_utils.html">Additional utils</a></li>
<li class="toctree-l1"><a class="reference internal" href="../api_reference/internal/modules.html">Internal API</a></li>
</ul>
<p class="caption"><span class="caption-text">Project Info</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../project_info/citations.html">Citing and Citations</a></li>
<li class="toctree-l1"><a class="reference internal" href="../project_info/more_resources.html">More Resources</a></li>
<li class="toctree-l1"><a class="reference internal" href="../project_info/faq.html">Frequently Asked Questions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../project_info/contributing.html">Contributing</a></li>
<li class="toctree-l1"><a class="reference internal" href="../project_info/authors.html">Credits</a></li>
<li class="toctree-l1"><a class="reference internal" href="../project_info/history.html">Change Log</a></li>
<li class="toctree-l1"><a class="reference internal" href="../project_info/license.html">License</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">Snakemake</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../index.html">Docs</a> &raquo;</li>
        
      <li>Distribution and Reproducibility</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="../_sources/snakefiles/deployment.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="distribution-and-reproducibility">
<h1>Distribution and Reproducibility<a class="headerlink" href="#distribution-and-reproducibility" title="Permalink to this headline">¶</a></h1>
<p>It is recommended to store each workflow in a dedicated git repository of the
following structure:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>├── .gitignore
├── README.md
├── LICENSE.md
├── config.yaml
├── scripts
│   ├── script1.py
│   └── script2.R
├── envs
│   └── myenv.yaml
└── Snakefile
</pre></div>
</div>
<p>Then, a workflow can be deployed to a new system via the following steps</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># clone workflow into working directory</span>
<span class="n">git</span> <span class="n">clone</span> <span class="n">https</span><span class="p">:</span><span class="o">//</span><span class="n">bitbucket</span><span class="o">.</span><span class="n">org</span><span class="o">/</span><span class="n">user</span><span class="o">/</span><span class="n">myworkflow</span><span class="o">.</span><span class="n">git</span> <span class="n">path</span><span class="o">/</span><span class="n">to</span><span class="o">/</span><span class="n">workdir</span>
<span class="n">cd</span> <span class="n">path</span><span class="o">/</span><span class="n">to</span><span class="o">/</span><span class="n">workdir</span>

<span class="c1"># edit config and workflow as needed</span>
<span class="n">vim</span> <span class="n">config</span><span class="o">.</span><span class="n">yaml</span>

<span class="c1"># execute workflow, deploy software dependencies via conda</span>
<span class="n">snakemake</span> <span class="o">-</span><span class="n">n</span> <span class="o">--</span><span class="n">use</span><span class="o">-</span><span class="n">conda</span>
</pre></div>
</div>
<p>Importantly, git branching and pull requests can be used to modify and possibly re-integrate workflows.
A <a class="reference external" href="https://github.com/audreyr/cookiecutter">cookiecutter</a> template for creating this structure can be found <a class="reference external" href="https://github.com/snakemake-workflows/cookiecutter-snakemake-workflow">here</a>.
Given that cookiecutter is installed, you can use it via:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>cookiecutter gh:snakemake-workflows/cookiecutter-snakemake-workflow
</pre></div>
</div>
<p>Visit the <a class="reference external" href="https://github.com/snakemake-workflows/docs">Snakemake Workflows Project</a> for best-practice workflows.</p>
<div class="section" id="integrated-package-management">
<span id="id1"></span><h2>Integrated Package Management<a class="headerlink" href="#integrated-package-management" title="Permalink to this headline">¶</a></h2>
<p>With Snakemake 3.9.0 it is possible to define isolated software environments per rule.
Upon execution of a workflow, the <a class="reference external" href="http://conda.pydata.org">Conda package manager</a> is used to obtain and deploy the defined software packages in the specified versions. Packages will be installed into your working directory, without requiring any admin/root priviledges.
Given that conda is available on your system (see <a class="reference external" href="http://conda.pydata.org/miniconda.html">Miniconda</a>), to use the Conda integration, add the <code class="docutils literal notranslate"><span class="pre">--use-conda</span></code> flag to your workflow execution command, e.g. <code class="docutils literal notranslate"><span class="pre">snakemake</span> <span class="pre">--cores</span> <span class="pre">8</span> <span class="pre">--use-conda</span></code>.
When <code class="docutils literal notranslate"><span class="pre">--use-conda</span></code> is activated, Snakemake will automatically create software environments for any used wrapper (see <a class="reference internal" href="modularization.html#snakefiles-wrappers"><span class="std std-ref">Wrappers</span></a>).
Further, you can manually define environments via the <code class="docutils literal notranslate"><span class="pre">conda</span></code> directive, e.g.:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">rule</span> <span class="n">NAME</span><span class="p">:</span>
    <span class="nb">input</span><span class="p">:</span>
        <span class="s2">&quot;table.txt&quot;</span>
    <span class="n">output</span><span class="p">:</span>
        <span class="s2">&quot;plots/myplot.pdf&quot;</span>
    <span class="n">conda</span><span class="p">:</span>
        <span class="s2">&quot;envs/ggplot.yaml&quot;</span>
    <span class="n">script</span><span class="p">:</span>
        <span class="s2">&quot;scripts/plot-stuff.R&quot;</span>
</pre></div>
</div>
<p>with the following <a class="reference external" href="http://conda.pydata.org/docs/using/envs.html#create-environment-file-by-hand">environment definition</a>:</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">channels</span><span class="p">:</span>
 <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">r</span>
<span class="nt">dependencies</span><span class="p">:</span>
 <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">r=3.3.1</span>
 <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">r-ggplot2=2.1.0</span>
</pre></div>
</div>
<p>The path to the environment definition is interpreted as <strong>relative to the Snakefile that contains the rule</strong> (unless it is an absolute path, which is discouraged).</p>
<div class="sidebar">
<p class="first sidebar-title">Note</p>
<p class="last">Note that conda environments are only used with <code class="docutils literal notranslate"><span class="pre">shell</span></code>, <code class="docutils literal notranslate"><span class="pre">script</span></code> and the <code class="docutils literal notranslate"><span class="pre">wrapper</span></code> directive, not the <code class="docutils literal notranslate"><span class="pre">run</span></code> directive.
The reason is that the <code class="docutils literal notranslate"><span class="pre">run</span></code> directive has access to the rest of the Snakefile (e.g. globally defined variables) and therefore must be executed in the same process as Snakemake itself.</p>
</div>
<p>Snakemake will store the environment persistently in <code class="docutils literal notranslate"><span class="pre">.snakemake/conda/$hash</span></code> with <code class="docutils literal notranslate"><span class="pre">$hash</span></code> being the MD5 hash of the environment definition file content. This way, updates to the environment definition are automatically detected.
Note that you need to clean up environments manually for now. However, in many cases they are lightweight and consist of symlinks to your central conda installation.</p>
</div>
<div class="section" id="running-jobs-in-containers">
<span id="singularity"></span><h2>Running jobs in containers<a class="headerlink" href="#running-jobs-in-containers" title="Permalink to this headline">¶</a></h2>
<p>As an alternative to using Conda (see above), it is possible to define, for each rule, a docker or singularity container to use, e.g.,</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">rule</span> <span class="n">NAME</span><span class="p">:</span>
    <span class="nb">input</span><span class="p">:</span>
        <span class="s2">&quot;table.txt&quot;</span>
    <span class="n">output</span><span class="p">:</span>
        <span class="s2">&quot;plots/myplot.pdf&quot;</span>
    <span class="n">singularity</span><span class="p">:</span>
        <span class="s2">&quot;docker://joseespinosa/docker-r-ggplot2&quot;</span>
    <span class="n">script</span><span class="p">:</span>
        <span class="s2">&quot;scripts/plot-stuff.R&quot;</span>
</pre></div>
</div>
<p>When executing Snakemake with</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>snakemake --use-singularity
</pre></div>
</div>
<p>it will execute the job within a singularity container that is spawned from the given image.
Allowed image urls entail everything supported by singularity (e.g., <code class="docutils literal notranslate"><span class="pre">shub://</span></code> and <code class="docutils literal notranslate"><span class="pre">docker://</span></code>).</p>
<div class="sidebar">
<p class="first sidebar-title">Note</p>
<p class="last">Note that singularity integration is only used with <code class="docutils literal notranslate"><span class="pre">shell</span></code>, <code class="docutils literal notranslate"><span class="pre">script</span></code> and the <code class="docutils literal notranslate"><span class="pre">wrapper</span></code> directive, not the <code class="docutils literal notranslate"><span class="pre">run</span></code> directive.
The reason is that the <code class="docutils literal notranslate"><span class="pre">run</span></code> directive has access to the rest of the Snakefile (e.g. globally defined variables) and therefore must be executed in the same process as Snakemake itself.</p>
</div>
<p>When <code class="docutils literal notranslate"><span class="pre">--use-singularity</span></code> is combined with <code class="docutils literal notranslate"><span class="pre">--kubernetes</span></code> (see <a class="reference internal" href="../executable.html#kubernetes"><span class="std std-ref">Executing a Snakemake workflow via kubernetes</span></a>), cloud jobs will be automatically configured to run in priviledged mode, because this is a current requirement of the singularity executable.
Importantly, those privileges won’t be shared by the actual code that is executed in the singularity container though.</p>
</div>
<div class="section" id="combining-conda-package-management-with-containers">
<h2>Combining Conda package management with containers<a class="headerlink" href="#combining-conda-package-management-with-containers" title="Permalink to this headline">¶</a></h2>
<p>While <a class="reference internal" href="#integrated-package-management"><span class="std std-ref">Integrated Package Management</span></a> provides control over the used software in exactly
the desired versions, it does not control the underlying operating system.
Here, it becomes handy that Snakemake &gt;=4.8.0 allows to combine Conda-based package management
with <a class="reference internal" href="#singularity"><span class="std std-ref">Running jobs in containers</span></a>.
For example, you can write</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">singularity</span><span class="p">:</span> <span class="s2">&quot;docker://continuumio/miniconda3:4.4.10&quot;</span>

<span class="n">rule</span> <span class="n">NAME</span><span class="p">:</span>
    <span class="nb">input</span><span class="p">:</span>
        <span class="s2">&quot;table.txt&quot;</span>
    <span class="n">output</span><span class="p">:</span>
        <span class="s2">&quot;plots/myplot.pdf&quot;</span>
    <span class="n">conda</span><span class="p">:</span>
        <span class="s2">&quot;envs/ggplot.yaml&quot;</span>
    <span class="n">script</span><span class="p">:</span>
        <span class="s2">&quot;scripts/plot-stuff.R&quot;</span>
</pre></div>
</div>
<p>in other words, a global definition of a container image can be combined with a
per-rule conda directive.
Then, upon invocation with</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>snakemake --use-conda --use-singularity
</pre></div>
</div>
<p>Snakemake will first pull the defined container image, and then create the requested conda environment from within the container.
The conda environments will still be stored in your working environment, such that they don’t have to be recreated unless they have changed.
The hash under which the environments are stored includes the used container image url, such that changes to the container image also lead to new environments to be created.
When a job is executed, Snakemake will first enter the container and then activate the conda environment.</p>
<p>By this, both packages and OS can be easily controlled without the overhead of creating and distributing specialized container images.
Of course, it is also possible (though less common) to define a container image per rule in this scenario.</p>
<p>The user can, upon execution, freely choose the desired level of reproducibility:</p>
<ul class="simple">
<li>no package management (use whatever is on the system)</li>
<li>Conda based package management (use versions defined by the workflow developer)</li>
<li>Conda based package management in containerized OS (use versions and OS defined by the workflow developer)</li>
</ul>
</div>
<div class="section" id="sustainable-and-reproducible-archiving">
<h2>Sustainable and reproducible archiving<a class="headerlink" href="#sustainable-and-reproducible-archiving" title="Permalink to this headline">¶</a></h2>
<p>With Snakemake 3.10.0 it is possible to archive a workflow into a
<a class="reference external" href="https://en.wikipedia.org/wiki/Tar_(computing)">tarball</a>
(<cite>.tar</cite>, <cite>.tar.gz</cite>, <cite>.tar.bz2</cite>, <cite>.tar.xz</cite>), via</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>snakemake --archive my-workflow.tar.gz
</pre></div>
</div>
<p>If above layout is followed, this will archive any code and config files that
is under git version control. Further, all input files will be included into the
archive. Finally, the software packages of each defined conda environment are included.
This results in a self-contained workflow archive that can be re-executed on a
vanilla machine that only has Conda and Snakemake installed via</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>tar -xf my-workflow.tar.gz
snakemake -n
</pre></div>
</div>
<p>Note that the archive is platform specific. For example, if created on Linux, it will
run on any Linux newer than the minimum version that has been supported by the used
Conda packages at the time of archiving (e.g. CentOS 6).</p>
<p>A useful pattern when publishing data analyses is to create such an archive,
upload it to <a class="reference external" href="https://zenodo.org/">Zenodo</a> and thereby obtain a
<a class="reference external" href="https://en.wikipedia.org/wiki/Digital_object_identifier">DOI</a>.
Then, the DOI can be cited in manuscripts, and readers are able to download
and reproduce the data analysis at any time in the future.</p>
</div>
</div>


           </div>
           
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="reporting.html" class="btn btn-neutral float-right" title="Reports" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="utils.html" class="btn btn-neutral float-left" title="Utils" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2014-2016, Johannes Koester

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>