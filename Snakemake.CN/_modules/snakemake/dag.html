

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>snakemake.dag &mdash; Snakemake 5.6.0+8.g89bc383.dirty documentation</title>
  

  
  
  
  

  
  <script type="text/javascript" src="../../_static/js/modernizr.min.js"></script>
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
        <script type="text/javascript" src="../../_static/jquery.js"></script>
        <script type="text/javascript" src="../../_static/underscore.js"></script>
        <script type="text/javascript" src="../../_static/doctools.js"></script>
        <script type="text/javascript" src="../../_static/language_data.js"></script>
    
    <script type="text/javascript" src="../../_static/js/theme.js"></script>

    

  
  <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/sphinx-argparse.css" type="text/css" />
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../index.html" class="icon icon-home"> Snakemake
          

          
          </a>

          
            
            
              <div class="version">
                5.6.0+8.g89bc383.dirty
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">Getting started</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../getting_started/installation.html">安装</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../getting_started/examples.html">Examples</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../tutorial/tutorial.html">Snakemake Tutorial</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../tutorial/short.html">Short tutorial</a></li>
</ul>
<p class="caption"><span class="caption-text">Executing workflows</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../executable.html">Executing Snakemake</a></li>
</ul>
<p class="caption"><span class="caption-text">Defining workflows</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../snakefiles/writing_snakefiles.html">Writing Workflows</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../snakefiles/rules.html">Rules</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../snakefiles/configuration.html">Configuration</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../snakefiles/modularization.html">Modularization</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../snakefiles/remote_files.html">Remote files</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../snakefiles/utils.html">Utils</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../snakefiles/deployment.html">Distribution and Reproducibility</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../snakefiles/reporting.html">Reports</a></li>
</ul>
<p class="caption"><span class="caption-text">API Reference</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../api_reference/snakemake.html">The Snakemake API</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../api_reference/snakemake_utils.html">Additional utils</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../api_reference/internal/modules.html">Internal API</a></li>
</ul>
<p class="caption"><span class="caption-text">Project Info</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../project_info/citations.html">Citing and Citations</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../project_info/more_resources.html">More Resources</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../project_info/faq.html">Frequently Asked Questions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../project_info/contributing.html">Contributing</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../project_info/authors.html">Credits</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../project_info/history.html">Change Log</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../project_info/license.html">License</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">Snakemake</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../index.html">Docs</a> &raquo;</li>
        
          <li><a href="../index.html">Module code</a> &raquo;</li>
        
          <li><a href="../snakemake.html">snakemake</a> &raquo;</li>
        
      <li>snakemake.dag</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <h1>Source code for snakemake.dag</h1><div class="highlight"><pre>
<span></span><span class="n">__author__</span> <span class="o">=</span> <span class="s2">&quot;Johannes Köster&quot;</span>
<span class="n">__copyright__</span> <span class="o">=</span> <span class="s2">&quot;Copyright 2015, Johannes Köster&quot;</span>
<span class="n">__email__</span> <span class="o">=</span> <span class="s2">&quot;koester@jimmy.harvard.edu&quot;</span>
<span class="n">__license__</span> <span class="o">=</span> <span class="s2">&quot;MIT&quot;</span>

<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">shutil</span>
<span class="kn">import</span> <span class="nn">textwrap</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">tarfile</span>
<span class="kn">from</span> <span class="nn">collections</span> <span class="k">import</span> <span class="n">defaultdict</span><span class="p">,</span> <span class="n">Counter</span>
<span class="kn">from</span> <span class="nn">itertools</span> <span class="k">import</span> <span class="n">chain</span><span class="p">,</span> <span class="n">combinations</span><span class="p">,</span> <span class="n">filterfalse</span><span class="p">,</span> <span class="n">product</span><span class="p">,</span> <span class="n">groupby</span>
<span class="kn">from</span> <span class="nn">functools</span> <span class="k">import</span> <span class="n">partial</span><span class="p">,</span> <span class="n">lru_cache</span>
<span class="kn">from</span> <span class="nn">inspect</span> <span class="k">import</span> <span class="n">isfunction</span><span class="p">,</span> <span class="n">ismethod</span>
<span class="kn">from</span> <span class="nn">operator</span> <span class="k">import</span> <span class="n">itemgetter</span><span class="p">,</span> <span class="n">attrgetter</span>
<span class="kn">from</span> <span class="nn">pathlib</span> <span class="k">import</span> <span class="n">Path</span>
<span class="kn">import</span> <span class="nn">subprocess</span>
<span class="kn">import</span> <span class="nn">uuid</span>

<span class="kn">from</span> <span class="nn">snakemake.io</span> <span class="k">import</span> <span class="n">IOFile</span><span class="p">,</span> <span class="n">_IOFile</span><span class="p">,</span> <span class="n">PeriodicityDetector</span><span class="p">,</span> <span class="n">wait_for_files</span><span class="p">,</span> <span class="n">is_flagged</span><span class="p">,</span> <span class="n">contains_wildcard</span>
<span class="kn">from</span> <span class="nn">snakemake.jobs</span> <span class="k">import</span> <span class="n">Job</span><span class="p">,</span> <span class="n">Reason</span><span class="p">,</span> <span class="n">GroupJob</span>
<span class="kn">from</span> <span class="nn">snakemake.exceptions</span> <span class="k">import</span> <span class="n">RuleException</span><span class="p">,</span> <span class="n">MissingInputException</span>
<span class="kn">from</span> <span class="nn">snakemake.exceptions</span> <span class="k">import</span> <span class="n">MissingRuleException</span><span class="p">,</span> <span class="n">AmbiguousRuleException</span>
<span class="kn">from</span> <span class="nn">snakemake.exceptions</span> <span class="k">import</span> <span class="n">CyclicGraphException</span><span class="p">,</span> <span class="n">MissingOutputException</span>
<span class="kn">from</span> <span class="nn">snakemake.exceptions</span> <span class="k">import</span> <span class="n">IncompleteFilesException</span><span class="p">,</span> <span class="n">ImproperOutputException</span>
<span class="kn">from</span> <span class="nn">snakemake.exceptions</span> <span class="k">import</span> <span class="n">PeriodicWildcardError</span><span class="p">,</span> <span class="n">WildcardError</span>
<span class="kn">from</span> <span class="nn">snakemake.exceptions</span> <span class="k">import</span> <span class="n">RemoteFileException</span><span class="p">,</span> <span class="n">WorkflowError</span><span class="p">,</span> <span class="n">ChildIOException</span>
<span class="kn">from</span> <span class="nn">snakemake.exceptions</span> <span class="k">import</span> <span class="n">UnexpectedOutputException</span><span class="p">,</span> <span class="n">InputFunctionException</span>
<span class="kn">from</span> <span class="nn">snakemake.logging</span> <span class="k">import</span> <span class="n">logger</span>
<span class="kn">from</span> <span class="nn">snakemake.common</span> <span class="k">import</span> <span class="n">DYNAMIC_FILL</span>
<span class="kn">from</span> <span class="nn">snakemake</span> <span class="k">import</span> <span class="n">conda</span><span class="p">,</span> <span class="n">singularity</span>
<span class="kn">from</span> <span class="nn">snakemake</span> <span class="k">import</span> <span class="n">utils</span>
<span class="kn">from</span> <span class="nn">snakemake.output_index</span> <span class="k">import</span> <span class="n">OutputIndex</span>
<span class="kn">from</span> <span class="nn">snakemake</span> <span class="k">import</span> <span class="n">workflow</span>


<div class="viewcode-block" id="DAG"><a class="viewcode-back" href="../../api_reference/internal/snakemake.html#snakemake.dag.DAG">[docs]</a><span class="k">class</span> <span class="nc">DAG</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Directed acyclic graph of jobs.&quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                 <span class="n">workflow</span><span class="p">,</span>
                 <span class="n">rules</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">dryrun</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                 <span class="n">targetfiles</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">targetrules</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">forceall</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                 <span class="n">forcerules</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">forcefiles</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">priorityfiles</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">priorityrules</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">untilfiles</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">untilrules</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">omitfiles</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">omitrules</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">ignore_ambiguity</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                 <span class="n">force_incomplete</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                 <span class="n">ignore_incomplete</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                 <span class="n">notemp</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                 <span class="n">keep_remote_local</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">dryrun</span> <span class="o">=</span> <span class="n">dryrun</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dependencies</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="n">partial</span><span class="p">(</span><span class="n">defaultdict</span><span class="p">,</span> <span class="nb">set</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">depending</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="n">partial</span><span class="p">(</span><span class="n">defaultdict</span><span class="p">,</span> <span class="nb">set</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_needrun</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_priority</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_reason</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="n">Reason</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_finished</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_dynamic</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_len</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">workflow</span> <span class="o">=</span> <span class="n">workflow</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rules</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">rules</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ignore_ambiguity</span> <span class="o">=</span> <span class="n">ignore_ambiguity</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">targetfiles</span> <span class="o">=</span> <span class="n">targetfiles</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">targetrules</span> <span class="o">=</span> <span class="n">targetrules</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">priorityfiles</span> <span class="o">=</span> <span class="n">priorityfiles</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">priorityrules</span> <span class="o">=</span> <span class="n">priorityrules</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">targetjobs</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">prioritytargetjobs</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_ready_jobs</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">notemp</span> <span class="o">=</span> <span class="n">notemp</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">keep_remote_local</span> <span class="o">=</span> <span class="n">keep_remote_local</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_jobid</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">job_cache</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">conda_envs</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">singularity_imgs</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_progress</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_group</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">forcerules</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">forcefiles</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">untilrules</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">untilfiles</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">omitrules</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">omitfiles</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">updated_subworkflow_files</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">forceall</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">forcerules</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rules</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">forcerules</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">forcerules</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">forcerules</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">forcefiles</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">forcefiles</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">forcefiles</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">untilrules</span><span class="p">:</span>  <span class="c1"># keep only the rule names</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">untilrules</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">rule</span><span class="o">.</span><span class="n">name</span> <span class="k">for</span> <span class="n">rule</span> <span class="ow">in</span> <span class="n">untilrules</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">untilfiles</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">untilfiles</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">untilfiles</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">omitrules</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">omitrules</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">rule</span><span class="o">.</span><span class="n">name</span> <span class="k">for</span> <span class="n">rule</span> <span class="ow">in</span> <span class="n">omitrules</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">omitfiles</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">omitfiles</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">omitfiles</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">omitforce</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">force_incomplete</span> <span class="o">=</span> <span class="n">force_incomplete</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ignore_incomplete</span> <span class="o">=</span> <span class="n">ignore_incomplete</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">periodic_wildcard_detector</span> <span class="o">=</span> <span class="n">PeriodicityDetector</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">update_output_index</span><span class="p">()</span>

<div class="viewcode-block" id="DAG.init"><a class="viewcode-back" href="../../api_reference/internal/snakemake.html#snakemake.dag.DAG.init">[docs]</a>    <span class="k">def</span> <span class="nf">init</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">progress</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Initialise the DAG. &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">job</span> <span class="ow">in</span> <span class="nb">map</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rule2job</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">targetrules</span><span class="p">):</span>
            <span class="n">job</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">update</span><span class="p">([</span><span class="n">job</span><span class="p">],</span> <span class="n">progress</span><span class="o">=</span><span class="n">progress</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">targetjobs</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">job</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">file</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">targetfiles</span><span class="p">:</span>
            <span class="n">job</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">file2jobs</span><span class="p">(</span><span class="n">file</span><span class="p">),</span> <span class="n">file</span><span class="o">=</span><span class="n">file</span><span class="p">,</span> <span class="n">progress</span><span class="o">=</span><span class="n">progress</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">targetjobs</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">job</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">cleanup</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">update_needrun</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_until_jobs</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">delete_omitfrom_jobs</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">update_jobids</span><span class="p">()</span>

        <span class="c1"># Check if there are files/dirs that are children of other outputs.</span>
        <span class="n">allfiles</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="k">for</span> <span class="n">job</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">jobs</span><span class="p">:</span>
            <span class="c1"># This is to account also for targets of symlinks</span>
            <span class="n">allfiles</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="n">f</span><span class="p">(</span><span class="n">x</span><span class="p">):</span><span class="s2">&quot;input&quot;</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">job</span><span class="o">.</span><span class="n">input</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">realpath</span><span class="p">)})</span>
            <span class="n">allfiles</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="n">f</span><span class="p">(</span><span class="n">x</span><span class="p">):</span><span class="s2">&quot;output&quot;</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">job</span><span class="o">.</span><span class="n">output</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">realpath</span><span class="p">)})</span>

        <span class="n">sortedfiles</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">allfiles</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">sortedfiles</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">allfiles</span><span class="p">[</span><span class="n">sortedfiles</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span> <span class="o">==</span> <span class="s2">&quot;output&quot;</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">common_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">commonpath</span><span class="p">([</span><span class="n">sortedfiles</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">sortedfiles</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">]])</span>
                <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>  <span class="c1"># commonpath raises error if windows drives are different.</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;Ambiguous filepath due to different drives between </span><span class="si">{}</span><span class="s1"> and </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">sortedfiles</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">sortedfiles</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">]))</span>
                    <span class="k">continue</span>
                <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">commonpath</span><span class="p">([</span><span class="n">sortedfiles</span><span class="p">[</span><span class="n">i</span><span class="p">]])</span> <span class="o">==</span> <span class="n">common_path</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="n">ChildIOException</span><span class="p">(</span><span class="n">parent</span> <span class="o">=</span> <span class="n">sortedfiles</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">child</span> <span class="o">=</span> <span class="n">sortedfiles</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">])</span>

        <span class="c1"># check if remaining jobs are valid</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">job</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">jobs</span><span class="p">):</span>
            <span class="n">job</span><span class="o">.</span><span class="n">is_valid</span><span class="p">()</span></div>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">checkpoint_jobs</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">job</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">needrun_jobs</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">job</span><span class="o">.</span><span class="n">is_checkpoint</span><span class="p">:</span>
                <span class="k">yield</span> <span class="n">job</span>

<div class="viewcode-block" id="DAG.update_checkpoint_outputs"><a class="viewcode-back" href="../../api_reference/internal/snakemake.html#snakemake.dag.DAG.update_checkpoint_outputs">[docs]</a>    <span class="k">def</span> <span class="nf">update_checkpoint_outputs</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">workflow</span><span class="o">.</span><span class="n">checkpoints</span><span class="o">.</span><span class="n">future_output</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">f</span> <span class="k">for</span> <span class="n">job</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">checkpoint_jobs</span>
                                                   <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">job</span><span class="o">.</span><span class="n">output</span><span class="p">)</span></div>

<div class="viewcode-block" id="DAG.update_jobids"><a class="viewcode-back" href="../../api_reference/internal/snakemake.html#snakemake.dag.DAG.update_jobids">[docs]</a>    <span class="k">def</span> <span class="nf">update_jobids</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">job</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">jobs</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">job</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_jobid</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_jobid</span><span class="p">[</span><span class="n">job</span><span class="p">]</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_jobid</span><span class="p">)</span></div>

<div class="viewcode-block" id="DAG.cleanup"><a class="viewcode-back" href="../../api_reference/internal/snakemake.html#snakemake.dag.DAG.cleanup">[docs]</a>    <span class="k">def</span> <span class="nf">cleanup</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">job_cache</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
        <span class="n">final_jobs</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">jobs</span><span class="p">)</span>
        <span class="n">todelete</span> <span class="o">=</span> <span class="p">[</span><span class="n">job</span> <span class="k">for</span> <span class="n">job</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">dependencies</span> <span class="k">if</span> <span class="n">job</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">final_jobs</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">job</span> <span class="ow">in</span> <span class="n">todelete</span><span class="p">:</span>
            <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">dependencies</span><span class="p">[</span><span class="n">job</span><span class="p">]</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">depending</span><span class="p">[</span><span class="n">job</span><span class="p">]</span>
            <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                <span class="k">pass</span></div>

<div class="viewcode-block" id="DAG.create_conda_envs"><a class="viewcode-back" href="../../api_reference/internal/snakemake.html#snakemake.dag.DAG.create_conda_envs">[docs]</a>    <span class="k">def</span> <span class="nf">create_conda_envs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                          <span class="n">dryrun</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                          <span class="n">forceall</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                          <span class="n">init_only</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                          <span class="n">quiet</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="c1"># First deduplicate based on job.conda_env_file</span>
        <span class="n">jobs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">jobs</span> <span class="k">if</span> <span class="n">forceall</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">needrun_jobs</span>
        <span class="n">env_set</span> <span class="o">=</span> <span class="p">{(</span><span class="n">job</span><span class="o">.</span><span class="n">conda_env_file</span><span class="p">,</span> <span class="n">job</span><span class="o">.</span><span class="n">singularity_img_url</span><span class="p">)</span>
                   <span class="k">for</span> <span class="n">job</span> <span class="ow">in</span> <span class="n">jobs</span> <span class="k">if</span> <span class="n">job</span><span class="o">.</span><span class="n">conda_env_file</span><span class="p">}</span>
        <span class="c1"># Then based on md5sum values</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">conda_envs</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
        <span class="k">for</span> <span class="p">(</span><span class="n">env_file</span><span class="p">,</span> <span class="n">simg_url</span><span class="p">)</span> <span class="ow">in</span> <span class="n">env_set</span><span class="p">:</span>
            <span class="n">simg</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">if</span> <span class="n">simg_url</span><span class="p">:</span>
                <span class="k">assert</span> <span class="n">simg_url</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">singularity_imgs</span><span class="p">,</span> <span class="s2">&quot;bug: must first pull singularity images&quot;</span>
                <span class="n">simg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">singularity_imgs</span><span class="p">[</span><span class="n">simg_url</span><span class="p">]</span>
            <span class="n">env</span> <span class="o">=</span> <span class="n">conda</span><span class="o">.</span><span class="n">Env</span><span class="p">(</span><span class="n">env_file</span><span class="p">,</span> <span class="bp">self</span><span class="p">,</span> <span class="n">singularity_img</span><span class="o">=</span><span class="n">simg</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">conda_envs</span><span class="p">[(</span><span class="n">env_file</span><span class="p">,</span> <span class="n">simg_url</span><span class="p">)]</span> <span class="o">=</span> <span class="n">env</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">init_only</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">env</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">conda_envs</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">dryrun</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">quiet</span><span class="p">:</span>
                    <span class="n">env</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">dryrun</span><span class="p">)</span></div>

<div class="viewcode-block" id="DAG.pull_singularity_imgs"><a class="viewcode-back" href="../../api_reference/internal/snakemake.html#snakemake.dag.DAG.pull_singularity_imgs">[docs]</a>    <span class="k">def</span> <span class="nf">pull_singularity_imgs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dryrun</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">forceall</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">quiet</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="c1"># First deduplicate based on job.conda_env_file</span>
        <span class="n">jobs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">jobs</span> <span class="k">if</span> <span class="n">forceall</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">needrun_jobs</span>
        <span class="n">img_set</span> <span class="o">=</span> <span class="p">{</span><span class="n">job</span><span class="o">.</span><span class="n">singularity_img_url</span> <span class="k">for</span> <span class="n">job</span> <span class="ow">in</span> <span class="n">jobs</span>
                   <span class="k">if</span> <span class="n">job</span><span class="o">.</span><span class="n">singularity_img_url</span><span class="p">}</span>

        <span class="k">for</span> <span class="n">img_url</span> <span class="ow">in</span> <span class="n">img_set</span><span class="p">:</span>
            <span class="n">img</span> <span class="o">=</span> <span class="n">singularity</span><span class="o">.</span><span class="n">Image</span><span class="p">(</span><span class="n">img_url</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">dryrun</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">quiet</span><span class="p">:</span>
                <span class="n">img</span><span class="o">.</span><span class="n">pull</span><span class="p">(</span><span class="n">dryrun</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">singularity_imgs</span><span class="p">[</span><span class="n">img_url</span><span class="p">]</span> <span class="o">=</span> <span class="n">img</span></div>


<div class="viewcode-block" id="DAG.update_output_index"><a class="viewcode-back" href="../../api_reference/internal/snakemake.html#snakemake.dag.DAG.update_output_index">[docs]</a>    <span class="k">def</span> <span class="nf">update_output_index</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Update the OutputIndex.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">output_index</span> <span class="o">=</span> <span class="n">OutputIndex</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rules</span><span class="p">)</span></div>

<div class="viewcode-block" id="DAG.check_incomplete"><a class="viewcode-back" href="../../api_reference/internal/snakemake.html#snakemake.dag.DAG.check_incomplete">[docs]</a>    <span class="k">def</span> <span class="nf">check_incomplete</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Check if any output files are incomplete. This is done by looking up</span>
<span class="sd">        markers in the persistence module.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">ignore_incomplete</span><span class="p">:</span>
            <span class="n">incomplete</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">incomplete_files</span>
            <span class="k">if</span> <span class="n">incomplete</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">force_incomplete</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Forcing incomplete files:&quot;</span><span class="p">)</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\t</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n\t</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">incomplete</span><span class="p">))</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">forcefiles</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">incomplete</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="n">IncompleteFilesException</span><span class="p">(</span><span class="n">incomplete</span><span class="p">)</span></div>

<div class="viewcode-block" id="DAG.incomplete_external_jobid"><a class="viewcode-back" href="../../api_reference/internal/snakemake.html#snakemake.dag.DAG.incomplete_external_jobid">[docs]</a>    <span class="k">def</span> <span class="nf">incomplete_external_jobid</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">job</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return the external jobid of the job if it is marked as incomplete.</span>

<span class="sd">        Returns None, if job is not incomplete, or if no external jobid has been</span>
<span class="sd">        registered or if force_incomplete is True.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">force_incomplete</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="n">jobids</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">workflow</span><span class="o">.</span><span class="n">persistence</span><span class="o">.</span><span class="n">external_jobids</span><span class="p">(</span><span class="n">job</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">jobids</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">jobids</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">jobids</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">WorkflowError</span><span class="p">(</span>
                <span class="s2">&quot;Multiple different external jobids registered &quot;</span>
                <span class="s2">&quot;for output files of incomplete job </span><span class="si">{}</span><span class="s2"> (</span><span class="si">{}</span><span class="s2">). This job &quot;</span>
                <span class="s2">&quot;cannot be resumed. Execute Snakemake with --rerun-incomplete &quot;</span>
                <span class="s2">&quot;to fix this issue.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">job</span><span class="o">.</span><span class="n">jobid</span><span class="p">,</span> <span class="n">jobids</span><span class="p">))</span></div>

<div class="viewcode-block" id="DAG.check_dynamic"><a class="viewcode-back" href="../../api_reference/internal/snakemake.html#snakemake.dag.DAG.check_dynamic">[docs]</a>    <span class="k">def</span> <span class="nf">check_dynamic</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Check dynamic output and update downstream rules if necessary.&quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">job</span> <span class="ow">in</span> <span class="nb">filter</span><span class="p">(</span>
                <span class="k">lambda</span> <span class="n">job</span><span class="p">:</span> <span class="p">(</span><span class="n">job</span><span class="o">.</span><span class="n">dynamic_output</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">needrun</span><span class="p">(</span><span class="n">job</span><span class="p">)),</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">jobs</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">update_dynamic</span><span class="p">(</span><span class="n">job</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">postprocess</span><span class="p">()</span></div>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">dynamic_output_jobs</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Iterate over all jobs with dynamic output files.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">job</span> <span class="k">for</span> <span class="n">job</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">jobs</span> <span class="k">if</span> <span class="n">job</span><span class="o">.</span><span class="n">dynamic_output</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">jobs</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; All jobs in the DAG. &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">job</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">bfs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dependencies</span><span class="p">,</span> <span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">targetjobs</span><span class="p">):</span>
            <span class="k">yield</span> <span class="n">job</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">needrun_jobs</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Jobs that need to be executed. &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">job</span> <span class="ow">in</span> <span class="nb">filter</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">needrun</span><span class="p">,</span>
                          <span class="bp">self</span><span class="o">.</span><span class="n">bfs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dependencies</span><span class="p">,</span>
                                   <span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">targetjobs</span><span class="p">,</span>
                                   <span class="n">stop</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">noneedrun_finished</span><span class="p">)):</span>
            <span class="k">yield</span> <span class="n">job</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">local_needrun_jobs</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Iterate over all jobs that need to be run and are marked as local.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">filter</span><span class="p">(</span><span class="k">lambda</span> <span class="n">job</span><span class="p">:</span> <span class="n">job</span><span class="o">.</span><span class="n">is_local</span><span class="p">,</span>
                      <span class="bp">self</span><span class="o">.</span><span class="n">needrun_jobs</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">finished_jobs</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Iterate over all jobs that have been finished.&quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">job</span> <span class="ow">in</span> <span class="nb">filter</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">finished</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">bfs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dependencies</span><span class="p">,</span>
                                                  <span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">targetjobs</span><span class="p">)):</span>
            <span class="k">yield</span> <span class="n">job</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">ready_jobs</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Jobs that are ready to execute.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ready_jobs</span>

<div class="viewcode-block" id="DAG.needrun"><a class="viewcode-back" href="../../api_reference/internal/snakemake.html#snakemake.dag.DAG.needrun">[docs]</a>    <span class="k">def</span> <span class="nf">needrun</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">job</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return whether a given job needs to be executed.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">job</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_needrun</span></div>

<div class="viewcode-block" id="DAG.priority"><a class="viewcode-back" href="../../api_reference/internal/snakemake.html#snakemake.dag.DAG.priority">[docs]</a>    <span class="k">def</span> <span class="nf">priority</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">job</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return priority of given job.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_priority</span><span class="p">[</span><span class="n">job</span><span class="p">]</span></div>

<div class="viewcode-block" id="DAG.noneedrun_finished"><a class="viewcode-back" href="../../api_reference/internal/snakemake.html#snakemake.dag.DAG.noneedrun_finished">[docs]</a>    <span class="k">def</span> <span class="nf">noneedrun_finished</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">job</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return whether a given job is finished or was not</span>
<span class="sd">        required to run at all.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">needrun</span><span class="p">(</span><span class="n">job</span><span class="p">)</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">finished</span><span class="p">(</span><span class="n">job</span><span class="p">)</span></div>

<div class="viewcode-block" id="DAG.reason"><a class="viewcode-back" href="../../api_reference/internal/snakemake.html#snakemake.dag.DAG.reason">[docs]</a>    <span class="k">def</span> <span class="nf">reason</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">job</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Return the reason of the job execution. &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_reason</span><span class="p">[</span><span class="n">job</span><span class="p">]</span></div>

<div class="viewcode-block" id="DAG.finished"><a class="viewcode-back" href="../../api_reference/internal/snakemake.html#snakemake.dag.DAG.finished">[docs]</a>    <span class="k">def</span> <span class="nf">finished</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">job</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Return whether a job is finished. &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">job</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_finished</span></div>

<div class="viewcode-block" id="DAG.dynamic"><a class="viewcode-back" href="../../api_reference/internal/snakemake.html#snakemake.dag.DAG.dynamic">[docs]</a>    <span class="k">def</span> <span class="nf">dynamic</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">job</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return whether a job is dynamic (i.e. it is only a placeholder</span>
<span class="sd">        for those that are created after the job with dynamic output has</span>
<span class="sd">        finished.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">job</span><span class="o">.</span><span class="n">is_group</span><span class="p">():</span>
            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">job</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">j</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dynamic</span><span class="p">:</span>
                    <span class="k">return</span> <span class="kc">True</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">job</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dynamic</span></div>

<div class="viewcode-block" id="DAG.requested_files"><a class="viewcode-back" href="../../api_reference/internal/snakemake.html#snakemake.dag.DAG.requested_files">[docs]</a>    <span class="k">def</span> <span class="nf">requested_files</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">job</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return the files a job requests.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">set</span><span class="p">(</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">depending</span><span class="p">[</span><span class="n">job</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">())</span></div>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">incomplete_files</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return list of incomplete files.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">list</span><span class="p">(</span><span class="n">chain</span><span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="n">job</span><span class="o">.</span><span class="n">output</span>
                            <span class="k">for</span> <span class="n">job</span> <span class="ow">in</span>
                            <span class="nb">filter</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">workflow</span><span class="o">.</span><span class="n">persistence</span><span class="o">.</span><span class="n">incomplete</span><span class="p">,</span>
                                   <span class="n">filterfalse</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">needrun</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">jobs</span><span class="p">)))))</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">newversion_files</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return list of files where the current version is newer than the</span>
<span class="sd">        recorded version.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">list</span><span class="p">(</span><span class="n">chain</span><span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="n">job</span><span class="o">.</span><span class="n">output</span>
                            <span class="k">for</span> <span class="n">job</span> <span class="ow">in</span>
                            <span class="nb">filter</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">workflow</span><span class="o">.</span><span class="n">persistence</span><span class="o">.</span><span class="n">newversion</span><span class="p">,</span>
                                   <span class="bp">self</span><span class="o">.</span><span class="n">jobs</span><span class="p">))))</span>

<div class="viewcode-block" id="DAG.missing_temp"><a class="viewcode-back" href="../../api_reference/internal/snakemake.html#snakemake.dag.DAG.missing_temp">[docs]</a>    <span class="k">def</span> <span class="nf">missing_temp</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">job</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return whether a temp file that is input of the given job is missing.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">job_</span><span class="p">,</span> <span class="n">files</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">depending</span><span class="p">[</span><span class="n">job</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">needrun</span><span class="p">(</span><span class="n">job_</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">any</span><span class="p">(</span><span class="ow">not</span> <span class="n">f</span><span class="o">.</span><span class="n">exists</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">files</span><span class="p">):</span>
                <span class="k">return</span> <span class="kc">True</span>
        <span class="k">return</span> <span class="kc">False</span></div>

<div class="viewcode-block" id="DAG.check_and_touch_output"><a class="viewcode-back" href="../../api_reference/internal/snakemake.html#snakemake.dag.DAG.check_and_touch_output">[docs]</a>    <span class="k">def</span> <span class="nf">check_and_touch_output</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                               <span class="n">job</span><span class="p">,</span>
                               <span class="n">wait</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span>
                               <span class="n">ignore_missing_output</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                               <span class="n">no_touch</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                               <span class="n">force_stay_on_remote</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Raise exception if output files of job are missing. &quot;&quot;&quot;</span>
        <span class="n">expanded_output</span> <span class="o">=</span> <span class="p">[</span><span class="n">job</span><span class="o">.</span><span class="n">shadowed_path</span><span class="p">(</span><span class="n">path</span><span class="p">)</span> <span class="k">for</span> <span class="n">path</span> <span class="ow">in</span> <span class="n">job</span><span class="o">.</span><span class="n">expanded_output</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">job</span><span class="o">.</span><span class="n">benchmark</span><span class="p">:</span>
            <span class="n">expanded_output</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">job</span><span class="o">.</span><span class="n">benchmark</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">ignore_missing_output</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">wait_for_files</span><span class="p">(</span><span class="n">expanded_output</span><span class="p">,</span>
                               <span class="n">latency_wait</span><span class="o">=</span><span class="n">wait</span><span class="p">,</span>
                               <span class="n">force_stay_on_remote</span><span class="o">=</span><span class="n">force_stay_on_remote</span><span class="p">,</span>
                               <span class="n">ignore_pipe</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">IOError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">MissingOutputException</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">This might be due to &quot;</span>
                <span class="s2">&quot;filesystem latency. If that is the case, consider to increase the &quot;</span>
                <span class="s2">&quot;wait time with --latency-wait.&quot;</span><span class="p">,</span> <span class="n">rule</span><span class="o">=</span><span class="n">job</span><span class="o">.</span><span class="n">rule</span><span class="p">)</span>

        <span class="c1"># Ensure that outputs are of the correct type (those flagged with directory()</span>
        <span class="c1"># are directories and not files and vice versa).</span>
        <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">expanded_output</span><span class="p">:</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">is_directory</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">f</span><span class="p">))</span> <span class="ow">or</span> <span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">f</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">f</span><span class="o">.</span><span class="n">is_directory</span><span class="p">):</span>
                <span class="k">raise</span> <span class="n">ImproperOutputException</span><span class="p">(</span><span class="n">job</span><span class="o">.</span><span class="n">rule</span><span class="p">,</span> <span class="p">[</span><span class="n">f</span><span class="p">])</span>

        <span class="c1">#It is possible, due to archive expansion or cluster clock skew, that</span>
        <span class="c1">#the files appear older than the input.  But we know they must be new,</span>
        <span class="c1">#so touch them to update timestamps. This also serves to touch outputs</span>
        <span class="c1">#when using the --touch flag.</span>
        <span class="c1">#Note that if the input files somehow have a future date then this will</span>
        <span class="c1">#not currently be spotted and the job will always be re-run.</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">no_touch</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">expanded_output</span><span class="p">:</span>
                <span class="c1"># This won&#39;t create normal files if missing, but will create</span>
                <span class="c1"># the flag file for directories.</span>
                <span class="k">if</span> <span class="n">f</span><span class="o">.</span><span class="n">exists_local</span><span class="p">:</span>
                    <span class="n">f</span><span class="o">.</span><span class="n">touch</span><span class="p">()</span></div>

<div class="viewcode-block" id="DAG.unshadow_output"><a class="viewcode-back" href="../../api_reference/internal/snakemake.html#snakemake.dag.DAG.unshadow_output">[docs]</a>    <span class="k">def</span> <span class="nf">unshadow_output</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">job</span><span class="p">,</span> <span class="n">only_log</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Move files from shadow directory to real output paths. &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">job</span><span class="o">.</span><span class="n">shadow_dir</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">job</span><span class="o">.</span><span class="n">expanded_output</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="n">files</span> <span class="o">=</span> <span class="n">job</span><span class="o">.</span><span class="n">log</span> <span class="k">if</span> <span class="n">only_log</span> <span class="k">else</span> <span class="n">chain</span><span class="p">(</span><span class="n">job</span><span class="o">.</span><span class="n">expanded_output</span><span class="p">,</span> <span class="n">job</span><span class="o">.</span><span class="n">log</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">real_output</span> <span class="ow">in</span> <span class="n">files</span><span class="p">:</span>
            <span class="n">shadow_output</span> <span class="o">=</span> <span class="n">job</span><span class="o">.</span><span class="n">shadowed_path</span><span class="p">(</span><span class="n">real_output</span><span class="p">)</span><span class="o">.</span><span class="n">file</span>
            <span class="c1"># Remake absolute symlinks as relative</span>
            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">islink</span><span class="p">(</span><span class="n">shadow_output</span><span class="p">):</span>
                <span class="n">dest</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">readlink</span><span class="p">(</span><span class="n">shadow_output</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isabs</span><span class="p">(</span><span class="n">dest</span><span class="p">):</span>
                    <span class="n">rel_dest</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">relpath</span><span class="p">(</span><span class="n">dest</span><span class="p">,</span> <span class="n">job</span><span class="o">.</span><span class="n">shadow_dir</span><span class="p">)</span>
                    <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">shadow_output</span><span class="p">)</span>
                    <span class="n">os</span><span class="o">.</span><span class="n">symlink</span><span class="p">(</span><span class="n">rel_dest</span><span class="p">,</span> <span class="n">shadow_output</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">realpath</span><span class="p">(</span><span class="n">shadow_output</span><span class="p">)</span> <span class="o">==</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">realpath</span><span class="p">(</span>
                    <span class="n">real_output</span><span class="p">):</span>
                <span class="k">continue</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Moving shadow output </span><span class="si">{}</span><span class="s2"> to destination </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="n">shadow_output</span><span class="p">,</span> <span class="n">real_output</span><span class="p">))</span>
            <span class="n">shutil</span><span class="o">.</span><span class="n">move</span><span class="p">(</span><span class="n">shadow_output</span><span class="p">,</span> <span class="n">real_output</span><span class="p">)</span>
        <span class="n">shutil</span><span class="o">.</span><span class="n">rmtree</span><span class="p">(</span><span class="n">job</span><span class="o">.</span><span class="n">shadow_dir</span><span class="p">)</span></div>

<div class="viewcode-block" id="DAG.check_periodic_wildcards"><a class="viewcode-back" href="../../api_reference/internal/snakemake.html#snakemake.dag.DAG.check_periodic_wildcards">[docs]</a>    <span class="k">def</span> <span class="nf">check_periodic_wildcards</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">job</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Raise an exception if a wildcard of the given job appears to be periodic,</span>
<span class="sd">        indicating a cyclic dependency. &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">wildcard</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">job</span><span class="o">.</span><span class="n">wildcards_dict</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">periodic_substring</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">periodic_wildcard_detector</span><span class="o">.</span><span class="n">is_periodic</span><span class="p">(</span>
                <span class="n">value</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">periodic_substring</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">PeriodicWildcardError</span><span class="p">(</span>
                    <span class="s2">&quot;The value </span><span class="si">{}</span><span class="s2"> in wildcard </span><span class="si">{}</span><span class="s2"> is periodically repeated (</span><span class="si">{}</span><span class="s2">). &quot;</span>
                    <span class="s2">&quot;This would lead to an infinite recursion. &quot;</span>
                    <span class="s2">&quot;To avoid this, e.g. restrict the wildcards in this rule to certain values.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                        <span class="n">periodic_substring</span><span class="p">,</span> <span class="n">wildcard</span><span class="p">,</span> <span class="n">value</span><span class="p">),</span>
                    <span class="n">rule</span><span class="o">=</span><span class="n">job</span><span class="o">.</span><span class="n">rule</span><span class="p">)</span></div>

<div class="viewcode-block" id="DAG.handle_protected"><a class="viewcode-back" href="../../api_reference/internal/snakemake.html#snakemake.dag.DAG.handle_protected">[docs]</a>    <span class="k">def</span> <span class="nf">handle_protected</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">job</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Write-protect output files that are marked with protected(). &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">job</span><span class="o">.</span><span class="n">expanded_output</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">job</span><span class="o">.</span><span class="n">protected_output</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Write-protecting output file </span><span class="si">{}</span><span class="s2">.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">f</span><span class="p">))</span>
                <span class="n">f</span><span class="o">.</span><span class="n">protect</span><span class="p">()</span></div>

<div class="viewcode-block" id="DAG.handle_touch"><a class="viewcode-back" href="../../api_reference/internal/snakemake.html#snakemake.dag.DAG.handle_touch">[docs]</a>    <span class="k">def</span> <span class="nf">handle_touch</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">job</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Touches those output files that are marked for touching. &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">job</span><span class="o">.</span><span class="n">expanded_output</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">job</span><span class="o">.</span><span class="n">touch_output</span><span class="p">:</span>
                <span class="n">f</span> <span class="o">=</span> <span class="n">job</span><span class="o">.</span><span class="n">shadowed_path</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Touching output file </span><span class="si">{}</span><span class="s2">.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">f</span><span class="p">))</span>
                <span class="n">f</span><span class="o">.</span><span class="n">touch_or_create</span><span class="p">()</span>
                <span class="k">assert</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">f</span><span class="p">)</span></div>

<div class="viewcode-block" id="DAG.temp_input"><a class="viewcode-back" href="../../api_reference/internal/snakemake.html#snakemake.dag.DAG.temp_input">[docs]</a>    <span class="k">def</span> <span class="nf">temp_input</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">job</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">job_</span><span class="p">,</span> <span class="n">files</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">dependencies</span><span class="p">[</span><span class="n">job</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="nb">filter</span><span class="p">(</span><span class="n">job_</span><span class="o">.</span><span class="n">temp_output</span><span class="o">.</span><span class="fm">__contains__</span><span class="p">,</span> <span class="n">files</span><span class="p">):</span>
                <span class="k">yield</span> <span class="n">f</span></div>

<div class="viewcode-block" id="DAG.temp_size"><a class="viewcode-back" href="../../api_reference/internal/snakemake.html#snakemake.dag.DAG.temp_size">[docs]</a>    <span class="k">def</span> <span class="nf">temp_size</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">job</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return the total size of temporary input files of the job.</span>
<span class="sd">        If none, return 0.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">sum</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">size</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">temp_input</span><span class="p">(</span><span class="n">job</span><span class="p">))</span></div>

<div class="viewcode-block" id="DAG.handle_temp"><a class="viewcode-back" href="../../api_reference/internal/snakemake.html#snakemake.dag.DAG.handle_temp">[docs]</a>    <span class="k">def</span> <span class="nf">handle_temp</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">job</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Remove temp files if they are no longer needed. Update temp_mtimes. &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">notemp</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="n">is_temp</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">f</span><span class="p">:</span> <span class="n">is_flagged</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="s2">&quot;temp&quot;</span><span class="p">)</span>

        <span class="c1"># handle temp input</span>
        <span class="n">needed</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">job_</span><span class="p">,</span> <span class="n">f</span><span class="p">:</span> <span class="nb">any</span><span class="p">(</span>
            <span class="n">f</span> <span class="ow">in</span> <span class="n">files</span> <span class="k">for</span> <span class="n">j</span><span class="p">,</span> <span class="n">files</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">depending</span><span class="p">[</span><span class="n">job_</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">finished</span><span class="p">(</span><span class="n">j</span><span class="p">)</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">needrun</span><span class="p">(</span><span class="n">j</span><span class="p">)</span> <span class="ow">and</span> <span class="n">j</span> <span class="o">!=</span> <span class="n">job</span><span class="p">)</span>

        <span class="k">def</span> <span class="nf">unneeded_files</span><span class="p">():</span>
            <span class="c1"># temp input</span>
            <span class="k">for</span> <span class="n">job_</span><span class="p">,</span> <span class="n">files</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">dependencies</span><span class="p">[</span><span class="n">job</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="n">tempfiles</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">f</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">job_</span><span class="o">.</span><span class="n">expanded_output</span> <span class="k">if</span> <span class="n">is_temp</span><span class="p">(</span><span class="n">f</span><span class="p">))</span>
                <span class="k">yield from</span> <span class="n">filterfalse</span><span class="p">(</span><span class="n">partial</span><span class="p">(</span><span class="n">needed</span><span class="p">,</span> <span class="n">job_</span><span class="p">),</span> <span class="n">tempfiles</span> <span class="o">&amp;</span> <span class="n">files</span><span class="p">)</span>

            <span class="c1"># temp output</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">job</span><span class="o">.</span><span class="n">dynamic_output</span><span class="p">:</span>
                <span class="n">tempfiles</span> <span class="o">=</span> <span class="p">(</span><span class="n">f</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">job</span><span class="o">.</span><span class="n">expanded_output</span>
                               <span class="k">if</span> <span class="n">is_temp</span><span class="p">(</span><span class="n">f</span><span class="p">)</span> <span class="ow">and</span> <span class="n">f</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">targetfiles</span><span class="p">)</span>
                <span class="k">yield from</span> <span class="n">filterfalse</span><span class="p">(</span><span class="n">partial</span><span class="p">(</span><span class="n">needed</span><span class="p">,</span> <span class="n">job</span><span class="p">),</span> <span class="n">tempfiles</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">unneeded_files</span><span class="p">():</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Removing temporary output file </span><span class="si">{}</span><span class="s2">.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">f</span><span class="p">))</span>
            <span class="n">f</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">remove_non_empty_dir</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span></div>

<div class="viewcode-block" id="DAG.handle_log"><a class="viewcode-back" href="../../api_reference/internal/snakemake.html#snakemake.dag.DAG.handle_log">[docs]</a>    <span class="k">def</span> <span class="nf">handle_log</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">job</span><span class="p">,</span> <span class="n">upload_remote</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">job</span><span class="o">.</span><span class="n">log</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">f</span><span class="o">.</span><span class="n">exists_local</span><span class="p">:</span>
                <span class="c1"># If log file was not created during job, create an empty one.</span>
                <span class="n">f</span><span class="o">.</span><span class="n">touch_or_create</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">upload_remote</span> <span class="ow">and</span> <span class="n">f</span><span class="o">.</span><span class="n">is_remote</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">f</span><span class="o">.</span><span class="n">should_stay_on_remote</span><span class="p">:</span>
                <span class="n">f</span><span class="o">.</span><span class="n">upload_to_remote</span><span class="p">()</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">f</span><span class="o">.</span><span class="n">exists_remote</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="n">RemoteFileException</span><span class="p">(</span>
                        <span class="s2">&quot;The file upload was attempted, but it does not &quot;</span>
                        <span class="s2">&quot;exist on remote. Check that your credentials have &quot;</span>
                        <span class="s2">&quot;read AND write permissions.&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="DAG.handle_remote"><a class="viewcode-back" href="../../api_reference/internal/snakemake.html#snakemake.dag.DAG.handle_remote">[docs]</a>    <span class="k">def</span> <span class="nf">handle_remote</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">job</span><span class="p">,</span> <span class="n">upload</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Remove local files if they are no longer needed and upload. &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">upload</span><span class="p">:</span>
            <span class="c1"># handle output files</span>
            <span class="n">files</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">job</span><span class="o">.</span><span class="n">expanded_output</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">job</span><span class="o">.</span><span class="n">benchmark</span><span class="p">:</span>
                <span class="n">files</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">job</span><span class="o">.</span><span class="n">benchmark</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">files</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">f</span><span class="o">.</span><span class="n">is_remote</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">f</span><span class="o">.</span><span class="n">should_stay_on_remote</span><span class="p">:</span>
                    <span class="n">f</span><span class="o">.</span><span class="n">upload_to_remote</span><span class="p">()</span>
                    <span class="n">remote_mtime</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">mtime</span>
                    <span class="c1"># immediately force local mtime to match remote,</span>
                    <span class="c1"># since conversions from S3 headers are not 100% reliable</span>
                    <span class="c1"># without this, newness comparisons may fail down the line</span>
                    <span class="n">f</span><span class="o">.</span><span class="n">touch</span><span class="p">(</span><span class="n">times</span><span class="o">=</span><span class="p">(</span><span class="n">remote_mtime</span><span class="p">,</span> <span class="n">remote_mtime</span><span class="p">))</span>

                    <span class="k">if</span> <span class="ow">not</span> <span class="n">f</span><span class="o">.</span><span class="n">exists_remote</span><span class="p">:</span>
                        <span class="k">raise</span> <span class="n">RemoteFileException</span><span class="p">(</span>
                            <span class="s2">&quot;The file upload was attempted, but it does not &quot;</span>
                            <span class="s2">&quot;exist on remote. Check that your credentials have &quot;</span>
                            <span class="s2">&quot;read AND write permissions.&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">keep_remote_local</span><span class="p">:</span>
            <span class="c1"># handle input files</span>
            <span class="n">needed</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">job_</span><span class="p">,</span> <span class="n">f</span><span class="p">:</span> <span class="nb">any</span><span class="p">(</span>
                <span class="n">f</span> <span class="ow">in</span> <span class="n">files</span> <span class="k">for</span> <span class="n">j</span><span class="p">,</span> <span class="n">files</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">depending</span><span class="p">[</span><span class="n">job_</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">finished</span><span class="p">(</span><span class="n">j</span><span class="p">)</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">needrun</span><span class="p">(</span><span class="n">j</span><span class="p">)</span> <span class="ow">and</span> <span class="n">j</span> <span class="o">!=</span> <span class="n">job</span><span class="p">)</span>

            <span class="k">def</span> <span class="nf">unneeded_files</span><span class="p">():</span>
                <span class="n">putative</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">f</span><span class="p">:</span> <span class="n">f</span><span class="o">.</span><span class="n">is_remote</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">f</span><span class="o">.</span><span class="n">protected</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">f</span><span class="o">.</span><span class="n">should_keep_local</span>
                <span class="n">generated_input</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
                <span class="k">for</span> <span class="n">job_</span><span class="p">,</span> <span class="n">files</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">dependencies</span><span class="p">[</span><span class="n">job</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                    <span class="n">generated_input</span> <span class="o">|=</span> <span class="n">files</span>
                    <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="nb">filter</span><span class="p">(</span><span class="n">putative</span><span class="p">,</span> <span class="n">files</span><span class="p">):</span>
                        <span class="k">if</span> <span class="ow">not</span> <span class="n">needed</span><span class="p">(</span><span class="n">job_</span><span class="p">,</span> <span class="n">f</span><span class="p">):</span>
                            <span class="k">yield</span> <span class="n">f</span>
                <span class="k">for</span> <span class="n">f</span><span class="p">,</span> <span class="n">f_</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">job</span><span class="o">.</span><span class="n">output</span><span class="p">,</span> <span class="n">job</span><span class="o">.</span><span class="n">rule</span><span class="o">.</span><span class="n">output</span><span class="p">):</span>
                    <span class="k">if</span> <span class="n">putative</span><span class="p">(</span><span class="n">f</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">needed</span><span class="p">(</span><span class="n">job</span><span class="p">,</span> <span class="n">f</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">f</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">targetfiles</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">job</span><span class="o">.</span><span class="n">dynamic_output</span><span class="p">:</span>
                            <span class="k">for</span> <span class="n">f_</span> <span class="ow">in</span> <span class="n">job</span><span class="o">.</span><span class="n">expand_dynamic</span><span class="p">(</span><span class="n">f_</span><span class="p">):</span>
                                <span class="k">yield</span> <span class="n">f_</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="k">yield</span> <span class="n">f</span>
                <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="nb">filter</span><span class="p">(</span><span class="n">putative</span><span class="p">,</span> <span class="n">job</span><span class="o">.</span><span class="n">input</span><span class="p">):</span>
                    <span class="c1"># TODO what about remote inputs that are used by multiple jobs?</span>
                    <span class="k">if</span> <span class="n">f</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">generated_input</span><span class="p">:</span>
                        <span class="k">yield</span> <span class="n">f</span>

            <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">unneeded_files</span><span class="p">():</span>
                <span class="k">if</span> <span class="n">f</span><span class="o">.</span><span class="n">exists_local</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Removing local output file: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">f</span><span class="p">))</span>
                    <span class="n">f</span><span class="o">.</span><span class="n">remove</span><span class="p">()</span>

            <span class="n">job</span><span class="o">.</span><span class="n">rmdir_empty_remote_dirs</span><span class="p">()</span></div>

<div class="viewcode-block" id="DAG.jobid"><a class="viewcode-back" href="../../api_reference/internal/snakemake.html#snakemake.dag.DAG.jobid">[docs]</a>    <span class="k">def</span> <span class="nf">jobid</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">job</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return job id of given job.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">job</span><span class="o">.</span><span class="n">is_group</span><span class="p">():</span>
            <span class="k">return</span> <span class="n">job</span><span class="o">.</span><span class="n">jobid</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_jobid</span><span class="p">[</span><span class="n">job</span><span class="p">]</span></div>

<div class="viewcode-block" id="DAG.update"><a class="viewcode-back" href="../../api_reference/internal/snakemake.html#snakemake.dag.DAG.update">[docs]</a>    <span class="k">def</span> <span class="nf">update</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">jobs</span><span class="p">,</span> <span class="n">file</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">visited</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">skip_until_dynamic</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">progress</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Update the DAG by adding given jobs and their dependencies. &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">visited</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">visited</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="n">producer</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">exceptions</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
        <span class="n">jobs</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">jobs</span><span class="p">,</span> <span class="n">reverse</span><span class="o">=</span><span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">ignore_ambiguity</span><span class="p">)</span>
        <span class="n">cycles</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>


        <span class="k">for</span> <span class="n">job</span> <span class="ow">in</span> <span class="n">jobs</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">dag_debug</span><span class="p">(</span><span class="nb">dict</span><span class="p">(</span><span class="n">status</span><span class="o">=</span><span class="s2">&quot;candidate&quot;</span><span class="p">,</span> <span class="n">job</span><span class="o">=</span><span class="n">job</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">file</span> <span class="ow">in</span> <span class="n">job</span><span class="o">.</span><span class="n">input</span><span class="p">:</span>
                <span class="n">cycles</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">job</span><span class="p">)</span>
                <span class="k">continue</span>
            <span class="k">if</span> <span class="n">job</span> <span class="ow">in</span> <span class="n">visited</span><span class="p">:</span>
                <span class="n">cycles</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">job</span><span class="p">)</span>
                <span class="k">continue</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">check_periodic_wildcards</span><span class="p">(</span><span class="n">job</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">update_</span><span class="p">(</span><span class="n">job</span><span class="p">,</span>
                             <span class="n">visited</span><span class="o">=</span><span class="nb">set</span><span class="p">(</span><span class="n">visited</span><span class="p">),</span>
                             <span class="n">skip_until_dynamic</span><span class="o">=</span><span class="n">skip_until_dynamic</span><span class="p">,</span>
                             <span class="n">progress</span><span class="o">=</span><span class="n">progress</span><span class="p">)</span>
                <span class="c1"># TODO this might fail if a rule discarded here is needed</span>
                <span class="c1"># elsewhere</span>
                <span class="k">if</span> <span class="n">producer</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">job</span> <span class="o">&lt;</span> <span class="n">producer</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">ignore_ambiguity</span><span class="p">:</span>
                        <span class="k">break</span>
                    <span class="k">elif</span> <span class="n">producer</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="k">raise</span> <span class="n">AmbiguousRuleException</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="n">job</span><span class="p">,</span> <span class="n">producer</span><span class="p">)</span>
                <span class="n">producer</span> <span class="o">=</span> <span class="n">job</span>
            <span class="k">except</span> <span class="p">(</span><span class="n">MissingInputException</span><span class="p">,</span> <span class="n">CyclicGraphException</span><span class="p">,</span>
                    <span class="n">PeriodicWildcardError</span><span class="p">)</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
                <span class="n">exceptions</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ex</span><span class="p">)</span>
            <span class="k">except</span> <span class="n">RecursionError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">WorkflowError</span><span class="p">(</span>
                    <span class="n">e</span><span class="p">,</span> <span class="s2">&quot;If building the DAG exceeds the recursion limit, &quot;</span>
                    <span class="s2">&quot;this is likely due to a cyclic dependency.&quot;</span>
                    <span class="s2">&quot;E.g. you might have a sequence of rules that &quot;</span>
                    <span class="s2">&quot;can generate their own input. Try to make &quot;</span>
                    <span class="s2">&quot;the output files more specific. &quot;</span>
                    <span class="s2">&quot;A common pattern is to have different prefixes &quot;</span>
                    <span class="s2">&quot;in the output files of different rules.&quot;</span> <span class="o">+</span>
                    <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Problematic file pattern: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">file</span><span class="p">)</span> <span class="k">if</span> <span class="n">file</span> <span class="k">else</span>
                    <span class="s2">&quot;&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">producer</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">cycles</span><span class="p">:</span>
                <span class="n">job</span> <span class="o">=</span> <span class="n">cycles</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="k">raise</span> <span class="n">CyclicGraphException</span><span class="p">(</span><span class="n">job</span><span class="o">.</span><span class="n">rule</span><span class="p">,</span> <span class="n">file</span><span class="p">,</span> <span class="n">rule</span><span class="o">=</span><span class="n">job</span><span class="o">.</span><span class="n">rule</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">exceptions</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">exceptions</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">dag_debug</span><span class="p">(</span><span class="nb">dict</span><span class="p">(</span><span class="n">status</span><span class="o">=</span><span class="s2">&quot;selected&quot;</span><span class="p">,</span> <span class="n">job</span><span class="o">=</span><span class="n">producer</span><span class="p">))</span>

        <span class="n">n</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dependencies</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">progress</span> <span class="ow">and</span> <span class="n">n</span> <span class="o">%</span> <span class="mi">1000</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">n</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_progress</span> <span class="o">!=</span> <span class="n">n</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Processed </span><span class="si">{}</span><span class="s2"> potential jobs.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">n</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_progress</span> <span class="o">=</span> <span class="n">n</span>

        <span class="k">return</span> <span class="n">producer</span></div>

<div class="viewcode-block" id="DAG.update_"><a class="viewcode-back" href="../../api_reference/internal/snakemake.html#snakemake.dag.DAG.update_">[docs]</a>    <span class="k">def</span> <span class="nf">update_</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">job</span><span class="p">,</span> <span class="n">visited</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">skip_until_dynamic</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">progress</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Update the DAG by adding the given job and its dependencies. &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">job</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">dependencies</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="k">if</span> <span class="n">visited</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">visited</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="n">visited</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">job</span><span class="p">)</span>
        <span class="n">dependencies</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dependencies</span><span class="p">[</span><span class="n">job</span><span class="p">]</span>
        <span class="n">potential_dependencies</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">collect_potential_dependencies</span><span class="p">(</span>
            <span class="n">job</span><span class="p">)</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>

        <span class="n">skip_until_dynamic</span> <span class="o">=</span> <span class="n">skip_until_dynamic</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">job</span><span class="o">.</span><span class="n">dynamic_output</span>

        <span class="n">missing_input</span> <span class="o">=</span> <span class="n">job</span><span class="o">.</span><span class="n">missing_input</span>
        <span class="n">producer</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
        <span class="n">exceptions</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">file</span><span class="p">,</span> <span class="n">jobs</span> <span class="ow">in</span> <span class="n">potential_dependencies</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">selected_job</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">update</span><span class="p">(</span>
                    <span class="n">jobs</span><span class="p">,</span>
                    <span class="n">file</span><span class="o">=</span><span class="n">file</span><span class="p">,</span>
                    <span class="n">visited</span><span class="o">=</span><span class="n">visited</span><span class="p">,</span>
                    <span class="n">skip_until_dynamic</span><span class="o">=</span><span class="n">skip_until_dynamic</span> <span class="ow">or</span> <span class="n">file</span> <span class="ow">in</span>
                    <span class="n">job</span><span class="o">.</span><span class="n">dynamic_input</span><span class="p">,</span>
                    <span class="n">progress</span><span class="o">=</span><span class="n">progress</span><span class="p">)</span>
                <span class="n">producer</span><span class="p">[</span><span class="n">file</span><span class="p">]</span> <span class="o">=</span> <span class="n">selected_job</span>
            <span class="k">except</span> <span class="p">(</span><span class="n">MissingInputException</span><span class="p">,</span> <span class="n">CyclicGraphException</span><span class="p">,</span>
                    <span class="n">PeriodicWildcardError</span><span class="p">)</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">file</span> <span class="ow">in</span> <span class="n">missing_input</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">delete_job</span><span class="p">(</span><span class="n">job</span><span class="p">,</span>
                                    <span class="n">recursive</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>  <span class="c1"># delete job from tree</span>
                    <span class="k">raise</span> <span class="n">ex</span>

        <span class="k">for</span> <span class="n">file</span><span class="p">,</span> <span class="n">job_</span> <span class="ow">in</span> <span class="n">producer</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">dependencies</span><span class="p">[</span><span class="n">job_</span><span class="p">]</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">file</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">depending</span><span class="p">[</span><span class="n">job_</span><span class="p">][</span><span class="n">job</span><span class="p">]</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">file</span><span class="p">)</span>

        <span class="n">missing_input</span> <span class="o">-=</span> <span class="n">producer</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">missing_input</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">delete_job</span><span class="p">(</span><span class="n">job</span><span class="p">,</span> <span class="n">recursive</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>  <span class="c1"># delete job from tree</span>
            <span class="k">raise</span> <span class="n">MissingInputException</span><span class="p">(</span><span class="n">job</span><span class="o">.</span><span class="n">rule</span><span class="p">,</span> <span class="n">missing_input</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">skip_until_dynamic</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_dynamic</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">job</span><span class="p">)</span></div>

<div class="viewcode-block" id="DAG.update_needrun"><a class="viewcode-back" href="../../api_reference/internal/snakemake.html#snakemake.dag.DAG.update_needrun">[docs]</a>    <span class="k">def</span> <span class="nf">update_needrun</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Update the information whether a job needs to be executed. &quot;&quot;&quot;</span>

        <span class="k">def</span> <span class="nf">output_mintime</span><span class="p">(</span><span class="n">job</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">job_</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">bfs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">depending</span><span class="p">,</span> <span class="n">job</span><span class="p">):</span>
                <span class="n">t</span> <span class="o">=</span> <span class="n">job_</span><span class="o">.</span><span class="n">output_mintime</span>
                <span class="k">if</span> <span class="n">t</span><span class="p">:</span>
                    <span class="k">return</span> <span class="n">t</span>

        <span class="k">def</span> <span class="nf">needrun</span><span class="p">(</span><span class="n">job</span><span class="p">):</span>
            <span class="n">reason</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">reason</span><span class="p">(</span><span class="n">job</span><span class="p">)</span>
            <span class="n">noinitreason</span> <span class="o">=</span> <span class="ow">not</span> <span class="n">reason</span>
            <span class="n">updated_subworkflow_input</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">updated_subworkflow_files</span><span class="o">.</span><span class="n">intersection</span><span class="p">(</span>
                <span class="n">job</span><span class="o">.</span><span class="n">input</span><span class="p">)</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">job</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">omitforce</span> <span class="ow">and</span> <span class="n">job</span><span class="o">.</span><span class="n">rule</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">forcerules</span> <span class="ow">or</span>
                    <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">forcefiles</span><span class="o">.</span><span class="n">isdisjoint</span><span class="p">(</span><span class="n">job</span><span class="o">.</span><span class="n">output</span><span class="p">)):</span>
                <span class="n">reason</span><span class="o">.</span><span class="n">forced</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">elif</span> <span class="n">updated_subworkflow_input</span><span class="p">:</span>
                <span class="n">reason</span><span class="o">.</span><span class="n">updated_input</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">updated_subworkflow_input</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">job</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">targetjobs</span><span class="p">:</span>
                <span class="c1"># TODO find a way to handle added/removed input files here?</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">job</span><span class="o">.</span><span class="n">output</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">job</span><span class="o">.</span><span class="n">benchmark</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">job</span><span class="o">.</span><span class="n">input</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">job</span><span class="o">.</span><span class="n">rule</span><span class="o">.</span><span class="n">norun</span><span class="p">:</span>
                            <span class="n">reason</span><span class="o">.</span><span class="n">updated_input_run</span><span class="o">.</span><span class="n">update</span><span class="p">(</span>
                                <span class="p">[</span><span class="n">f</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">job</span><span class="o">.</span><span class="n">input</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">f</span><span class="o">.</span><span class="n">exists</span><span class="p">])</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">reason</span><span class="o">.</span><span class="n">nooutput</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">reason</span><span class="o">.</span><span class="n">noio</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">job</span><span class="o">.</span><span class="n">rule</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">targetrules</span><span class="p">:</span>
                        <span class="n">missing_output</span> <span class="o">=</span> <span class="n">job</span><span class="o">.</span><span class="n">missing_output</span><span class="p">()</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">missing_output</span> <span class="o">=</span> <span class="n">job</span><span class="o">.</span><span class="n">missing_output</span><span class="p">(</span>
                            <span class="n">requested</span><span class="o">=</span><span class="nb">set</span><span class="p">(</span><span class="n">chain</span><span class="p">(</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">depending</span><span class="p">[</span><span class="n">job</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">(</span>
                            <span class="p">)))</span> <span class="o">|</span> <span class="bp">self</span><span class="o">.</span><span class="n">targetfiles</span><span class="p">)</span>
                    <span class="n">reason</span><span class="o">.</span><span class="n">missing_output</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">missing_output</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">reason</span><span class="p">:</span>
                <span class="n">output_mintime_</span> <span class="o">=</span> <span class="n">output_mintime</span><span class="p">(</span><span class="n">job</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">output_mintime_</span><span class="p">:</span>
                    <span class="n">updated_input</span> <span class="o">=</span> <span class="p">[</span>
                        <span class="n">f</span>
                        <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">job</span><span class="o">.</span><span class="n">input</span>
                        <span class="k">if</span> <span class="n">f</span><span class="o">.</span><span class="n">exists</span> <span class="ow">and</span> <span class="n">f</span><span class="o">.</span><span class="n">is_newer</span><span class="p">(</span><span class="n">output_mintime_</span><span class="p">)</span>
                    <span class="p">]</span>
                    <span class="n">reason</span><span class="o">.</span><span class="n">updated_input</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">updated_input</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">noinitreason</span> <span class="ow">and</span> <span class="n">reason</span><span class="p">:</span>
                <span class="n">reason</span><span class="o">.</span><span class="n">derived</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="k">return</span> <span class="n">job</span>

        <span class="n">reason</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">reason</span>
        <span class="n">_needrun</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_needrun</span>
        <span class="n">dependencies</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dependencies</span>
        <span class="n">depending</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">depending</span>

        <span class="n">_needrun</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
        <span class="n">candidates</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">jobs</span><span class="p">)</span>

        <span class="n">queue</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">filter</span><span class="p">(</span><span class="n">reason</span><span class="p">,</span> <span class="nb">map</span><span class="p">(</span><span class="n">needrun</span><span class="p">,</span> <span class="n">candidates</span><span class="p">)))</span>
        <span class="n">visited</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">queue</span><span class="p">)</span>
        <span class="k">while</span> <span class="n">queue</span><span class="p">:</span>
            <span class="n">job</span> <span class="o">=</span> <span class="n">queue</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
            <span class="n">_needrun</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">job</span><span class="p">)</span>

            <span class="k">for</span> <span class="n">job_</span><span class="p">,</span> <span class="n">files</span> <span class="ow">in</span> <span class="n">dependencies</span><span class="p">[</span><span class="n">job</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="n">missing_output</span> <span class="o">=</span> <span class="n">job_</span><span class="o">.</span><span class="n">missing_output</span><span class="p">(</span><span class="n">requested</span><span class="o">=</span><span class="n">files</span><span class="p">)</span>
                <span class="n">reason</span><span class="p">(</span><span class="n">job_</span><span class="p">)</span><span class="o">.</span><span class="n">missing_output</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">missing_output</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">missing_output</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">job_</span> <span class="ow">in</span> <span class="n">visited</span><span class="p">:</span>
                    <span class="n">visited</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">job_</span><span class="p">)</span>
                    <span class="n">queue</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">job_</span><span class="p">)</span>

            <span class="k">for</span> <span class="n">job_</span><span class="p">,</span> <span class="n">files</span> <span class="ow">in</span> <span class="n">depending</span><span class="p">[</span><span class="n">job</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="k">if</span> <span class="n">job_</span> <span class="ow">in</span> <span class="n">candidates</span><span class="p">:</span>
                    <span class="n">reason</span><span class="p">(</span><span class="n">job_</span><span class="p">)</span><span class="o">.</span><span class="n">updated_input_run</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">files</span><span class="p">)</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">job_</span> <span class="ow">in</span> <span class="n">visited</span><span class="p">:</span>
                        <span class="n">visited</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">job_</span><span class="p">)</span>
                        <span class="n">queue</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">job_</span><span class="p">)</span>

        <span class="c1"># update len including finished jobs (because they have already increased the job counter)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_len</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_finished</span> <span class="o">|</span> <span class="bp">self</span><span class="o">.</span><span class="n">_needrun</span><span class="p">)</span></div>

<div class="viewcode-block" id="DAG.in_until"><a class="viewcode-back" href="../../api_reference/internal/snakemake.html#snakemake.dag.DAG.in_until">[docs]</a>    <span class="k">def</span> <span class="nf">in_until</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">job</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return whether given job has been specified via --until.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">job</span><span class="o">.</span><span class="n">rule</span><span class="o">.</span><span class="n">name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">untilrules</span> <span class="ow">or</span>
                <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">untilfiles</span><span class="o">.</span><span class="n">isdisjoint</span><span class="p">(</span><span class="n">job</span><span class="o">.</span><span class="n">output</span><span class="p">))</span></div>

<div class="viewcode-block" id="DAG.in_omitfrom"><a class="viewcode-back" href="../../api_reference/internal/snakemake.html#snakemake.dag.DAG.in_omitfrom">[docs]</a>    <span class="k">def</span> <span class="nf">in_omitfrom</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">job</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return whether given job has been specified via --omit-from.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">job</span><span class="o">.</span><span class="n">rule</span><span class="o">.</span><span class="n">name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">omitrules</span> <span class="ow">or</span>
                <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">omitfiles</span><span class="o">.</span><span class="n">isdisjoint</span><span class="p">(</span><span class="n">job</span><span class="o">.</span><span class="n">output</span><span class="p">))</span></div>

<div class="viewcode-block" id="DAG.until_jobs"><a class="viewcode-back" href="../../api_reference/internal/snakemake.html#snakemake.dag.DAG.until_jobs">[docs]</a>    <span class="k">def</span> <span class="nf">until_jobs</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Returns a generator of jobs specified by untiljobs.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">job</span> <span class="k">for</span> <span class="n">job</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">jobs</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">in_until</span><span class="p">(</span><span class="n">job</span><span class="p">))</span></div>

<div class="viewcode-block" id="DAG.omitfrom_jobs"><a class="viewcode-back" href="../../api_reference/internal/snakemake.html#snakemake.dag.DAG.omitfrom_jobs">[docs]</a>    <span class="k">def</span> <span class="nf">omitfrom_jobs</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Returns a generator of jobs specified by omitfromjobs.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">job</span> <span class="k">for</span> <span class="n">job</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">jobs</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">in_omitfrom</span><span class="p">(</span><span class="n">job</span><span class="p">))</span></div>

<div class="viewcode-block" id="DAG.downstream_of_omitfrom"><a class="viewcode-back" href="../../api_reference/internal/snakemake.html#snakemake.dag.DAG.downstream_of_omitfrom">[docs]</a>    <span class="k">def</span> <span class="nf">downstream_of_omitfrom</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Returns the downstream of --omit-from rules or files.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">filter</span><span class="p">(</span><span class="k">lambda</span> <span class="n">job</span><span class="p">:</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">in_omitfrom</span><span class="p">(</span><span class="n">job</span><span class="p">),</span>
                      <span class="bp">self</span><span class="o">.</span><span class="n">bfs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">depending</span><span class="p">,</span> <span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">omitfrom_jobs</span><span class="p">()))</span></div>

<div class="viewcode-block" id="DAG.delete_omitfrom_jobs"><a class="viewcode-back" href="../../api_reference/internal/snakemake.html#snakemake.dag.DAG.delete_omitfrom_jobs">[docs]</a>    <span class="k">def</span> <span class="nf">delete_omitfrom_jobs</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Removes jobs downstream of jobs specified by --omit-from.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">omitrules</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">omitfiles</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="n">downstream_jobs</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">downstream_of_omitfrom</span><span class="p">()</span>
                               <span class="p">)</span>  <span class="c1"># need to cast as list before deleting jobs</span>
        <span class="k">for</span> <span class="n">job</span> <span class="ow">in</span> <span class="n">downstream_jobs</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">delete_job</span><span class="p">(</span><span class="n">job</span><span class="p">,</span> <span class="n">recursive</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">add_dependencies</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span></div>

<div class="viewcode-block" id="DAG.set_until_jobs"><a class="viewcode-back" href="../../api_reference/internal/snakemake.html#snakemake.dag.DAG.set_until_jobs">[docs]</a>    <span class="k">def</span> <span class="nf">set_until_jobs</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Removes jobs downstream of jobs specified by --omit-from.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">untilrules</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">untilfiles</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">targetjobs</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">until_jobs</span><span class="p">())</span></div>

<div class="viewcode-block" id="DAG.update_priority"><a class="viewcode-back" href="../../api_reference/internal/snakemake.html#snakemake.dag.DAG.update_priority">[docs]</a>    <span class="k">def</span> <span class="nf">update_priority</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Update job priorities. &quot;&quot;&quot;</span>
        <span class="n">prioritized</span> <span class="o">=</span> <span class="p">(</span>
            <span class="k">lambda</span> <span class="n">job</span><span class="p">:</span> <span class="n">job</span><span class="o">.</span><span class="n">rule</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">priorityrules</span> <span class="ow">or</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">priorityfiles</span><span class="o">.</span><span class="n">isdisjoint</span><span class="p">(</span><span class="n">job</span><span class="o">.</span><span class="n">output</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="k">for</span> <span class="n">job</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">needrun_jobs</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_priority</span><span class="p">[</span><span class="n">job</span><span class="p">]</span> <span class="o">=</span> <span class="n">job</span><span class="o">.</span><span class="n">rule</span><span class="o">.</span><span class="n">priority</span>
        <span class="k">for</span> <span class="n">job</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">bfs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dependencies</span><span class="p">,</span>
                            <span class="o">*</span><span class="nb">filter</span><span class="p">(</span><span class="n">prioritized</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">needrun_jobs</span><span class="p">),</span>
                            <span class="n">stop</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">noneedrun_finished</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_priority</span><span class="p">[</span><span class="n">job</span><span class="p">]</span> <span class="o">=</span> <span class="n">Job</span><span class="o">.</span><span class="n">HIGHEST_PRIORITY</span></div>

<div class="viewcode-block" id="DAG.update_groups"><a class="viewcode-back" href="../../api_reference/internal/snakemake.html#snakemake.dag.DAG.update_groups">[docs]</a>    <span class="k">def</span> <span class="nf">update_groups</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">groups</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">job</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">needrun_jobs</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">job</span><span class="o">.</span><span class="n">group</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="n">stop</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">j</span><span class="p">:</span> <span class="n">j</span><span class="o">.</span><span class="n">group</span> <span class="o">!=</span> <span class="n">job</span><span class="o">.</span><span class="n">group</span>
            <span class="c1"># BFS into depending needrun jobs if in same group</span>
            <span class="c1"># Note: never go up here (into depending), because it may contain</span>
            <span class="c1"># jobs that have been sorted out due to e.g. ruleorder.</span>
            <span class="n">group</span> <span class="o">=</span> <span class="n">GroupJob</span><span class="p">(</span><span class="n">job</span><span class="o">.</span><span class="n">group</span><span class="p">,</span>
                             <span class="p">(</span><span class="n">job</span> <span class="k">for</span> <span class="n">job</span> <span class="ow">in</span>
                              <span class="bp">self</span><span class="o">.</span><span class="n">bfs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dependencies</span><span class="p">,</span> <span class="n">job</span><span class="p">,</span> <span class="n">stop</span><span class="o">=</span><span class="n">stop</span><span class="p">)</span>
                              <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">needrun</span><span class="p">(</span><span class="n">job</span><span class="p">)))</span>

            <span class="c1"># merge with previously determined groups if present</span>
            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">group</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">groups</span><span class="p">:</span>
                    <span class="n">other</span> <span class="o">=</span> <span class="n">groups</span><span class="p">[</span><span class="n">j</span><span class="p">]</span>
                    <span class="n">other</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">group</span><span class="p">)</span>
                    <span class="n">group</span> <span class="o">=</span> <span class="n">other</span>
            <span class="c1"># update assignment</span>
            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">group</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">j</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">groups</span><span class="p">:</span>
                    <span class="n">groups</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">group</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_group</span> <span class="o">=</span> <span class="n">groups</span></div>

<div class="viewcode-block" id="DAG.update_ready"><a class="viewcode-back" href="../../api_reference/internal/snakemake.html#snakemake.dag.DAG.update_ready">[docs]</a>    <span class="k">def</span> <span class="nf">update_ready</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">jobs</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Update information whether a job is ready to execute.</span>

<span class="sd">        Given jobs must be needrun jobs!</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="n">jobs</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">jobs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">needrun_jobs</span>

        <span class="n">candidate_groups</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">job</span> <span class="ow">in</span> <span class="n">jobs</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">finished</span><span class="p">(</span><span class="n">job</span><span class="p">)</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ready</span><span class="p">(</span><span class="n">job</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">job</span><span class="o">.</span><span class="n">group</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_ready_jobs</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">job</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">candidate_groups</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_group</span><span class="p">[</span><span class="n">job</span><span class="p">])</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_ready_jobs</span><span class="o">.</span><span class="n">update</span><span class="p">(</span>
            <span class="n">group</span> <span class="k">for</span> <span class="n">group</span> <span class="ow">in</span> <span class="n">candidate_groups</span>
            <span class="k">if</span> <span class="nb">all</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_ready</span><span class="p">(</span><span class="n">job</span><span class="p">)</span> <span class="k">for</span> <span class="n">job</span> <span class="ow">in</span> <span class="n">group</span><span class="p">))</span></div>

<div class="viewcode-block" id="DAG.get_jobs_or_groups"><a class="viewcode-back" href="../../api_reference/internal/snakemake.html#snakemake.dag.DAG.get_jobs_or_groups">[docs]</a>    <span class="k">def</span> <span class="nf">get_jobs_or_groups</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">visited_groups</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">job</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">jobs</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">job</span><span class="o">.</span><span class="n">group</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">yield</span> <span class="n">job</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">group</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_group</span><span class="p">[</span><span class="n">job</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">group</span> <span class="ow">in</span> <span class="n">visited_groups</span><span class="p">:</span>
                    <span class="k">continue</span>
                <span class="n">visited_groups</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">group</span><span class="p">)</span>
                <span class="k">yield</span> <span class="n">group</span></div>

<div class="viewcode-block" id="DAG.close_remote_objects"><a class="viewcode-back" href="../../api_reference/internal/snakemake.html#snakemake.dag.DAG.close_remote_objects">[docs]</a>    <span class="k">def</span> <span class="nf">close_remote_objects</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Close all remote objects.&quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">job</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">jobs</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">needrun</span><span class="p">(</span><span class="n">job</span><span class="p">):</span>
                <span class="n">job</span><span class="o">.</span><span class="n">close_remote</span><span class="p">()</span></div>

<div class="viewcode-block" id="DAG.postprocess"><a class="viewcode-back" href="../../api_reference/internal/snakemake.html#snakemake.dag.DAG.postprocess">[docs]</a>    <span class="k">def</span> <span class="nf">postprocess</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Postprocess the DAG. This has to be invoked after any change to the</span>
<span class="sd">        DAG topology.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">update_jobids</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">update_needrun</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">update_priority</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">handle_pipes</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">update_groups</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">update_ready</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">close_remote_objects</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">update_checkpoint_outputs</span><span class="p">()</span></div>

<div class="viewcode-block" id="DAG.handle_pipes"><a class="viewcode-back" href="../../api_reference/internal/snakemake.html#snakemake.dag.DAG.handle_pipes">[docs]</a>    <span class="k">def</span> <span class="nf">handle_pipes</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Use pipes to determine job groups. Check if every pipe has exactly</span>
<span class="sd">           one consumer&quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">job</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">needrun_jobs</span><span class="p">:</span>
            <span class="n">candidate_groups</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">job</span><span class="o">.</span><span class="n">group</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">candidate_groups</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">job</span><span class="o">.</span><span class="n">group</span><span class="p">)</span>
            <span class="n">all_depending</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
            <span class="n">has_pipe</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">job</span><span class="o">.</span><span class="n">output</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">is_flagged</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="s2">&quot;pipe&quot;</span><span class="p">):</span>
                    <span class="k">if</span> <span class="n">job</span><span class="o">.</span><span class="n">is_run</span><span class="p">:</span>
                        <span class="k">raise</span> <span class="n">WorkflowError</span><span class="p">(</span><span class="s2">&quot;Rule defines pipe output but &quot;</span>
                                            <span class="s2">&quot;uses a &#39;run&#39; directive. This is &quot;</span>
                                            <span class="s2">&quot;not possible for technical &quot;</span>
                                            <span class="s2">&quot;reasons. Consider using &#39;shell&#39; or &quot;</span>
                                            <span class="s2">&quot;&#39;script&#39;.&quot;</span><span class="p">,</span> <span class="n">rule</span><span class="o">=</span><span class="n">job</span><span class="o">.</span><span class="n">rule</span><span class="p">)</span>

                    <span class="n">has_pipe</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="n">depending</span> <span class="o">=</span> <span class="p">[</span><span class="n">j</span> <span class="k">for</span> <span class="n">j</span><span class="p">,</span> <span class="n">files</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">depending</span><span class="p">[</span><span class="n">job</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
                                   <span class="k">if</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">files</span><span class="p">]</span>
                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">depending</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                        <span class="k">raise</span> <span class="n">WorkflowError</span><span class="p">(</span><span class="s2">&quot;Output file </span><span class="si">{}</span><span class="s2"> is marked as pipe &quot;</span>
                                            <span class="s2">&quot;but more than one job depends on &quot;</span>
                                            <span class="s2">&quot;it. Make sure that any pipe &quot;</span>
                                            <span class="s2">&quot;output is only consumed by one &quot;</span>
                                            <span class="s2">&quot;job&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">f</span><span class="p">),</span>
                                            <span class="n">rule</span><span class="o">=</span><span class="n">job</span><span class="o">.</span><span class="n">rule</span><span class="p">)</span>
                    <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">depending</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="k">raise</span> <span class="n">WorkflowError</span><span class="p">(</span><span class="s2">&quot;Output file </span><span class="si">{}</span><span class="s2"> is marked as pipe &quot;</span>
                                            <span class="s2">&quot;but it has no consumer. This is &quot;</span>
                                            <span class="s2">&quot;invalid because it can lead to &quot;</span>
                                            <span class="s2">&quot;a dead lock.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">f</span><span class="p">),</span>
                                            <span class="n">rule</span><span class="o">=</span><span class="n">job</span><span class="o">.</span><span class="n">rule</span><span class="p">)</span>

                    <span class="n">depending</span> <span class="o">=</span> <span class="n">depending</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

                    <span class="k">if</span> <span class="n">depending</span><span class="o">.</span><span class="n">is_run</span><span class="p">:</span>
                        <span class="k">raise</span> <span class="n">WorkflowError</span><span class="p">(</span><span class="s2">&quot;Rule consumes pipe input but &quot;</span>
                                            <span class="s2">&quot;uses a &#39;run&#39; directive. This is &quot;</span>
                                            <span class="s2">&quot;not possible for technical &quot;</span>
                                            <span class="s2">&quot;reasons. Consider using &#39;shell&#39; or &quot;</span>
                                            <span class="s2">&quot;&#39;script&#39;.&quot;</span><span class="p">,</span> <span class="n">rule</span><span class="o">=</span><span class="n">job</span><span class="o">.</span><span class="n">rule</span><span class="p">)</span>

                    <span class="n">all_depending</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">depending</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">depending</span><span class="o">.</span><span class="n">group</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="n">candidate_groups</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">depending</span><span class="o">.</span><span class="n">group</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">has_pipe</span><span class="p">:</span>
                <span class="k">continue</span>

            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">candidate_groups</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">WorkflowError</span><span class="p">(</span><span class="s2">&quot;An output file is marked as &quot;</span>
                                    <span class="s2">&quot;pipe, but consuming jobs &quot;</span>
                                    <span class="s2">&quot;are part of conflicting &quot;</span>
                                    <span class="s2">&quot;groups.&quot;</span><span class="p">,</span>
                                    <span class="n">rule</span><span class="o">=</span><span class="n">job</span><span class="o">.</span><span class="n">rule</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">candidate_groups</span><span class="p">:</span>
                <span class="c1"># extend the candidate group to all involved jobs</span>
                <span class="n">group</span> <span class="o">=</span> <span class="n">candidate_groups</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># generate a random unique group name</span>
                <span class="n">group</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">uuid</span><span class="o">.</span><span class="n">uuid4</span><span class="p">())</span>
            <span class="n">job</span><span class="o">.</span><span class="n">group</span> <span class="o">=</span> <span class="n">group</span>
            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">all_depending</span><span class="p">:</span>
                <span class="n">j</span><span class="o">.</span><span class="n">group</span> <span class="o">=</span> <span class="n">group</span></div>

    <span class="k">def</span> <span class="nf">_ready</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">job</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return whether the given job is ready to execute.&quot;&quot;&quot;</span>
        <span class="n">group</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_group</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">job</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">group</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">is_external_needrun_dep</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">needrun</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">def</span> <span class="nf">is_external_needrun_dep</span><span class="p">(</span><span class="n">j</span><span class="p">):</span>
                <span class="n">g</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_group</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">j</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">needrun</span><span class="p">(</span><span class="n">j</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">g</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">g</span> <span class="o">!=</span> <span class="n">group</span><span class="p">)</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_finished</span><span class="o">.</span><span class="n">issuperset</span><span class="p">(</span><span class="nb">filter</span><span class="p">(</span><span class="n">is_external_needrun_dep</span><span class="p">,</span>
                                                <span class="bp">self</span><span class="o">.</span><span class="n">dependencies</span><span class="p">[</span><span class="n">job</span><span class="p">]))</span>

<div class="viewcode-block" id="DAG.update_checkpoint_dependencies"><a class="viewcode-back" href="../../api_reference/internal/snakemake.html#snakemake.dag.DAG.update_checkpoint_dependencies">[docs]</a>    <span class="k">def</span> <span class="nf">update_checkpoint_dependencies</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">jobs</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Update dependencies of checkpoints.&quot;&quot;&quot;</span>
        <span class="n">updated</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">update_checkpoint_outputs</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">jobs</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">jobs</span> <span class="o">=</span> <span class="p">[</span><span class="n">job</span> <span class="k">for</span> <span class="n">job</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">jobs</span> <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">needrun</span><span class="p">(</span><span class="n">job</span><span class="p">)]</span>
        <span class="k">for</span> <span class="n">job</span> <span class="ow">in</span> <span class="n">jobs</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">job</span><span class="o">.</span><span class="n">is_checkpoint</span><span class="p">:</span>
                <span class="n">depending</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">depending</span><span class="p">[</span><span class="n">job</span><span class="p">])</span>
                <span class="c1"># re-evaluate depending jobs, replace and update DAG</span>
                <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">depending</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Updating job </span><span class="si">{}</span><span class="s2">.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">jobid</span><span class="p">(</span><span class="n">j</span><span class="p">)))</span>
                    <span class="n">newjob</span> <span class="o">=</span> <span class="n">j</span><span class="o">.</span><span class="n">updated</span><span class="p">()</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">replace_job</span><span class="p">(</span><span class="n">j</span><span class="p">,</span> <span class="n">newjob</span><span class="p">,</span> <span class="n">recursive</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
                    <span class="n">updated</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="k">if</span> <span class="n">updated</span><span class="p">:</span>
                    <span class="c1"># This has to be done for each checkpoint,</span>
                    <span class="c1"># otherwise, jobs may be missing in the end.</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">postprocess</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">updated</span></div>

<div class="viewcode-block" id="DAG.finish"><a class="viewcode-back" href="../../api_reference/internal/snakemake.html#snakemake.dag.DAG.finish">[docs]</a>    <span class="k">def</span> <span class="nf">finish</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">job</span><span class="p">,</span> <span class="n">update_dynamic</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Finish a given job (e.g. remove from ready jobs, mark depending jobs</span>
<span class="sd">        as ready).&quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_ready_jobs</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">job</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
            <span class="k">pass</span>

        <span class="k">if</span> <span class="n">job</span><span class="o">.</span><span class="n">is_group</span><span class="p">():</span>
            <span class="n">jobs</span> <span class="o">=</span> <span class="n">job</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">jobs</span> <span class="o">=</span> <span class="p">[</span><span class="n">job</span><span class="p">]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_finished</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">jobs</span><span class="p">)</span>

        <span class="n">updated_dag</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">if</span> <span class="n">update_dynamic</span><span class="p">:</span>
            <span class="n">updated_dag</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">update_checkpoint_dependencies</span><span class="p">(</span><span class="n">jobs</span><span class="p">)</span>

        <span class="c1"># mark depending jobs as ready</span>
        <span class="c1"># skip jobs that are marked as until jobs</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">update_ready</span><span class="p">(</span><span class="n">j</span> <span class="k">for</span> <span class="n">job</span> <span class="ow">in</span> <span class="n">jobs</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">depending</span><span class="p">[</span><span class="n">job</span><span class="p">]</span>
                            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">in_until</span><span class="p">(</span><span class="n">job</span><span class="p">)</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">needrun</span><span class="p">(</span><span class="n">j</span><span class="p">))</span>

        <span class="k">for</span> <span class="n">job</span> <span class="ow">in</span> <span class="n">jobs</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">update_dynamic</span> <span class="ow">and</span> <span class="n">job</span><span class="o">.</span><span class="n">dynamic_output</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Dynamically updating jobs&quot;</span><span class="p">)</span>
                <span class="n">newjob</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">update_dynamic</span><span class="p">(</span><span class="n">job</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">newjob</span><span class="p">:</span>
                    <span class="c1"># simulate that this job ran and was finished before</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">omitforce</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">newjob</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_needrun</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">newjob</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_finished</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">newjob</span><span class="p">)</span>
                    <span class="n">updated_dag</span> <span class="o">=</span> <span class="kc">True</span>

                    <span class="bp">self</span><span class="o">.</span><span class="n">postprocess</span><span class="p">()</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">handle_protected</span><span class="p">(</span><span class="n">newjob</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">handle_touch</span><span class="p">(</span><span class="n">newjob</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">updated_dag</span><span class="p">:</span>
            <span class="c1"># We might have new jobs, so we need to ensure that all conda envs</span>
            <span class="c1"># and singularity images are set up.</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">workflow</span><span class="o">.</span><span class="n">use_singularity</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">pull_singularity_imgs</span><span class="p">()</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">workflow</span><span class="o">.</span><span class="n">use_conda</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">create_conda_envs</span><span class="p">()</span></div>


<div class="viewcode-block" id="DAG.new_job"><a class="viewcode-back" href="../../api_reference/internal/snakemake.html#snakemake.dag.DAG.new_job">[docs]</a>    <span class="k">def</span> <span class="nf">new_job</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">rule</span><span class="p">,</span> <span class="n">targetfile</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">format_wildcards</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Create new job for given rule and (optional) targetfile.</span>
<span class="sd">        This will reuse existing jobs with the same wildcards.&quot;&quot;&quot;</span>
        <span class="n">key</span> <span class="o">=</span> <span class="p">(</span><span class="n">rule</span><span class="p">,</span> <span class="n">targetfile</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">job_cache</span><span class="p">:</span>
            <span class="k">assert</span> <span class="n">targetfile</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">job_cache</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
        <span class="n">wildcards_dict</span> <span class="o">=</span> <span class="n">rule</span><span class="o">.</span><span class="n">get_wildcards</span><span class="p">(</span><span class="n">targetfile</span><span class="p">)</span>
        <span class="n">job</span> <span class="o">=</span> <span class="n">Job</span><span class="p">(</span><span class="n">rule</span><span class="p">,</span> <span class="bp">self</span><span class="p">,</span> <span class="n">wildcards_dict</span><span class="o">=</span><span class="n">wildcards_dict</span><span class="p">,</span>
                  <span class="n">format_wildcards</span><span class="o">=</span><span class="n">format_wildcards</span><span class="p">,</span> <span class="n">targetfile</span><span class="o">=</span><span class="n">targetfile</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">job</span><span class="o">.</span><span class="n">products</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">job_cache</span><span class="p">[(</span><span class="n">rule</span><span class="p">,</span> <span class="n">f</span><span class="p">)]</span> <span class="o">=</span> <span class="n">job</span>
        <span class="k">return</span> <span class="n">job</span></div>

<div class="viewcode-block" id="DAG.update_dynamic"><a class="viewcode-back" href="../../api_reference/internal/snakemake.html#snakemake.dag.DAG.update_dynamic">[docs]</a>    <span class="k">def</span> <span class="nf">update_dynamic</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">job</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Update the DAG by evaluating the output of the given job that</span>
<span class="sd">        contains dynamic output files.&quot;&quot;&quot;</span>
        <span class="n">dynamic_wildcards</span> <span class="o">=</span> <span class="n">job</span><span class="o">.</span><span class="n">dynamic_wildcards</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">dynamic_wildcards</span><span class="p">:</span>
            <span class="c1"># this happens e.g. in dryrun if output is not yet present</span>
            <span class="k">return</span>

        <span class="n">depending</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">filter</span><span class="p">(</span><span class="k">lambda</span> <span class="n">job_</span><span class="p">:</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">finished</span><span class="p">(</span><span class="n">job_</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">bfs</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">depending</span><span class="p">,</span> <span class="n">job</span><span class="p">)))</span>
        <span class="n">newrule</span><span class="p">,</span> <span class="n">non_dynamic_wildcards</span> <span class="o">=</span> <span class="n">job</span><span class="o">.</span><span class="n">rule</span><span class="o">.</span><span class="n">dynamic_branch</span><span class="p">(</span>
            <span class="n">dynamic_wildcards</span><span class="p">,</span>
            <span class="nb">input</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">specialize_rule</span><span class="p">(</span><span class="n">job</span><span class="o">.</span><span class="n">rule</span><span class="p">,</span> <span class="n">newrule</span><span class="p">)</span>

        <span class="c1"># no targetfile needed for job</span>
        <span class="n">newjob</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">new_job</span><span class="p">(</span><span class="n">newrule</span><span class="p">,</span> <span class="n">format_wildcards</span><span class="o">=</span><span class="n">non_dynamic_wildcards</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">replace_job</span><span class="p">(</span><span class="n">job</span><span class="p">,</span> <span class="n">newjob</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">job_</span> <span class="ow">in</span> <span class="n">depending</span><span class="p">:</span>
            <span class="n">needs_update</span> <span class="o">=</span> <span class="nb">any</span><span class="p">(</span>
                <span class="n">f</span><span class="o">.</span><span class="n">get_wildcard_names</span><span class="p">()</span> <span class="o">&amp;</span> <span class="n">dynamic_wildcards</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
                <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">job_</span><span class="o">.</span><span class="n">rule</span><span class="o">.</span><span class="n">dynamic_input</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">needs_update</span><span class="p">:</span>
                <span class="n">newrule_</span> <span class="o">=</span> <span class="n">job_</span><span class="o">.</span><span class="n">rule</span><span class="o">.</span><span class="n">dynamic_branch</span><span class="p">(</span><span class="n">dynamic_wildcards</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">newrule_</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">specialize_rule</span><span class="p">(</span><span class="n">job_</span><span class="o">.</span><span class="n">rule</span><span class="p">,</span> <span class="n">newrule_</span><span class="p">)</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">dynamic</span><span class="p">(</span><span class="n">job_</span><span class="p">):</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Updating job </span><span class="si">{}</span><span class="s2">.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">job_</span><span class="p">))</span>
                        <span class="n">newjob_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">new_job</span><span class="p">(</span>
                            <span class="n">newrule_</span><span class="p">,</span>
                            <span class="n">targetfile</span><span class="o">=</span><span class="n">job_</span><span class="o">.</span><span class="n">output</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">if</span> <span class="n">job_</span><span class="o">.</span><span class="n">output</span> <span class="k">else</span> <span class="kc">None</span><span class="p">)</span>

                        <span class="n">unexpected_output</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">reason</span><span class="p">(</span>
                            <span class="n">job_</span><span class="p">)</span><span class="o">.</span><span class="n">missing_output</span><span class="o">.</span><span class="n">intersection</span><span class="p">(</span>
                                <span class="n">newjob</span><span class="o">.</span><span class="n">existing_output</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">unexpected_output</span><span class="p">:</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                                <span class="s2">&quot;Warning: the following output files of rule </span><span class="si">{}</span><span class="s2"> were not &quot;</span>
                                <span class="s2">&quot;present when the DAG was created:</span><span class="se">\n</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                                    <span class="n">newjob_</span><span class="o">.</span><span class="n">rule</span><span class="p">,</span> <span class="n">unexpected_output</span><span class="p">))</span>

                        <span class="bp">self</span><span class="o">.</span><span class="n">replace_job</span><span class="p">(</span><span class="n">job_</span><span class="p">,</span> <span class="n">newjob_</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">newjob</span></div>

<div class="viewcode-block" id="DAG.delete_job"><a class="viewcode-back" href="../../api_reference/internal/snakemake.html#snakemake.dag.DAG.delete_job">[docs]</a>    <span class="k">def</span> <span class="nf">delete_job</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">job</span><span class="p">,</span> <span class="n">recursive</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">add_dependencies</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Delete given job from DAG.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">job</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">targetjobs</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">targetjobs</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">job</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">add_dependencies</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">_job</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">dependencies</span><span class="p">[</span><span class="n">job</span><span class="p">]:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">targetjobs</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">_job</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">job_</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">depending</span><span class="p">[</span><span class="n">job</span><span class="p">]:</span>
            <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">dependencies</span><span class="p">[</span><span class="n">job_</span><span class="p">][</span><span class="n">job</span><span class="p">]</span>
        <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">depending</span><span class="p">[</span><span class="n">job</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">job_</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">dependencies</span><span class="p">[</span><span class="n">job</span><span class="p">]:</span>
            <span class="n">depending</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">depending</span><span class="p">[</span><span class="n">job_</span><span class="p">]</span>
            <span class="k">del</span> <span class="n">depending</span><span class="p">[</span><span class="n">job</span><span class="p">]</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">depending</span> <span class="ow">and</span> <span class="n">recursive</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">delete_job</span><span class="p">(</span><span class="n">job_</span><span class="p">)</span>
        <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">dependencies</span><span class="p">[</span><span class="n">job</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">job</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_needrun</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_len</span> <span class="o">-=</span> <span class="mi">1</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_needrun</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">job</span><span class="p">)</span>
            <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">_reason</span><span class="p">[</span><span class="n">job</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">job</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_finished</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_finished</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">job</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">job</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dynamic</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_dynamic</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">job</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">job</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ready_jobs</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_ready_jobs</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">job</span><span class="p">)</span></div>

<div class="viewcode-block" id="DAG.replace_job"><a class="viewcode-back" href="../../api_reference/internal/snakemake.html#snakemake.dag.DAG.replace_job">[docs]</a>    <span class="k">def</span> <span class="nf">replace_job</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">job</span><span class="p">,</span> <span class="n">newjob</span><span class="p">,</span> <span class="n">recursive</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Replace given job with new job.&quot;&quot;&quot;</span>
        <span class="n">add_to_targetjobs</span> <span class="o">=</span> <span class="n">job</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">targetjobs</span>

        <span class="n">depending</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">depending</span><span class="p">[</span><span class="n">job</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">())</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">finished</span><span class="p">(</span><span class="n">job</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_finished</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">newjob</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">delete_job</span><span class="p">(</span><span class="n">job</span><span class="p">,</span> <span class="n">recursive</span><span class="o">=</span><span class="n">recursive</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">add_to_targetjobs</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">targetjobs</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">newjob</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">update</span><span class="p">([</span><span class="n">newjob</span><span class="p">])</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Replace </span><span class="si">{}</span><span class="s2"> with dynamic branch </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">job</span><span class="p">,</span> <span class="n">newjob</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">job_</span><span class="p">,</span> <span class="n">files</span> <span class="ow">in</span> <span class="n">depending</span><span class="p">:</span>
            <span class="c1">#if not job_.dynamic_input:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;updating depending job </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">job_</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dependencies</span><span class="p">[</span><span class="n">job_</span><span class="p">][</span><span class="n">newjob</span><span class="p">]</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">files</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">depending</span><span class="p">[</span><span class="n">newjob</span><span class="p">][</span><span class="n">job_</span><span class="p">]</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">files</span><span class="p">)</span></div>

<div class="viewcode-block" id="DAG.specialize_rule"><a class="viewcode-back" href="../../api_reference/internal/snakemake.html#snakemake.dag.DAG.specialize_rule">[docs]</a>    <span class="k">def</span> <span class="nf">specialize_rule</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">rule</span><span class="p">,</span> <span class="n">newrule</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Specialize the given rule by inserting newrule into the DAG.&quot;&quot;&quot;</span>
        <span class="k">assert</span> <span class="n">newrule</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rules</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">newrule</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">update_output_index</span><span class="p">()</span></div>

<div class="viewcode-block" id="DAG.collect_potential_dependencies"><a class="viewcode-back" href="../../api_reference/internal/snakemake.html#snakemake.dag.DAG.collect_potential_dependencies">[docs]</a>    <span class="k">def</span> <span class="nf">collect_potential_dependencies</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">job</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Collect all potential dependencies of a job. These might contain</span>
<span class="sd">        ambiguities.&quot;&quot;&quot;</span>
        <span class="n">dependencies</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">list</span><span class="p">)</span>
        <span class="c1"># use a set to circumvent multiple jobs for the same file</span>
        <span class="c1"># if user specified it twice</span>
        <span class="n">file2jobs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">file2jobs</span>
        <span class="k">for</span> <span class="n">file</span> <span class="ow">in</span> <span class="n">job</span><span class="o">.</span><span class="n">unique_input</span><span class="p">:</span>
            <span class="c1"># omit the file if it comes from a subworkflow</span>
            <span class="k">if</span> <span class="n">file</span> <span class="ow">in</span> <span class="n">job</span><span class="o">.</span><span class="n">subworkflow_input</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">file</span> <span class="ow">in</span> <span class="n">job</span><span class="o">.</span><span class="n">dependencies</span><span class="p">:</span>
                    <span class="n">jobs</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">new_job</span><span class="p">(</span><span class="n">job</span><span class="o">.</span><span class="n">dependencies</span><span class="p">[</span><span class="n">file</span><span class="p">],</span> <span class="n">targetfile</span><span class="o">=</span><span class="n">file</span><span class="p">)]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">jobs</span> <span class="o">=</span> <span class="n">file2jobs</span><span class="p">(</span><span class="n">file</span><span class="p">)</span>
                <span class="n">dependencies</span><span class="p">[</span><span class="n">file</span><span class="p">]</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">jobs</span><span class="p">)</span>
            <span class="k">except</span> <span class="n">MissingRuleException</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
                <span class="k">pass</span>
        <span class="k">return</span> <span class="n">dependencies</span></div>

<div class="viewcode-block" id="DAG.bfs"><a class="viewcode-back" href="../../api_reference/internal/snakemake.html#snakemake.dag.DAG.bfs">[docs]</a>    <span class="k">def</span> <span class="nf">bfs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">direction</span><span class="p">,</span> <span class="o">*</span><span class="n">jobs</span><span class="p">,</span> <span class="n">stop</span><span class="o">=</span><span class="k">lambda</span> <span class="n">job</span><span class="p">:</span> <span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Perform a breadth-first traversal of the DAG.&quot;&quot;&quot;</span>
        <span class="n">queue</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">jobs</span><span class="p">)</span>
        <span class="n">visited</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">queue</span><span class="p">)</span>
        <span class="k">while</span> <span class="n">queue</span><span class="p">:</span>
            <span class="n">job</span> <span class="o">=</span> <span class="n">queue</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">stop</span><span class="p">(</span><span class="n">job</span><span class="p">):</span>
                <span class="c1"># stop criterion reached for this node</span>
                <span class="k">continue</span>
            <span class="k">yield</span> <span class="n">job</span>
            <span class="k">for</span> <span class="n">job_</span><span class="p">,</span> <span class="n">_</span> <span class="ow">in</span> <span class="n">direction</span><span class="p">[</span><span class="n">job</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">job_</span> <span class="ow">in</span> <span class="n">visited</span><span class="p">:</span>
                    <span class="n">queue</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">job_</span><span class="p">)</span>
                    <span class="n">visited</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">job_</span><span class="p">)</span></div>

<div class="viewcode-block" id="DAG.level_bfs"><a class="viewcode-back" href="../../api_reference/internal/snakemake.html#snakemake.dag.DAG.level_bfs">[docs]</a>    <span class="k">def</span> <span class="nf">level_bfs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">direction</span><span class="p">,</span> <span class="o">*</span><span class="n">jobs</span><span class="p">,</span> <span class="n">stop</span><span class="o">=</span><span class="k">lambda</span> <span class="n">job</span><span class="p">:</span> <span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Perform a breadth-first traversal of the DAG, but also yield the</span>
<span class="sd">        level together with each job.&quot;&quot;&quot;</span>
        <span class="n">queue</span> <span class="o">=</span> <span class="p">[(</span><span class="n">job</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="k">for</span> <span class="n">job</span> <span class="ow">in</span> <span class="n">jobs</span><span class="p">]</span>
        <span class="n">visited</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">jobs</span><span class="p">)</span>
        <span class="k">while</span> <span class="n">queue</span><span class="p">:</span>
            <span class="n">job</span><span class="p">,</span> <span class="n">level</span> <span class="o">=</span> <span class="n">queue</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">stop</span><span class="p">(</span><span class="n">job</span><span class="p">):</span>
                <span class="c1"># stop criterion reached for this node</span>
                <span class="k">continue</span>
            <span class="k">yield</span> <span class="n">level</span><span class="p">,</span> <span class="n">job</span>
            <span class="n">level</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">for</span> <span class="n">job_</span><span class="p">,</span> <span class="n">_</span> <span class="ow">in</span> <span class="n">direction</span><span class="p">[</span><span class="n">job</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">job_</span> <span class="ow">in</span> <span class="n">visited</span><span class="p">:</span>
                    <span class="n">queue</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">job_</span><span class="p">,</span> <span class="n">level</span><span class="p">))</span>
                    <span class="n">visited</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">job_</span><span class="p">)</span></div>

<div class="viewcode-block" id="DAG.dfs"><a class="viewcode-back" href="../../api_reference/internal/snakemake.html#snakemake.dag.DAG.dfs">[docs]</a>    <span class="k">def</span> <span class="nf">dfs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">direction</span><span class="p">,</span> <span class="o">*</span><span class="n">jobs</span><span class="p">,</span> <span class="n">stop</span><span class="o">=</span><span class="k">lambda</span> <span class="n">job</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span> <span class="n">post</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Perform depth-first traversal of the DAG.&quot;&quot;&quot;</span>
        <span class="n">visited</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>

        <span class="k">def</span> <span class="nf">_dfs</span><span class="p">(</span><span class="n">job</span><span class="p">):</span>
            <span class="sd">&quot;&quot;&quot;Inner function for DFS traversal.&quot;&quot;&quot;</span>
            <span class="k">if</span> <span class="n">stop</span><span class="p">(</span><span class="n">job</span><span class="p">):</span>
                <span class="k">return</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">post</span><span class="p">:</span>
                <span class="k">yield</span> <span class="n">job</span>
            <span class="k">for</span> <span class="n">job_</span> <span class="ow">in</span> <span class="n">direction</span><span class="p">[</span><span class="n">job</span><span class="p">]:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">job_</span> <span class="ow">in</span> <span class="n">visited</span><span class="p">:</span>
                    <span class="n">visited</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">job_</span><span class="p">)</span>
                    <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">_dfs</span><span class="p">(</span><span class="n">job_</span><span class="p">):</span>
                        <span class="k">yield</span> <span class="n">j</span>
            <span class="k">if</span> <span class="n">post</span><span class="p">:</span>
                <span class="k">yield</span> <span class="n">job</span>

        <span class="k">for</span> <span class="n">job</span> <span class="ow">in</span> <span class="n">jobs</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">job_</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dfs</span><span class="p">(</span><span class="n">direction</span><span class="p">,</span>
                                  <span class="n">job</span><span class="p">,</span>
                                  <span class="n">visited</span><span class="p">,</span>
                                  <span class="n">stop</span><span class="o">=</span><span class="n">stop</span><span class="p">,</span>
                                  <span class="n">post</span><span class="o">=</span><span class="n">post</span><span class="p">):</span>
                <span class="k">yield</span> <span class="n">job_</span></div>

<div class="viewcode-block" id="DAG.new_wildcards"><a class="viewcode-back" href="../../api_reference/internal/snakemake.html#snakemake.dag.DAG.new_wildcards">[docs]</a>    <span class="k">def</span> <span class="nf">new_wildcards</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">job</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return wildcards that are newly introduced in this job,</span>
<span class="sd">        compared to its ancestors.&quot;&quot;&quot;</span>
        <span class="n">new_wildcards</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">job</span><span class="o">.</span><span class="n">wildcards</span><span class="o">.</span><span class="n">items</span><span class="p">())</span>
        <span class="k">for</span> <span class="n">job_</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">dependencies</span><span class="p">[</span><span class="n">job</span><span class="p">]:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">new_wildcards</span><span class="p">:</span>
                <span class="k">return</span> <span class="nb">set</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">wildcard</span> <span class="ow">in</span> <span class="n">job_</span><span class="o">.</span><span class="n">wildcards</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="n">new_wildcards</span><span class="o">.</span><span class="n">discard</span><span class="p">(</span><span class="n">wildcard</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">new_wildcards</span></div>

<div class="viewcode-block" id="DAG.rule2job"><a class="viewcode-back" href="../../api_reference/internal/snakemake.html#snakemake.dag.DAG.rule2job">[docs]</a>    <span class="k">def</span> <span class="nf">rule2job</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">targetrule</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Generate a new job from a given rule.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">targetrule</span><span class="o">.</span><span class="n">has_wildcards</span><span class="p">():</span>
            <span class="k">raise</span> <span class="n">WorkflowError</span><span class="p">(</span><span class="s2">&quot;Target rules may not contain wildcards. Please specify concrete files or a rule without wildcards.&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">new_job</span><span class="p">(</span><span class="n">targetrule</span><span class="p">)</span></div>

<div class="viewcode-block" id="DAG.file2jobs"><a class="viewcode-back" href="../../api_reference/internal/snakemake.html#snakemake.dag.DAG.file2jobs">[docs]</a>    <span class="k">def</span> <span class="nf">file2jobs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">targetfile</span><span class="p">):</span>
        <span class="n">rules</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">output_index</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">targetfile</span><span class="p">)</span>
        <span class="n">jobs</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">exceptions</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">rule</span> <span class="ow">in</span> <span class="n">rules</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">rule</span><span class="o">.</span><span class="n">is_producer</span><span class="p">(</span><span class="n">targetfile</span><span class="p">):</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">jobs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">new_job</span><span class="p">(</span><span class="n">rule</span><span class="p">,</span> <span class="n">targetfile</span><span class="o">=</span><span class="n">targetfile</span><span class="p">))</span>
                <span class="k">except</span> <span class="n">InputFunctionException</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                    <span class="n">exceptions</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">jobs</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">exceptions</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">exceptions</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">raise</span> <span class="n">MissingRuleException</span><span class="p">(</span><span class="n">targetfile</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">jobs</span></div>

<div class="viewcode-block" id="DAG.rule_dot2"><a class="viewcode-back" href="../../api_reference/internal/snakemake.html#snakemake.dag.DAG.rule_dot2">[docs]</a>    <span class="k">def</span> <span class="nf">rule_dot2</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">dag</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">list</span><span class="p">)</span>
        <span class="n">visited</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="n">preselect</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>

        <span class="k">def</span> <span class="nf">preselect_parents</span><span class="p">(</span><span class="n">job</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">parent</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">depending</span><span class="p">[</span><span class="n">job</span><span class="p">]:</span>
                <span class="k">if</span> <span class="n">parent</span> <span class="ow">in</span> <span class="n">preselect</span><span class="p">:</span>
                    <span class="k">continue</span>
                <span class="n">preselect</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">parent</span><span class="p">)</span>
                <span class="n">preselect_parents</span><span class="p">(</span><span class="n">parent</span><span class="p">)</span>

        <span class="k">def</span> <span class="nf">build_ruledag</span><span class="p">(</span><span class="n">job</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">job</span><span class="p">:</span> <span class="n">job</span><span class="o">.</span><span class="n">rule</span><span class="o">.</span><span class="n">name</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">job</span> <span class="ow">in</span> <span class="n">visited</span><span class="p">:</span>
                <span class="k">return</span>
            <span class="n">visited</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">job</span><span class="p">)</span>
            <span class="n">deps</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dependencies</span><span class="p">[</span><span class="n">job</span><span class="p">],</span> <span class="n">key</span><span class="o">=</span><span class="n">key</span><span class="p">)</span>
            <span class="n">deps</span> <span class="o">=</span> <span class="p">[(</span><span class="n">group</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">if</span> <span class="n">preselect</span><span class="o">.</span><span class="n">isdisjoint</span><span class="p">(</span><span class="n">group</span><span class="p">)</span> <span class="k">else</span>
                     <span class="n">preselect</span><span class="o">.</span><span class="n">intersection</span><span class="p">(</span><span class="n">group</span><span class="p">)</span><span class="o">.</span><span class="n">pop</span><span class="p">())</span>
                    <span class="k">for</span> <span class="n">group</span> <span class="ow">in</span> <span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">g</span><span class="p">)</span> <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">g</span> <span class="ow">in</span> <span class="n">groupby</span><span class="p">(</span><span class="n">deps</span><span class="p">,</span> <span class="n">key</span><span class="p">))]</span>
            <span class="n">dag</span><span class="p">[</span><span class="n">job</span><span class="p">]</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">deps</span><span class="p">)</span>
            <span class="n">preselect_parents</span><span class="p">(</span><span class="n">job</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">dep</span> <span class="ow">in</span> <span class="n">deps</span><span class="p">:</span>
                <span class="n">build_ruledag</span><span class="p">(</span><span class="n">dep</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">job</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">targetjobs</span><span class="p">:</span>
            <span class="n">build_ruledag</span><span class="p">(</span><span class="n">job</span><span class="p">)</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dot</span><span class="p">(</span><span class="n">dag</span><span class="o">.</span><span class="n">keys</span><span class="p">(),</span>
                         <span class="n">print_wildcards</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                         <span class="n">print_types</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                         <span class="n">dag</span><span class="o">=</span><span class="n">dag</span><span class="p">)</span></div>

<div class="viewcode-block" id="DAG.rule_dot"><a class="viewcode-back" href="../../api_reference/internal/snakemake.html#snakemake.dag.DAG.rule_dot">[docs]</a>    <span class="k">def</span> <span class="nf">rule_dot</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">graph</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">set</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">job</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">jobs</span><span class="p">:</span>
            <span class="n">graph</span><span class="p">[</span><span class="n">job</span><span class="o">.</span><span class="n">rule</span><span class="p">]</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">dep</span><span class="o">.</span><span class="n">rule</span> <span class="k">for</span> <span class="n">dep</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">dependencies</span><span class="p">[</span><span class="n">job</span><span class="p">])</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dot</span><span class="p">(</span><span class="n">graph</span><span class="p">)</span></div>

<div class="viewcode-block" id="DAG.dot"><a class="viewcode-back" href="../../api_reference/internal/snakemake.html#snakemake.dag.DAG.dot">[docs]</a>    <span class="k">def</span> <span class="nf">dot</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">def</span> <span class="nf">node2style</span><span class="p">(</span><span class="n">job</span><span class="p">):</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">needrun</span><span class="p">(</span><span class="n">job</span><span class="p">):</span>
                <span class="k">return</span> <span class="s2">&quot;rounded,dashed&quot;</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dynamic</span><span class="p">(</span><span class="n">job</span><span class="p">)</span> <span class="ow">or</span> <span class="n">job</span><span class="o">.</span><span class="n">dynamic_input</span><span class="p">:</span>
                <span class="k">return</span> <span class="s2">&quot;rounded,dotted&quot;</span>
            <span class="k">return</span> <span class="s2">&quot;rounded&quot;</span>

        <span class="k">def</span> <span class="nf">format_wildcard</span><span class="p">(</span><span class="n">wildcard</span><span class="p">):</span>
            <span class="n">name</span><span class="p">,</span> <span class="n">value</span> <span class="o">=</span> <span class="n">wildcard</span>
            <span class="k">if</span> <span class="n">DYNAMIC_FILL</span> <span class="ow">in</span> <span class="n">value</span><span class="p">:</span>
                <span class="n">value</span> <span class="o">=</span> <span class="s2">&quot;...&quot;</span>
            <span class="k">return</span> <span class="s2">&quot;</span><span class="si">{}</span><span class="s2">: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>

        <span class="n">node2rule</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">job</span><span class="p">:</span> <span class="n">job</span><span class="o">.</span><span class="n">rule</span>
        <span class="n">node2label</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">job</span><span class="p">:</span> <span class="s2">&quot;</span><span class="se">\\</span><span class="s2">n&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">chain</span><span class="p">([</span>
            <span class="n">job</span><span class="o">.</span><span class="n">rule</span><span class="o">.</span><span class="n">name</span>
        <span class="p">],</span> <span class="nb">sorted</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="n">format_wildcard</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">new_wildcards</span><span class="p">(</span><span class="n">job</span><span class="p">)))))</span>

        <span class="n">dag</span> <span class="o">=</span> <span class="p">{</span><span class="n">job</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">dependencies</span><span class="p">[</span><span class="n">job</span><span class="p">]</span> <span class="k">for</span> <span class="n">job</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">jobs</span><span class="p">}</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dot</span><span class="p">(</span><span class="n">dag</span><span class="p">,</span>
                         <span class="n">node2rule</span><span class="o">=</span><span class="n">node2rule</span><span class="p">,</span>
                         <span class="n">node2style</span><span class="o">=</span><span class="n">node2style</span><span class="p">,</span>
                         <span class="n">node2label</span><span class="o">=</span><span class="n">node2label</span><span class="p">)</span></div>

    <span class="k">def</span> <span class="nf">_dot</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
             <span class="n">graph</span><span class="p">,</span>
             <span class="n">node2rule</span><span class="o">=</span><span class="k">lambda</span> <span class="n">node</span><span class="p">:</span> <span class="n">node</span><span class="p">,</span>
             <span class="n">node2style</span><span class="o">=</span><span class="k">lambda</span> <span class="n">node</span><span class="p">:</span> <span class="s2">&quot;rounded&quot;</span><span class="p">,</span>
             <span class="n">node2label</span><span class="o">=</span><span class="k">lambda</span> <span class="n">node</span><span class="p">:</span> <span class="n">node</span><span class="p">):</span>

        <span class="c1"># color rules</span>
        <span class="n">huefactor</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">/</span> <span class="p">(</span><span class="mi">3</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rules</span><span class="p">))</span>
        <span class="n">rulecolor</span> <span class="o">=</span> <span class="p">{</span>
            <span class="n">rule</span><span class="p">:</span> <span class="s2">&quot;</span><span class="si">{:.2f}</span><span class="s2"> 0.6 0.85&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">i</span> <span class="o">*</span> <span class="n">huefactor</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">rule</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rules</span><span class="p">)</span>
        <span class="p">}</span>

        <span class="c1"># markup</span>
        <span class="n">node_markup</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="se">\t</span><span class="si">{}</span><span class="s1">[label = &quot;</span><span class="si">{}</span><span class="s1">&quot;, color = &quot;</span><span class="si">{}</span><span class="s1">&quot;, style=&quot;</span><span class="si">{}</span><span class="s1">&quot;];&#39;</span><span class="o">.</span><span class="n">format</span>
        <span class="n">edge_markup</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="se">\t</span><span class="si">{}</span><span class="s2"> -&gt; </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span>

        <span class="c1"># node ids</span>
        <span class="n">ids</span> <span class="o">=</span> <span class="p">{</span><span class="n">node</span><span class="p">:</span> <span class="n">i</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">node</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">graph</span><span class="p">)}</span>

        <span class="c1"># calculate nodes</span>
        <span class="n">nodes</span> <span class="o">=</span> <span class="p">[</span><span class="n">node_markup</span><span class="p">(</span><span class="n">ids</span><span class="p">[</span><span class="n">node</span><span class="p">],</span> <span class="n">node2label</span><span class="p">(</span><span class="n">node</span><span class="p">),</span>
                             <span class="n">rulecolor</span><span class="p">[</span><span class="n">node2rule</span><span class="p">(</span><span class="n">node</span><span class="p">)],</span> <span class="n">node2style</span><span class="p">(</span><span class="n">node</span><span class="p">))</span>
                 <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">graph</span><span class="p">]</span>
        <span class="c1"># calculate edges</span>
        <span class="n">edges</span> <span class="o">=</span> <span class="p">[</span><span class="n">edge_markup</span><span class="p">(</span><span class="n">ids</span><span class="p">[</span><span class="n">dep</span><span class="p">],</span> <span class="n">ids</span><span class="p">[</span><span class="n">node</span><span class="p">])</span>
                 <span class="k">for</span> <span class="n">node</span><span class="p">,</span> <span class="n">deps</span> <span class="ow">in</span> <span class="n">graph</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">for</span> <span class="n">dep</span> <span class="ow">in</span> <span class="n">deps</span><span class="p">]</span>

        <span class="k">return</span> <span class="n">textwrap</span><span class="o">.</span><span class="n">dedent</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;</span><span class="se">\</span>
<span class="s2">            digraph snakemake_dag {{</span>
<span class="s2">                graph[bgcolor=white, margin=0];</span>
<span class="s2">                node[shape=box, style=rounded, fontname=sans, </span><span class="se">\</span>
<span class="s2">                fontsize=10, penwidth=2];</span>
<span class="s2">                edge[penwidth=2, color=grey];</span>
<span class="s2">            </span><span class="si">{items}</span><span class="s2"></span>
<span class="s2">            }}</span><span class="se">\</span>
<span class="s2">            &quot;&quot;&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">items</span><span class="o">=</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">nodes</span> <span class="o">+</span> <span class="n">edges</span><span class="p">))</span>

<div class="viewcode-block" id="DAG.summary"><a class="viewcode-back" href="../../api_reference/internal/snakemake.html#snakemake.dag.DAG.summary">[docs]</a>    <span class="k">def</span> <span class="nf">summary</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">detailed</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">detailed</span><span class="p">:</span>
            <span class="k">yield</span> <span class="s2">&quot;output_file</span><span class="se">\t</span><span class="s2">date</span><span class="se">\t</span><span class="s2">rule</span><span class="se">\t</span><span class="s2">version</span><span class="se">\t</span><span class="s2">log-file(s)</span><span class="se">\t</span><span class="s2">input-file(s)</span><span class="se">\t</span><span class="s2">shellcmd</span><span class="se">\t</span><span class="s2">status</span><span class="se">\t</span><span class="s2">plan&quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">yield</span> <span class="s2">&quot;output_file</span><span class="se">\t</span><span class="s2">date</span><span class="se">\t</span><span class="s2">rule</span><span class="se">\t</span><span class="s2">version</span><span class="se">\t</span><span class="s2">log-file(s)</span><span class="se">\t</span><span class="s2">status</span><span class="se">\t</span><span class="s2">plan&quot;</span>

        <span class="k">for</span> <span class="n">job</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">jobs</span><span class="p">:</span>
            <span class="n">output</span> <span class="o">=</span> <span class="n">job</span><span class="o">.</span><span class="n">rule</span><span class="o">.</span><span class="n">output</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dynamic</span><span class="p">(</span>
                <span class="n">job</span><span class="p">)</span> <span class="k">else</span> <span class="n">job</span><span class="o">.</span><span class="n">expanded_output</span>
            <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">output</span><span class="p">:</span>
                <span class="n">rule</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">workflow</span><span class="o">.</span><span class="n">persistence</span><span class="o">.</span><span class="n">rule</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
                <span class="n">rule</span> <span class="o">=</span> <span class="s2">&quot;-&quot;</span> <span class="k">if</span> <span class="n">rule</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">rule</span>

                <span class="n">version</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">workflow</span><span class="o">.</span><span class="n">persistence</span><span class="o">.</span><span class="n">version</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
                <span class="n">version</span> <span class="o">=</span> <span class="s2">&quot;-&quot;</span> <span class="k">if</span> <span class="n">version</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="nb">str</span><span class="p">(</span><span class="n">version</span><span class="p">)</span>

                <span class="n">date</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">ctime</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">mtime</span><span class="p">)</span> <span class="k">if</span> <span class="n">f</span><span class="o">.</span><span class="n">exists</span> <span class="k">else</span> <span class="s2">&quot;-&quot;</span>

                <span class="n">pending</span> <span class="o">=</span> <span class="s2">&quot;update pending&quot;</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">reason</span><span class="p">(</span><span class="n">job</span><span class="p">)</span> <span class="k">else</span> <span class="s2">&quot;no update&quot;</span>

                <span class="n">log</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">workflow</span><span class="o">.</span><span class="n">persistence</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
                <span class="n">log</span> <span class="o">=</span> <span class="s2">&quot;-&quot;</span> <span class="k">if</span> <span class="n">log</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="s2">&quot;,&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">log</span><span class="p">)</span>

                <span class="nb">input</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">workflow</span><span class="o">.</span><span class="n">persistence</span><span class="o">.</span><span class="n">input</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
                <span class="nb">input</span> <span class="o">=</span> <span class="s2">&quot;-&quot;</span> <span class="k">if</span> <span class="nb">input</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="s2">&quot;,&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">input</span><span class="p">)</span>

                <span class="n">shellcmd</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">workflow</span><span class="o">.</span><span class="n">persistence</span><span class="o">.</span><span class="n">shellcmd</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
                <span class="n">shellcmd</span> <span class="o">=</span> <span class="s2">&quot;-&quot;</span> <span class="k">if</span> <span class="n">shellcmd</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">shellcmd</span>
                <span class="c1"># remove new line characters, leading and trailing whitespace</span>
                <span class="n">shellcmd</span> <span class="o">=</span> <span class="n">shellcmd</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,</span> <span class="s2">&quot;; &quot;</span><span class="p">)</span>

                <span class="n">status</span> <span class="o">=</span> <span class="s2">&quot;ok&quot;</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">f</span><span class="o">.</span><span class="n">exists</span><span class="p">:</span>
                    <span class="n">status</span> <span class="o">=</span> <span class="s2">&quot;missing&quot;</span>
                <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">reason</span><span class="p">(</span><span class="n">job</span><span class="p">)</span><span class="o">.</span><span class="n">updated_input</span><span class="p">:</span>
                    <span class="n">status</span> <span class="o">=</span> <span class="s2">&quot;updated input files&quot;</span>
                <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">workflow</span><span class="o">.</span><span class="n">persistence</span><span class="o">.</span><span class="n">version_changed</span><span class="p">(</span><span class="n">job</span><span class="p">,</span> <span class="n">file</span><span class="o">=</span><span class="n">f</span><span class="p">):</span>
                    <span class="n">status</span> <span class="o">=</span> <span class="s2">&quot;version changed to </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">job</span><span class="o">.</span><span class="n">rule</span><span class="o">.</span><span class="n">version</span><span class="p">)</span>
                <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">workflow</span><span class="o">.</span><span class="n">persistence</span><span class="o">.</span><span class="n">code_changed</span><span class="p">(</span><span class="n">job</span><span class="p">,</span> <span class="n">file</span><span class="o">=</span><span class="n">f</span><span class="p">):</span>
                    <span class="n">status</span> <span class="o">=</span> <span class="s2">&quot;rule implementation changed&quot;</span>
                <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">workflow</span><span class="o">.</span><span class="n">persistence</span><span class="o">.</span><span class="n">input_changed</span><span class="p">(</span><span class="n">job</span><span class="p">,</span> <span class="n">file</span><span class="o">=</span><span class="n">f</span><span class="p">):</span>
                    <span class="n">status</span> <span class="o">=</span> <span class="s2">&quot;set of input files changed&quot;</span>
                <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">workflow</span><span class="o">.</span><span class="n">persistence</span><span class="o">.</span><span class="n">params_changed</span><span class="p">(</span><span class="n">job</span><span class="p">,</span> <span class="n">file</span><span class="o">=</span><span class="n">f</span><span class="p">):</span>
                    <span class="n">status</span> <span class="o">=</span> <span class="s2">&quot;params changed&quot;</span>
                <span class="k">if</span> <span class="n">detailed</span><span class="p">:</span>
                    <span class="k">yield</span> <span class="s2">&quot;</span><span class="se">\t</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">((</span><span class="n">f</span><span class="p">,</span> <span class="n">date</span><span class="p">,</span> <span class="n">rule</span><span class="p">,</span> <span class="n">version</span><span class="p">,</span> <span class="n">log</span><span class="p">,</span> <span class="nb">input</span><span class="p">,</span> <span class="n">shellcmd</span><span class="p">,</span>
                                     <span class="n">status</span><span class="p">,</span> <span class="n">pending</span><span class="p">))</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">yield</span> <span class="s2">&quot;</span><span class="se">\t</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">((</span><span class="n">f</span><span class="p">,</span> <span class="n">date</span><span class="p">,</span> <span class="n">rule</span><span class="p">,</span> <span class="n">version</span><span class="p">,</span> <span class="n">log</span><span class="p">,</span> <span class="n">status</span><span class="p">,</span> <span class="n">pending</span><span class="p">))</span></div>

<div class="viewcode-block" id="DAG.archive"><a class="viewcode-back" href="../../api_reference/internal/snakemake.html#snakemake.dag.DAG.archive">[docs]</a>    <span class="k">def</span> <span class="nf">archive</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Archives workflow such that it can be re-run on a different system.</span>

<span class="sd">        Archiving includes git versioned files (i.e. Snakefiles, config files, ...),</span>
<span class="sd">        ancestral input files and conda environments.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">path</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;.tar&quot;</span><span class="p">):</span>
            <span class="n">mode</span> <span class="o">=</span> <span class="s2">&quot;x&quot;</span>
        <span class="k">elif</span> <span class="n">path</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;tar.bz2&quot;</span><span class="p">):</span>
            <span class="n">mode</span> <span class="o">=</span> <span class="s2">&quot;x:bz2&quot;</span>
        <span class="k">elif</span> <span class="n">path</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;tar.xz&quot;</span><span class="p">):</span>
            <span class="n">mode</span> <span class="o">=</span> <span class="s2">&quot;x:xz&quot;</span>
        <span class="k">elif</span> <span class="n">path</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;tar.gz&quot;</span><span class="p">):</span>
            <span class="n">mode</span> <span class="o">=</span> <span class="s2">&quot;x:gz&quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">WorkflowError</span><span class="p">(</span><span class="s2">&quot;Unsupported archive format &quot;</span>
                                <span class="s2">&quot;(supported: .tar, .tar.gz, .tar.bz2, .tar.xz)&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
            <span class="k">raise</span> <span class="n">WorkflowError</span><span class="p">(</span><span class="s2">&quot;Archive already exists:</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="n">path</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">create_conda_envs</span><span class="p">(</span><span class="n">forceall</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">workdir</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">()))</span>
            <span class="k">with</span> <span class="n">tarfile</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="n">mode</span><span class="p">,</span> <span class="n">dereference</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> <span class="k">as</span> <span class="n">archive</span><span class="p">:</span>
                <span class="n">archived</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>

                <span class="k">def</span> <span class="nf">add</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
                    <span class="k">if</span> <span class="n">workdir</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">Path</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">path</span><span class="p">))</span><span class="o">.</span><span class="n">parents</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Path </span><span class="si">{}</span><span class="s2"> cannot be archived: &quot;</span>
                                       <span class="s2">&quot;not within working directory.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">path</span><span class="p">))</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">f</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">relpath</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">f</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">archived</span><span class="p">:</span>
                            <span class="n">archive</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
                            <span class="n">archived</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;archived &quot;</span> <span class="o">+</span> <span class="n">f</span><span class="p">)</span>

                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Archiving snakefiles, scripts and files under &quot;</span>
                            <span class="s2">&quot;version control...&quot;</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">workflow</span><span class="o">.</span><span class="n">get_sources</span><span class="p">():</span>
                    <span class="n">add</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>

                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Archiving external input files...&quot;</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">job</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">jobs</span><span class="p">:</span>
                    <span class="c1"># input files</span>
                    <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">job</span><span class="o">.</span><span class="n">input</span><span class="p">:</span>
                        <span class="k">if</span> <span class="ow">not</span> <span class="nb">any</span><span class="p">(</span><span class="n">f</span> <span class="ow">in</span> <span class="n">files</span> <span class="k">for</span> <span class="n">files</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">dependencies</span><span class="p">[</span><span class="n">job</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">()):</span>
                            <span class="c1"># this is an input file that is not created by any job</span>
                            <span class="n">add</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>

                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Archiving conda environments...&quot;</span><span class="p">)</span>
                <span class="n">envs</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
                <span class="k">for</span> <span class="n">job</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">jobs</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">job</span><span class="o">.</span><span class="n">conda_env_file</span><span class="p">:</span>
                        <span class="n">env_archive</span> <span class="o">=</span> <span class="n">job</span><span class="o">.</span><span class="n">archive_conda_env</span><span class="p">()</span>
                        <span class="n">envs</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">env_archive</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">env</span> <span class="ow">in</span> <span class="n">envs</span><span class="p">:</span>
                    <span class="n">add</span><span class="p">(</span><span class="n">env</span><span class="p">)</span>

        <span class="k">except</span> <span class="p">(</span><span class="ne">Exception</span><span class="p">,</span> <span class="ne">BaseException</span><span class="p">)</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
            <span class="k">raise</span> <span class="n">e</span></div>


<div class="viewcode-block" id="DAG.clean"><a class="viewcode-back" href="../../api_reference/internal/snakemake.html#snakemake.dag.DAG.clean">[docs]</a>    <span class="k">def</span> <span class="nf">clean</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">only_temp</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">dryrun</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Removes files generated by the workflow.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">job</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">jobs</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">job</span><span class="o">.</span><span class="n">output</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">only_temp</span> <span class="ow">or</span> <span class="n">is_flagged</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="s2">&quot;temp&quot;</span><span class="p">):</span>
                    <span class="c1"># The reason for the second check is that dangling</span>
                    <span class="c1"># symlinks fail f.exists.</span>
                    <span class="k">if</span> <span class="n">f</span><span class="o">.</span><span class="n">exists</span> <span class="ow">or</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">islink</span><span class="p">(</span><span class="n">f</span><span class="p">):</span>
                        <span class="k">if</span> <span class="n">f</span><span class="o">.</span><span class="n">protected</span><span class="p">:</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Skipping write-protected file </span><span class="si">{}</span><span class="s2">.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">f</span><span class="p">))</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;Deleting </span><span class="si">{}</span><span class="s2">&quot;</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">dryrun</span> <span class="k">else</span> <span class="s2">&quot;Would delete </span><span class="si">{}</span><span class="s2">&quot;</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">msg</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">f</span><span class="p">))</span>
                            <span class="k">if</span> <span class="ow">not</span> <span class="n">dryrun</span><span class="p">:</span>
                                <span class="c1"># Remove non-empty dirs if flagged as temp()</span>
                                <span class="n">f</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">remove_non_empty_dir</span><span class="o">=</span><span class="n">only_temp</span><span class="p">)</span></div>

<div class="viewcode-block" id="DAG.list_untracked"><a class="viewcode-back" href="../../api_reference/internal/snakemake.html#snakemake.dag.DAG.list_untracked">[docs]</a>    <span class="k">def</span> <span class="nf">list_untracked</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;List files in the workdir that are not in the dag.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">used_files</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="n">files_in_cwd</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">job</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">jobs</span><span class="p">:</span>
            <span class="n">used_files</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">relpath</span><span class="p">(</span><span class="n">file</span><span class="p">)</span> <span class="k">for</span> <span class="n">file</span> <span class="ow">in</span> <span class="n">chain</span><span class="p">(</span><span class="n">job</span><span class="o">.</span><span class="n">local_input</span><span class="p">,</span> <span class="n">job</span><span class="o">.</span><span class="n">local_output</span><span class="p">,</span> <span class="n">job</span><span class="o">.</span><span class="n">log</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">root</span><span class="p">,</span> <span class="n">dirs</span><span class="p">,</span> <span class="n">files</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">walk</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">()):</span>
            <span class="c1"># Ignore hidden files and don&#39;t traverse into hidden dirs</span>
            <span class="n">files_in_cwd</span><span class="o">.</span><span class="n">update</span><span class="p">([</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">relpath</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">root</span><span class="p">,</span> <span class="n">f</span><span class="p">))</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">files</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">f</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;.&#39;</span><span class="p">])</span>
            <span class="n">dirs</span><span class="p">[:]</span> <span class="o">=</span> <span class="p">[</span><span class="n">d</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">dirs</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">d</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;.&#39;</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">files_in_cwd</span> <span class="o">-</span> <span class="n">used_files</span><span class="p">)):</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">f</span><span class="p">)</span></div>

<div class="viewcode-block" id="DAG.d3dag"><a class="viewcode-back" href="../../api_reference/internal/snakemake.html#snakemake.dag.DAG.d3dag">[docs]</a>    <span class="k">def</span> <span class="nf">d3dag</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">max_jobs</span><span class="o">=</span><span class="mi">10000</span><span class="p">):</span>
        <span class="k">def</span> <span class="nf">node</span><span class="p">(</span><span class="n">job</span><span class="p">):</span>
            <span class="n">jobid</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">jobid</span><span class="p">(</span><span class="n">job</span><span class="p">)</span>
            <span class="k">return</span> <span class="p">{</span>
                <span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="n">jobid</span><span class="p">,</span>
                <span class="s2">&quot;value&quot;</span><span class="p">:</span> <span class="p">{</span>
                    <span class="s2">&quot;jobid&quot;</span><span class="p">:</span> <span class="n">jobid</span><span class="p">,</span>
                    <span class="s2">&quot;label&quot;</span><span class="p">:</span> <span class="n">job</span><span class="o">.</span><span class="n">rule</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
                    <span class="s2">&quot;rule&quot;</span><span class="p">:</span> <span class="n">job</span><span class="o">.</span><span class="n">rule</span><span class="o">.</span><span class="n">name</span>
                <span class="p">}</span>
            <span class="p">}</span>

        <span class="k">def</span> <span class="nf">edge</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">):</span>
            <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;u&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">jobid</span><span class="p">(</span><span class="n">a</span><span class="p">),</span> <span class="s2">&quot;v&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">jobid</span><span class="p">(</span><span class="n">b</span><span class="p">)}</span>

        <span class="n">jobs</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">jobs</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">jobs</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">max_jobs</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                <span class="s2">&quot;Job-DAG is too large for visualization (&gt;</span><span class="si">{}</span><span class="s2"> jobs).&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="n">max_jobs</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">d3dag</span><span class="p">(</span><span class="n">nodes</span><span class="o">=</span><span class="p">[</span><span class="n">node</span><span class="p">(</span><span class="n">job</span><span class="p">)</span> <span class="k">for</span> <span class="n">job</span> <span class="ow">in</span> <span class="n">jobs</span><span class="p">],</span>
                         <span class="n">edges</span><span class="o">=</span><span class="p">[</span><span class="n">edge</span><span class="p">(</span><span class="n">dep</span><span class="p">,</span> <span class="n">job</span><span class="p">)</span>
                                <span class="k">for</span> <span class="n">job</span> <span class="ow">in</span> <span class="n">jobs</span> <span class="k">for</span> <span class="n">dep</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">dependencies</span><span class="p">[</span>
                                    <span class="n">job</span><span class="p">]</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">needrun</span><span class="p">(</span><span class="n">dep</span><span class="p">)])</span></div>

<div class="viewcode-block" id="DAG.stats"><a class="viewcode-back" href="../../api_reference/internal/snakemake.html#snakemake.dag.DAG.stats">[docs]</a>    <span class="k">def</span> <span class="nf">stats</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">rules</span> <span class="o">=</span> <span class="n">Counter</span><span class="p">()</span>
        <span class="n">rules</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">job</span><span class="o">.</span><span class="n">rule</span> <span class="k">for</span> <span class="n">job</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">needrun_jobs</span><span class="p">)</span>
        <span class="n">rules</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">job</span><span class="o">.</span><span class="n">rule</span> <span class="k">for</span> <span class="n">job</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">finished_jobs</span><span class="p">)</span>
        <span class="k">yield</span> <span class="s2">&quot;Job counts:&quot;</span>
        <span class="k">yield</span> <span class="s2">&quot;</span><span class="se">\t</span><span class="s2">count</span><span class="se">\t</span><span class="s2">jobs&quot;</span>
        <span class="k">for</span> <span class="n">rule</span><span class="p">,</span> <span class="n">count</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">rules</span><span class="o">.</span><span class="n">most_common</span><span class="p">(),</span>
                                  <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">item</span><span class="p">:</span> <span class="n">item</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">name</span><span class="p">):</span>
            <span class="k">yield</span> <span class="s2">&quot;</span><span class="se">\t</span><span class="si">{}</span><span class="se">\t</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">count</span><span class="p">,</span> <span class="n">rule</span><span class="p">)</span>
        <span class="k">yield</span> <span class="s2">&quot;</span><span class="se">\t</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="p">))</span></div>

    <span class="k">def</span> <span class="nf">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">dot</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">__len__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_len</span></div>
</pre></div>

           </div>
           
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2014-2016, Johannes Koester

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>