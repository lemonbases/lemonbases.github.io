

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>snakemake.executors &mdash; Snakemake 5.6.0+8.g89bc383.dirty documentation</title>
  

  
  
  
  

  
  <script type="text/javascript" src="../../_static/js/modernizr.min.js"></script>
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
        <script type="text/javascript" src="../../_static/jquery.js"></script>
        <script type="text/javascript" src="../../_static/underscore.js"></script>
        <script type="text/javascript" src="../../_static/doctools.js"></script>
        <script type="text/javascript" src="../../_static/language_data.js"></script>
    
    <script type="text/javascript" src="../../_static/js/theme.js"></script>

    

  
  <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/sphinx-argparse.css" type="text/css" />
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../index.html" class="icon icon-home"> Snakemake
          

          
          </a>

          
            
            
              <div class="version">
                5.6.0+8.g89bc383.dirty
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">Getting started</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../getting_started/installation.html">安装</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../getting_started/examples.html">Examples</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../tutorial/tutorial.html">Snakemake Tutorial</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../tutorial/short.html">Short tutorial</a></li>
</ul>
<p class="caption"><span class="caption-text">Executing workflows</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../executable.html">Executing Snakemake</a></li>
</ul>
<p class="caption"><span class="caption-text">Defining workflows</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../snakefiles/writing_snakefiles.html">Writing Workflows</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../snakefiles/rules.html">Rules</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../snakefiles/configuration.html">Configuration</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../snakefiles/modularization.html">Modularization</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../snakefiles/remote_files.html">Remote files</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../snakefiles/utils.html">Utils</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../snakefiles/deployment.html">Distribution and Reproducibility</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../snakefiles/reporting.html">Reports</a></li>
</ul>
<p class="caption"><span class="caption-text">API Reference</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../api_reference/snakemake.html">The Snakemake API</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../api_reference/snakemake_utils.html">Additional utils</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../api_reference/internal/modules.html">Internal API</a></li>
</ul>
<p class="caption"><span class="caption-text">Project Info</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../project_info/citations.html">Citing and Citations</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../project_info/more_resources.html">More Resources</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../project_info/faq.html">Frequently Asked Questions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../project_info/contributing.html">Contributing</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../project_info/authors.html">Credits</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../project_info/history.html">Change Log</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../project_info/license.html">License</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">Snakemake</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../index.html">Docs</a> &raquo;</li>
        
          <li><a href="../index.html">Module code</a> &raquo;</li>
        
          <li><a href="../snakemake.html">snakemake</a> &raquo;</li>
        
      <li>snakemake.executors</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <h1>Source code for snakemake.executors</h1><div class="highlight"><pre>
<span></span><span class="n">__author__</span> <span class="o">=</span> <span class="s2">&quot;Johannes Köster&quot;</span>
<span class="n">__contributors__</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;David Alexander&quot;</span><span class="p">]</span>
<span class="n">__copyright__</span> <span class="o">=</span> <span class="s2">&quot;Copyright 2015, Johannes Köster&quot;</span>
<span class="n">__email__</span> <span class="o">=</span> <span class="s2">&quot;koester@jimmy.harvard.edu&quot;</span>
<span class="n">__license__</span> <span class="o">=</span> <span class="s2">&quot;MIT&quot;</span>

<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">contextlib</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">datetime</span>
<span class="kn">import</span> <span class="nn">json</span>
<span class="kn">import</span> <span class="nn">textwrap</span>
<span class="kn">import</span> <span class="nn">stat</span>
<span class="kn">import</span> <span class="nn">shutil</span>
<span class="kn">import</span> <span class="nn">shlex</span>
<span class="kn">import</span> <span class="nn">threading</span>
<span class="kn">import</span> <span class="nn">concurrent.futures</span>
<span class="kn">import</span> <span class="nn">subprocess</span>
<span class="kn">import</span> <span class="nn">signal</span>
<span class="kn">from</span> <span class="nn">functools</span> <span class="k">import</span> <span class="n">partial</span>
<span class="kn">from</span> <span class="nn">itertools</span> <span class="k">import</span> <span class="n">chain</span>
<span class="kn">from</span> <span class="nn">collections</span> <span class="k">import</span> <span class="n">namedtuple</span>
<span class="kn">from</span> <span class="nn">tempfile</span> <span class="k">import</span> <span class="n">mkdtemp</span>
<span class="kn">import</span> <span class="nn">random</span>
<span class="kn">import</span> <span class="nn">base64</span>
<span class="kn">import</span> <span class="nn">uuid</span>

<span class="kn">from</span> <span class="nn">snakemake.jobs</span> <span class="k">import</span> <span class="n">Job</span>
<span class="kn">from</span> <span class="nn">snakemake.shell</span> <span class="k">import</span> <span class="n">shell</span>
<span class="kn">from</span> <span class="nn">snakemake.logging</span> <span class="k">import</span> <span class="n">logger</span>
<span class="kn">from</span> <span class="nn">snakemake.stats</span> <span class="k">import</span> <span class="n">Stats</span>
<span class="kn">from</span> <span class="nn">snakemake.utils</span> <span class="k">import</span> <span class="nb">format</span><span class="p">,</span> <span class="n">Unformattable</span><span class="p">,</span> <span class="n">makedirs</span>
<span class="kn">from</span> <span class="nn">snakemake.io</span> <span class="k">import</span> <span class="n">get_wildcard_names</span><span class="p">,</span> <span class="n">Wildcards</span>
<span class="kn">from</span> <span class="nn">snakemake.exceptions</span> <span class="k">import</span> <span class="n">print_exception</span><span class="p">,</span> <span class="n">get_exception_origin</span>
<span class="kn">from</span> <span class="nn">snakemake.exceptions</span> <span class="k">import</span> <span class="n">format_error</span><span class="p">,</span> <span class="n">RuleException</span><span class="p">,</span> <span class="n">log_verbose_traceback</span>
<span class="kn">from</span> <span class="nn">snakemake.exceptions</span> <span class="k">import</span> <span class="n">ProtectedOutputException</span><span class="p">,</span> <span class="n">WorkflowError</span><span class="p">,</span> <span class="n">ImproperShadowException</span><span class="p">,</span> <span class="n">SpawnedJobError</span>
<span class="kn">from</span> <span class="nn">snakemake.common</span> <span class="k">import</span> <span class="n">Mode</span><span class="p">,</span> <span class="n">__version__</span><span class="p">,</span> <span class="n">get_container_image</span><span class="p">,</span> <span class="n">get_uuid</span>


<div class="viewcode-block" id="sleep"><a class="viewcode-back" href="../../api_reference/internal/snakemake.html#snakemake.executors.sleep">[docs]</a><span class="k">def</span> <span class="nf">sleep</span><span class="p">():</span>
    <span class="c1"># do not sleep on CI. In that case we just want to quickly test everything.</span>
    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;CIRCLECI&quot;</span><span class="p">)</span> <span class="o">!=</span> <span class="s2">&quot;true&quot;</span><span class="p">:</span>
        <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span></div>


<div class="viewcode-block" id="AbstractExecutor"><a class="viewcode-back" href="../../api_reference/internal/snakemake.html#snakemake.executors.AbstractExecutor">[docs]</a><span class="k">class</span> <span class="nc">AbstractExecutor</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">workflow</span><span class="p">,</span> <span class="n">dag</span><span class="p">,</span>
                 <span class="n">printreason</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                 <span class="n">quiet</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                 <span class="n">printshellcmds</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                 <span class="n">printthreads</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                 <span class="n">latency_wait</span><span class="o">=</span><span class="mi">3</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">workflow</span> <span class="o">=</span> <span class="n">workflow</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dag</span> <span class="o">=</span> <span class="n">dag</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">quiet</span> <span class="o">=</span> <span class="n">quiet</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">printreason</span> <span class="o">=</span> <span class="n">printreason</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">printshellcmds</span> <span class="o">=</span> <span class="n">printshellcmds</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">printthreads</span> <span class="o">=</span> <span class="n">printthreads</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">latency_wait</span> <span class="o">=</span> <span class="n">latency_wait</span>

<div class="viewcode-block" id="AbstractExecutor.get_default_remote_provider_args"><a class="viewcode-back" href="../../api_reference/internal/snakemake.html#snakemake.executors.AbstractExecutor.get_default_remote_provider_args">[docs]</a>    <span class="k">def</span> <span class="nf">get_default_remote_provider_args</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">workflow</span><span class="o">.</span><span class="n">default_remote_provider</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">(</span>
                <span class="s2">&quot; --default-remote-provider </span><span class="si">{}</span><span class="s2"> &quot;</span>
                <span class="s2">&quot;--default-remote-prefix </span><span class="si">{}</span><span class="s2"> &quot;</span><span class="p">)</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">workflow</span><span class="o">.</span><span class="n">default_remote_provider</span><span class="o">.</span><span class="vm">__module__</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">workflow</span><span class="o">.</span><span class="n">default_remote_prefix</span><span class="p">)</span>
        <span class="k">return</span> <span class="s2">&quot;&quot;</span></div>
    
<div class="viewcode-block" id="AbstractExecutor.get_default_resources_args"><a class="viewcode-back" href="../../api_reference/internal/snakemake.html#snakemake.executors.AbstractExecutor.get_default_resources_args">[docs]</a>    <span class="k">def</span> <span class="nf">get_default_resources_args</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">workflow</span><span class="o">.</span><span class="n">default_resources</span><span class="o">.</span><span class="n">args</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">args</span> <span class="o">=</span> <span class="s2">&quot; --default-resources </span><span class="si">{}</span><span class="s2"> &quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="s1">&#39;&quot;</span><span class="si">{}</span><span class="s1">&quot;&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">workflow</span><span class="o">.</span><span class="n">default_resources</span><span class="o">.</span><span class="n">args</span><span class="p">)))</span>
            <span class="k">return</span> <span class="n">args</span>
        <span class="k">return</span> <span class="s2">&quot;&quot;</span></div>

<div class="viewcode-block" id="AbstractExecutor.run"><a class="viewcode-back" href="../../api_reference/internal/snakemake.html#snakemake.executors.AbstractExecutor.run">[docs]</a>    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">job</span><span class="p">,</span>
            <span class="n">callback</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="n">submit_callback</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="n">error_callback</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_run</span><span class="p">(</span><span class="n">job</span><span class="p">)</span>
        <span class="n">callback</span><span class="p">(</span><span class="n">job</span><span class="p">)</span></div>

<div class="viewcode-block" id="AbstractExecutor.shutdown"><a class="viewcode-back" href="../../api_reference/internal/snakemake.html#snakemake.executors.AbstractExecutor.shutdown">[docs]</a>    <span class="k">def</span> <span class="nf">shutdown</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">pass</span></div>

<div class="viewcode-block" id="AbstractExecutor.cancel"><a class="viewcode-back" href="../../api_reference/internal/snakemake.html#snakemake.executors.AbstractExecutor.cancel">[docs]</a>    <span class="k">def</span> <span class="nf">cancel</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">pass</span></div>

    <span class="k">def</span> <span class="nf">_run</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">job</span><span class="p">):</span>
        <span class="n">job</span><span class="o">.</span><span class="n">check_protected_output</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">printjob</span><span class="p">(</span><span class="n">job</span><span class="p">)</span>

<div class="viewcode-block" id="AbstractExecutor.rule_prefix"><a class="viewcode-back" href="../../api_reference/internal/snakemake.html#snakemake.executors.AbstractExecutor.rule_prefix">[docs]</a>    <span class="k">def</span> <span class="nf">rule_prefix</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">job</span><span class="p">):</span>
        <span class="k">return</span> <span class="s2">&quot;local &quot;</span> <span class="k">if</span> <span class="n">job</span><span class="o">.</span><span class="n">is_local</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span></div>

<div class="viewcode-block" id="AbstractExecutor.printjob"><a class="viewcode-back" href="../../api_reference/internal/snakemake.html#snakemake.executors.AbstractExecutor.printjob">[docs]</a>    <span class="k">def</span> <span class="nf">printjob</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">job</span><span class="p">):</span>
        <span class="n">job</span><span class="o">.</span><span class="n">log_info</span><span class="p">(</span><span class="n">skip_dynamic</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span></div>

<div class="viewcode-block" id="AbstractExecutor.print_job_error"><a class="viewcode-back" href="../../api_reference/internal/snakemake.html#snakemake.executors.AbstractExecutor.print_job_error">[docs]</a>    <span class="k">def</span> <span class="nf">print_job_error</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">job</span><span class="p">,</span> <span class="n">msg</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">job</span><span class="o">.</span><span class="n">log_error</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div>

<div class="viewcode-block" id="AbstractExecutor.handle_job_success"><a class="viewcode-back" href="../../api_reference/internal/snakemake.html#snakemake.executors.AbstractExecutor.handle_job_success">[docs]</a>    <span class="k">def</span> <span class="nf">handle_job_success</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">job</span><span class="p">):</span>
        <span class="k">pass</span></div>

<div class="viewcode-block" id="AbstractExecutor.handle_job_error"><a class="viewcode-back" href="../../api_reference/internal/snakemake.html#snakemake.executors.AbstractExecutor.handle_job_error">[docs]</a>    <span class="k">def</span> <span class="nf">handle_job_error</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">job</span><span class="p">):</span>
        <span class="k">pass</span></div></div>


<div class="viewcode-block" id="DryrunExecutor"><a class="viewcode-back" href="../../api_reference/internal/snakemake.html#snakemake.executors.DryrunExecutor">[docs]</a><span class="k">class</span> <span class="nc">DryrunExecutor</span><span class="p">(</span><span class="n">AbstractExecutor</span><span class="p">):</span>
    <span class="k">pass</span></div>


<div class="viewcode-block" id="RealExecutor"><a class="viewcode-back" href="../../api_reference/internal/snakemake.html#snakemake.executors.RealExecutor">[docs]</a><span class="k">class</span> <span class="nc">RealExecutor</span><span class="p">(</span><span class="n">AbstractExecutor</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">workflow</span><span class="p">,</span> <span class="n">dag</span><span class="p">,</span>
                 <span class="n">printreason</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                 <span class="n">quiet</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                 <span class="n">printshellcmds</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                 <span class="n">latency_wait</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span>
                 <span class="n">assume_shared_fs</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">workflow</span><span class="p">,</span> <span class="n">dag</span><span class="p">,</span>
                         <span class="n">printreason</span><span class="o">=</span><span class="n">printreason</span><span class="p">,</span>
                         <span class="n">quiet</span><span class="o">=</span><span class="n">quiet</span><span class="p">,</span>
                         <span class="n">printshellcmds</span><span class="o">=</span><span class="n">printshellcmds</span><span class="p">,</span>
                         <span class="n">latency_wait</span><span class="o">=</span><span class="n">latency_wait</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assume_shared_fs</span> <span class="o">=</span> <span class="n">assume_shared_fs</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stats</span> <span class="o">=</span> <span class="n">Stats</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">snakefile</span> <span class="o">=</span> <span class="n">workflow</span><span class="o">.</span><span class="n">snakefile</span>

<div class="viewcode-block" id="RealExecutor.register_job"><a class="viewcode-back" href="../../api_reference/internal/snakemake.html#snakemake.executors.RealExecutor.register_job">[docs]</a>    <span class="k">def</span> <span class="nf">register_job</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">job</span><span class="p">):</span>
        <span class="n">job</span><span class="o">.</span><span class="n">register</span><span class="p">()</span></div>

    <span class="k">def</span> <span class="nf">_run</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">job</span><span class="p">,</span> <span class="n">callback</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">error_callback</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">_run</span><span class="p">(</span><span class="n">job</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">report_job_start</span><span class="p">(</span><span class="n">job</span><span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">register_job</span><span class="p">(</span><span class="n">job</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">IOError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                <span class="s2">&quot;Failed to set marker file for job started (</span><span class="si">{}</span><span class="s2">). &quot;</span>
                <span class="s2">&quot;Snakemake will work, but cannot ensure that output files &quot;</span>
                <span class="s2">&quot;are complete in case of a kill signal or power loss. &quot;</span>
                <span class="s2">&quot;Please ensure write permissions for the &quot;</span>
                <span class="s2">&quot;directory </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">workflow</span><span class="o">.</span><span class="n">persistence</span><span class="o">.</span><span class="n">path</span><span class="p">))</span>

<div class="viewcode-block" id="RealExecutor.handle_job_success"><a class="viewcode-back" href="../../api_reference/internal/snakemake.html#snakemake.executors.RealExecutor.handle_job_success">[docs]</a>    <span class="k">def</span> <span class="nf">handle_job_success</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">job</span><span class="p">,</span>
                           <span class="n">upload_remote</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                           <span class="n">handle_log</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                           <span class="n">handle_touch</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                           <span class="n">ignore_missing_output</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="n">job</span><span class="o">.</span><span class="n">postprocess</span><span class="p">(</span><span class="n">upload_remote</span><span class="o">=</span><span class="n">upload_remote</span><span class="p">,</span>
                        <span class="n">handle_log</span><span class="o">=</span><span class="n">handle_log</span><span class="p">,</span>
                        <span class="n">handle_touch</span><span class="o">=</span><span class="n">handle_touch</span><span class="p">,</span>
                        <span class="n">ignore_missing_output</span><span class="o">=</span><span class="n">ignore_missing_output</span><span class="p">,</span>
                        <span class="n">latency_wait</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">latency_wait</span><span class="p">,</span>
                        <span class="n">assume_shared_fs</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">assume_shared_fs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">report_job_end</span><span class="p">(</span><span class="n">job</span><span class="p">)</span></div>

<div class="viewcode-block" id="RealExecutor.handle_job_error"><a class="viewcode-back" href="../../api_reference/internal/snakemake.html#snakemake.executors.RealExecutor.handle_job_error">[docs]</a>    <span class="k">def</span> <span class="nf">handle_job_error</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">job</span><span class="p">,</span> <span class="n">upload_remote</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="n">job</span><span class="o">.</span><span class="n">postprocess</span><span class="p">(</span><span class="n">error</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                        <span class="n">assume_shared_fs</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">assume_shared_fs</span><span class="p">,</span>
                        <span class="n">latency_wait</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">latency_wait</span><span class="p">)</span></div>

<div class="viewcode-block" id="RealExecutor.format_job_pattern"><a class="viewcode-back" href="../../api_reference/internal/snakemake.html#snakemake.executors.RealExecutor.format_job_pattern">[docs]</a>    <span class="k">def</span> <span class="nf">format_job_pattern</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pattern</span><span class="p">,</span> <span class="n">job</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">overwrite_workdir</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">workflow</span><span class="o">.</span><span class="n">overwrite_workdir</span><span class="p">:</span>
            <span class="n">overwrite_workdir</span><span class="o">.</span><span class="n">extend</span><span class="p">((</span><span class="s2">&quot;--directory&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">workflow</span><span class="o">.</span><span class="n">overwrite_workdir</span><span class="p">))</span>

        <span class="n">overwrite_config</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">workflow</span><span class="o">.</span><span class="n">overwrite_configfile</span><span class="p">:</span>
            <span class="n">overwrite_config</span><span class="o">.</span><span class="n">extend</span><span class="p">((</span><span class="s2">&quot;--configfile&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">workflow</span><span class="o">.</span><span class="n">overwrite_configfile</span><span class="p">))</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">workflow</span><span class="o">.</span><span class="n">config_args</span><span class="p">:</span>
            <span class="n">overwrite_config</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;--config&quot;</span><span class="p">)</span>
            <span class="n">overwrite_config</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">workflow</span><span class="o">.</span><span class="n">config_args</span><span class="p">)</span>

        <span class="n">printshellcmds</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">workflow</span><span class="o">.</span><span class="n">printshellcmds</span><span class="p">:</span>
            <span class="n">printshellcmds</span> <span class="o">=</span> <span class="s2">&quot;-p&quot;</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">job</span><span class="o">.</span><span class="n">is_branched</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">job</span><span class="o">.</span><span class="n">is_updated</span><span class="p">:</span>
            <span class="c1"># Restrict considered rules. This does not work for updated jobs</span>
            <span class="c1"># because they need to be updated in the spawned process as well.</span>
            <span class="n">rules</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;--allowed-rules&quot;</span><span class="p">]</span>
            <span class="n">rules</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">job</span><span class="o">.</span><span class="n">rules</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">rules</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">return</span> <span class="nb">format</span><span class="p">(</span><span class="n">pattern</span><span class="p">,</span>
                      <span class="n">job</span><span class="o">=</span><span class="n">job</span><span class="p">,</span>
                      <span class="n">attempt</span><span class="o">=</span><span class="n">job</span><span class="o">.</span><span class="n">attempt</span><span class="p">,</span>
                      <span class="n">overwrite_workdir</span><span class="o">=</span><span class="n">overwrite_workdir</span><span class="p">,</span>
                      <span class="n">overwrite_config</span><span class="o">=</span><span class="n">overwrite_config</span><span class="p">,</span>
                      <span class="n">printshellcmds</span><span class="o">=</span><span class="n">printshellcmds</span><span class="p">,</span>
                      <span class="n">workflow</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">workflow</span><span class="p">,</span>
                      <span class="n">snakefile</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">snakefile</span><span class="p">,</span>
                      <span class="n">cores</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">cores</span><span class="p">,</span>
                      <span class="n">benchmark_repeats</span><span class="o">=</span><span class="n">job</span><span class="o">.</span><span class="n">benchmark_repeats</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">job</span><span class="o">.</span><span class="n">is_group</span><span class="p">()</span> <span class="k">else</span> <span class="kc">None</span><span class="p">,</span>
                      <span class="n">target</span><span class="o">=</span><span class="n">job</span><span class="o">.</span><span class="n">get_targets</span><span class="p">(),</span>
                      <span class="n">rules</span><span class="o">=</span><span class="n">rules</span><span class="p">,</span>
                      <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div></div>


<div class="viewcode-block" id="TouchExecutor"><a class="viewcode-back" href="../../api_reference/internal/snakemake.html#snakemake.executors.TouchExecutor">[docs]</a><span class="k">class</span> <span class="nc">TouchExecutor</span><span class="p">(</span><span class="n">RealExecutor</span><span class="p">):</span>
<div class="viewcode-block" id="TouchExecutor.run"><a class="viewcode-back" href="../../api_reference/internal/snakemake.html#snakemake.executors.TouchExecutor.run">[docs]</a>    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">job</span><span class="p">,</span>
            <span class="n">callback</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="n">submit_callback</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="n">error_callback</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">_run</span><span class="p">(</span><span class="n">job</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c1">#Touching of output files will be done by handle_job_success</span>
            <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.1</span><span class="p">)</span>
            <span class="n">callback</span><span class="p">(</span><span class="n">job</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">OSError</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
            <span class="n">print_exception</span><span class="p">(</span><span class="n">ex</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">workflow</span><span class="o">.</span><span class="n">linemaps</span><span class="p">)</span>
            <span class="n">error_callback</span><span class="p">(</span><span class="n">job</span><span class="p">)</span></div>

<div class="viewcode-block" id="TouchExecutor.handle_job_success"><a class="viewcode-back" href="../../api_reference/internal/snakemake.html#snakemake.executors.TouchExecutor.handle_job_success">[docs]</a>    <span class="k">def</span> <span class="nf">handle_job_success</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">job</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">handle_job_success</span><span class="p">(</span><span class="n">job</span><span class="p">,</span> <span class="n">ignore_missing_output</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span></div></div>


<span class="n">_ProcessPoolExceptions</span> <span class="o">=</span> <span class="p">(</span><span class="ne">KeyboardInterrupt</span><span class="p">,</span> <span class="p">)</span>
<span class="k">try</span><span class="p">:</span>
    <span class="kn">from</span> <span class="nn">concurrent.futures.process</span> <span class="k">import</span> <span class="n">BrokenProcessPool</span>
    <span class="n">_ProcessPoolExceptions</span> <span class="o">=</span> <span class="p">(</span><span class="ne">KeyboardInterrupt</span><span class="p">,</span> <span class="n">BrokenProcessPool</span><span class="p">)</span>
<span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
    <span class="k">pass</span>


<div class="viewcode-block" id="CPUExecutor"><a class="viewcode-back" href="../../api_reference/internal/snakemake.html#snakemake.executors.CPUExecutor">[docs]</a><span class="k">class</span> <span class="nc">CPUExecutor</span><span class="p">(</span><span class="n">RealExecutor</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">workflow</span><span class="p">,</span> <span class="n">dag</span><span class="p">,</span> <span class="n">workers</span><span class="p">,</span>
                 <span class="n">printreason</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                 <span class="n">quiet</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                 <span class="n">printshellcmds</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                 <span class="n">use_threads</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                 <span class="n">latency_wait</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span>
                 <span class="n">cores</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">workflow</span><span class="p">,</span> <span class="n">dag</span><span class="p">,</span>
                         <span class="n">printreason</span><span class="o">=</span><span class="n">printreason</span><span class="p">,</span>
                         <span class="n">quiet</span><span class="o">=</span><span class="n">quiet</span><span class="p">,</span>
                         <span class="n">printshellcmds</span><span class="o">=</span><span class="n">printshellcmds</span><span class="p">,</span>
                         <span class="n">latency_wait</span><span class="o">=</span><span class="n">latency_wait</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">exec_job</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="se">\\\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">((</span>
            <span class="s1">&#39;cd </span><span class="si">{workflow.workdir_init}</span><span class="s1"> &amp;&amp; &#39;</span><span class="p">,</span>
            <span class="s1">&#39;</span><span class="si">{sys.executable}</span><span class="s1"> -m snakemake </span><span class="si">{target}</span><span class="s1"> --snakefile </span><span class="si">{snakefile}</span><span class="s1"> &#39;</span><span class="p">,</span>
            <span class="s1">&#39;--force -j</span><span class="si">{cores}</span><span class="s1"> --keep-target-files --keep-remote &#39;</span><span class="p">,</span>
            <span class="s1">&#39;--attempt </span><span class="si">{attempt}</span><span class="s1"> &#39;</span><span class="p">,</span>
            <span class="s1">&#39;--force-use-threads --wrapper-prefix </span><span class="si">{workflow.wrapper_prefix}</span><span class="s1"> &#39;</span><span class="p">,</span>
            <span class="s1">&#39;--latency-wait </span><span class="si">{latency_wait}</span><span class="s1"> &#39;</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">get_default_remote_provider_args</span><span class="p">(),</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">get_default_resources_args</span><span class="p">(),</span>
            <span class="s1">&#39;</span><span class="si">{overwrite_workdir}</span><span class="s1"> </span><span class="si">{overwrite_config}</span><span class="s1"> </span><span class="si">{printshellcmds}</span><span class="s1"> </span><span class="si">{rules}</span><span class="s1"> &#39;</span><span class="p">,</span>
            <span class="s1">&#39;--notemp --quiet --no-hooks --nolock --mode </span><span class="si">{}</span><span class="s1"> &#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">Mode</span><span class="o">.</span><span class="n">subprocess</span><span class="p">)))</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">workflow</span><span class="o">.</span><span class="n">shadow_prefix</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">exec_job</span> <span class="o">+=</span> <span class="s2">&quot; --shadow-prefix </span><span class="si">{}</span><span class="s2"> &quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">workflow</span><span class="o">.</span><span class="n">shadow_prefix</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">workflow</span><span class="o">.</span><span class="n">use_conda</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">exec_job</span> <span class="o">+=</span> <span class="s2">&quot; --use-conda &quot;</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">workflow</span><span class="o">.</span><span class="n">conda_prefix</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">exec_job</span> <span class="o">+=</span> <span class="s2">&quot; --conda-prefix </span><span class="si">{}</span><span class="s2"> &quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">workflow</span><span class="o">.</span><span class="n">conda_prefix</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">workflow</span><span class="o">.</span><span class="n">use_singularity</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">exec_job</span> <span class="o">+=</span> <span class="s2">&quot; --use-singularity &quot;</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">workflow</span><span class="o">.</span><span class="n">singularity_prefix</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">exec_job</span> <span class="o">+=</span> <span class="s2">&quot; --singularity-prefix </span><span class="si">{}</span><span class="s2"> &quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">workflow</span><span class="o">.</span><span class="n">singularity_prefix</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">workflow</span><span class="o">.</span><span class="n">singularity_args</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">exec_job</span> <span class="o">+=</span> <span class="s2">&quot; --singularity-args </span><span class="se">\&quot;</span><span class="si">{}</span><span class="se">\&quot;</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">workflow</span><span class="o">.</span><span class="n">singularity_args</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">use_threads</span> <span class="o">=</span> <span class="n">use_threads</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cores</span> <span class="o">=</span> <span class="n">cores</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pool</span> <span class="o">=</span> <span class="n">concurrent</span><span class="o">.</span><span class="n">futures</span><span class="o">.</span><span class="n">ThreadPoolExecutor</span><span class="p">(</span><span class="n">max_workers</span><span class="o">=</span><span class="n">workers</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>

<div class="viewcode-block" id="CPUExecutor.run"><a class="viewcode-back" href="../../api_reference/internal/snakemake.html#snakemake.executors.CPUExecutor.run">[docs]</a>    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">job</span><span class="p">,</span>
            <span class="n">callback</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="n">submit_callback</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="n">error_callback</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">_run</span><span class="p">(</span><span class="n">job</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">job</span><span class="o">.</span><span class="n">is_group</span><span class="p">():</span>
            <span class="c1"># the future waits for the entire group job</span>
            <span class="n">future</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pool</span><span class="o">.</span><span class="n">submit</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">run_group_job</span><span class="p">,</span> <span class="n">job</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">future</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">run_single_job</span><span class="p">(</span><span class="n">job</span><span class="p">)</span>

        <span class="n">future</span><span class="o">.</span><span class="n">add_done_callback</span><span class="p">(</span><span class="n">partial</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_callback</span><span class="p">,</span> <span class="n">job</span><span class="p">,</span> <span class="n">callback</span><span class="p">,</span>
                                         <span class="n">error_callback</span><span class="p">))</span></div>

<div class="viewcode-block" id="CPUExecutor.job_args_and_prepare"><a class="viewcode-back" href="../../api_reference/internal/snakemake.html#snakemake.executors.CPUExecutor.job_args_and_prepare">[docs]</a>    <span class="k">def</span> <span class="nf">job_args_and_prepare</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">job</span><span class="p">):</span>
        <span class="n">job</span><span class="o">.</span><span class="n">prepare</span><span class="p">()</span>

        <span class="n">conda_env</span> <span class="o">=</span> <span class="n">job</span><span class="o">.</span><span class="n">conda_env_path</span>
        <span class="n">singularity_img</span> <span class="o">=</span> <span class="n">job</span><span class="o">.</span><span class="n">singularity_img_path</span>

        <span class="n">benchmark</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">benchmark_repeats</span> <span class="o">=</span> <span class="n">job</span><span class="o">.</span><span class="n">benchmark_repeats</span> <span class="ow">or</span> <span class="mi">1</span>
        <span class="k">if</span> <span class="n">job</span><span class="o">.</span><span class="n">benchmark</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">benchmark</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">job</span><span class="o">.</span><span class="n">benchmark</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">job</span><span class="o">.</span><span class="n">rule</span><span class="p">,</span> <span class="n">job</span><span class="o">.</span><span class="n">input</span><span class="o">.</span><span class="n">plainstrings</span><span class="p">(),</span>
                <span class="n">job</span><span class="o">.</span><span class="n">output</span><span class="o">.</span><span class="n">plainstrings</span><span class="p">(),</span> <span class="n">job</span><span class="o">.</span><span class="n">params</span><span class="p">,</span> <span class="n">job</span><span class="o">.</span><span class="n">wildcards</span><span class="p">,</span>
                <span class="n">job</span><span class="o">.</span><span class="n">threads</span><span class="p">,</span> <span class="n">job</span><span class="o">.</span><span class="n">resources</span><span class="p">,</span> <span class="n">job</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">plainstrings</span><span class="p">(),</span> <span class="n">benchmark</span><span class="p">,</span>
                <span class="n">benchmark_repeats</span><span class="p">,</span> <span class="n">conda_env</span><span class="p">,</span> <span class="n">singularity_img</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">workflow</span><span class="o">.</span><span class="n">singularity_args</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">workflow</span><span class="o">.</span><span class="n">use_singularity</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">workflow</span><span class="o">.</span><span class="n">linemaps</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">workflow</span><span class="o">.</span><span class="n">debug</span><span class="p">,</span>
                <span class="n">job</span><span class="o">.</span><span class="n">shadow_dir</span><span class="p">,</span> <span class="n">job</span><span class="o">.</span><span class="n">jobid</span><span class="p">)</span></div>

<div class="viewcode-block" id="CPUExecutor.run_single_job"><a class="viewcode-back" href="../../api_reference/internal/snakemake.html#snakemake.executors.CPUExecutor.run_single_job">[docs]</a>    <span class="k">def</span> <span class="nf">run_single_job</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">job</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">use_threads</span> <span class="ow">or</span> <span class="p">(</span><span class="ow">not</span> <span class="n">job</span><span class="o">.</span><span class="n">is_shadow</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">job</span><span class="o">.</span><span class="n">is_run</span><span class="p">):</span>
            <span class="n">future</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pool</span><span class="o">.</span><span class="n">submit</span><span class="p">(</span>
                <span class="n">run_wrapper</span><span class="p">,</span> <span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">job_args_and_prepare</span><span class="p">(</span><span class="n">job</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># run directive jobs are spawned into subprocesses</span>
            <span class="n">future</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pool</span><span class="o">.</span><span class="n">submit</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">spawn_job</span><span class="p">,</span> <span class="n">job</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">future</span></div>

<div class="viewcode-block" id="CPUExecutor.run_group_job"><a class="viewcode-back" href="../../api_reference/internal/snakemake.html#snakemake.executors.CPUExecutor.run_group_job">[docs]</a>    <span class="k">def</span> <span class="nf">run_group_job</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">job</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Run a pipe group job.</span>

<span class="sd">        This lets all items run simultaneously.&quot;&quot;&quot;</span>
        <span class="c1"># we only have to consider pipe groups because in local running mode,</span>
        <span class="c1"># these are the only groups that will occur</span>

        <span class="n">futures</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">run_single_job</span><span class="p">(</span><span class="n">j</span><span class="p">)</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">job</span><span class="p">]</span>

        <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
            <span class="n">k</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">futures</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">f</span><span class="o">.</span><span class="n">done</span><span class="p">():</span>
                    <span class="n">ex</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">exception</span><span class="p">()</span>
                    <span class="k">if</span> <span class="n">ex</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="c1"># kill all shell commands of the other group jobs</span>
                        <span class="c1"># there can be only shell commands because the</span>
                        <span class="c1"># run directive is not allowed for pipe jobs</span>
                        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">job</span><span class="p">:</span>
                            <span class="n">shell</span><span class="o">.</span><span class="n">kill</span><span class="p">(</span><span class="n">j</span><span class="o">.</span><span class="n">jobid</span><span class="p">)</span>
                        <span class="k">raise</span> <span class="n">ex</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">k</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">if</span> <span class="n">k</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">futures</span><span class="p">):</span>
                <span class="k">return</span>
            <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span></div>

<div class="viewcode-block" id="CPUExecutor.spawn_job"><a class="viewcode-back" href="../../api_reference/internal/snakemake.html#snakemake.executors.CPUExecutor.spawn_job">[docs]</a>    <span class="k">def</span> <span class="nf">spawn_job</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">job</span><span class="p">):</span>
        <span class="n">exec_job</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">exec_job</span>
        <span class="n">cmd</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">format_job_pattern</span><span class="p">(</span><span class="n">exec_job</span><span class="p">,</span> <span class="n">job</span><span class="o">=</span><span class="n">job</span><span class="p">,</span>
                                      <span class="n">_quote_all</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                      <span class="n">latency_wait</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">latency_wait</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">subprocess</span><span class="o">.</span><span class="n">check_call</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="n">shell</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">CalledProcessError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">SpawnedJobError</span><span class="p">()</span></div>

<div class="viewcode-block" id="CPUExecutor.shutdown"><a class="viewcode-back" href="../../api_reference/internal/snakemake.html#snakemake.executors.CPUExecutor.shutdown">[docs]</a>    <span class="k">def</span> <span class="nf">shutdown</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pool</span><span class="o">.</span><span class="n">shutdown</span><span class="p">()</span></div>

<div class="viewcode-block" id="CPUExecutor.cancel"><a class="viewcode-back" href="../../api_reference/internal/snakemake.html#snakemake.executors.CPUExecutor.cancel">[docs]</a>    <span class="k">def</span> <span class="nf">cancel</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pool</span><span class="o">.</span><span class="n">shutdown</span><span class="p">()</span></div>

    <span class="k">def</span> <span class="nf">_callback</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">job</span><span class="p">,</span> <span class="n">callback</span><span class="p">,</span> <span class="n">error_callback</span><span class="p">,</span> <span class="n">future</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">ex</span> <span class="o">=</span> <span class="n">future</span><span class="o">.</span><span class="n">exception</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">ex</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">ex</span>
            <span class="n">callback</span><span class="p">(</span><span class="n">job</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">_ProcessPoolExceptions</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">handle_job_error</span><span class="p">(</span><span class="n">job</span><span class="p">)</span>
            <span class="c1"># no error callback, just silently ignore the interrupt as the main scheduler is also killed</span>
        <span class="k">except</span> <span class="n">SpawnedJobError</span><span class="p">:</span>
            <span class="c1"># don&#39;t print error message, this is done by the spawned subprocess</span>
            <span class="n">error_callback</span><span class="p">(</span><span class="n">job</span><span class="p">)</span>
        <span class="k">except</span> <span class="p">(</span><span class="ne">Exception</span><span class="p">,</span> <span class="ne">BaseException</span><span class="p">)</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">print_job_error</span><span class="p">(</span><span class="n">job</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">job</span><span class="o">.</span><span class="n">is_group</span><span class="p">()</span> <span class="ow">or</span> <span class="n">job</span><span class="o">.</span><span class="n">shellcmd</span><span class="p">):</span>
                <span class="n">print_exception</span><span class="p">(</span><span class="n">ex</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">workflow</span><span class="o">.</span><span class="n">linemaps</span><span class="p">)</span>
            <span class="n">error_callback</span><span class="p">(</span><span class="n">job</span><span class="p">)</span>

<div class="viewcode-block" id="CPUExecutor.handle_job_success"><a class="viewcode-back" href="../../api_reference/internal/snakemake.html#snakemake.executors.CPUExecutor.handle_job_success">[docs]</a>    <span class="k">def</span> <span class="nf">handle_job_success</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">job</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">handle_job_success</span><span class="p">(</span><span class="n">job</span><span class="p">)</span></div>

<div class="viewcode-block" id="CPUExecutor.handle_job_error"><a class="viewcode-back" href="../../api_reference/internal/snakemake.html#snakemake.executors.CPUExecutor.handle_job_error">[docs]</a>    <span class="k">def</span> <span class="nf">handle_job_error</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">job</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">handle_job_error</span><span class="p">(</span><span class="n">job</span><span class="p">)</span>
        <span class="n">job</span><span class="o">.</span><span class="n">cleanup</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">workflow</span><span class="o">.</span><span class="n">persistence</span><span class="o">.</span><span class="n">cleanup</span><span class="p">(</span><span class="n">job</span><span class="p">)</span></div></div>


<div class="viewcode-block" id="ClusterExecutor"><a class="viewcode-back" href="../../api_reference/internal/snakemake.html#snakemake.executors.ClusterExecutor">[docs]</a><span class="k">class</span> <span class="nc">ClusterExecutor</span><span class="p">(</span><span class="n">RealExecutor</span><span class="p">):</span>

    <span class="n">default_jobscript</span> <span class="o">=</span> <span class="s2">&quot;jobscript.sh&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">workflow</span><span class="p">,</span> <span class="n">dag</span><span class="p">,</span> <span class="n">cores</span><span class="p">,</span>
                 <span class="n">jobname</span><span class="o">=</span><span class="s2">&quot;snakejob.</span><span class="si">{name}</span><span class="s2">.</span><span class="si">{jobid}</span><span class="s2">.sh&quot;</span><span class="p">,</span>
                 <span class="n">printreason</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                 <span class="n">quiet</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                 <span class="n">printshellcmds</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                 <span class="n">latency_wait</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span>
                 <span class="n">cluster_config</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">local_input</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">restart_times</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">exec_job</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">assume_shared_fs</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                 <span class="n">max_status_checks_per_second</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
        <span class="kn">from</span> <span class="nn">ratelimiter</span> <span class="k">import</span> <span class="n">RateLimiter</span>

        <span class="n">local_input</span> <span class="o">=</span> <span class="n">local_input</span> <span class="ow">or</span> <span class="p">[]</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">workflow</span><span class="p">,</span> <span class="n">dag</span><span class="p">,</span>
                         <span class="n">printreason</span><span class="o">=</span><span class="n">printreason</span><span class="p">,</span>
                         <span class="n">quiet</span><span class="o">=</span><span class="n">quiet</span><span class="p">,</span>
                         <span class="n">printshellcmds</span><span class="o">=</span><span class="n">printshellcmds</span><span class="p">,</span>
                         <span class="n">latency_wait</span><span class="o">=</span><span class="n">latency_wait</span><span class="p">,</span>
                         <span class="n">assume_shared_fs</span><span class="o">=</span><span class="n">assume_shared_fs</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">assume_shared_fs</span><span class="p">:</span>
            <span class="c1"># use relative path to Snakefile</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">snakefile</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">relpath</span><span class="p">(</span><span class="n">workflow</span><span class="o">.</span><span class="n">snakefile</span><span class="p">)</span>

        <span class="n">jobscript</span> <span class="o">=</span> <span class="n">workflow</span><span class="o">.</span><span class="n">jobscript</span>
        <span class="k">if</span> <span class="n">jobscript</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">jobscript</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="vm">__file__</span><span class="p">),</span>
                                     <span class="bp">self</span><span class="o">.</span><span class="n">default_jobscript</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">jobscript</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">jobscript</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
        <span class="k">except</span> <span class="ne">IOError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">WorkflowError</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="s2">&quot;jobid&quot;</span> <span class="ow">in</span> <span class="n">get_wildcard_names</span><span class="p">(</span><span class="n">jobname</span><span class="p">):</span>
            <span class="k">raise</span> <span class="n">WorkflowError</span><span class="p">(</span>
                <span class="s2">&quot;Defined jobname (</span><span class="se">\&quot;</span><span class="si">{}</span><span class="se">\&quot;</span><span class="s2">) has to contain the wildcard </span><span class="si">{jobid}</span><span class="s2">.&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">exec_job</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">exec_job</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="se">\\\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">((</span>
                <span class="s1">&#39;cd </span><span class="si">{workflow.workdir_init}</span><span class="s1"> &amp;&amp; &#39;</span> <span class="k">if</span> <span class="n">assume_shared_fs</span> <span class="k">else</span> <span class="s1">&#39;&#39;</span><span class="p">,</span>
                <span class="s1">&#39;</span><span class="si">{sys.executable}</span><span class="s1"> &#39;</span> <span class="k">if</span> <span class="n">assume_shared_fs</span> <span class="k">else</span> <span class="s1">&#39;python &#39;</span><span class="p">,</span>
                <span class="s1">&#39;-m snakemake </span><span class="si">{target}</span><span class="s1"> --snakefile </span><span class="si">{snakefile}</span><span class="s1"> &#39;</span><span class="p">,</span>
                <span class="s1">&#39;--force -j</span><span class="si">{cores}</span><span class="s1"> --keep-target-files --keep-remote &#39;</span><span class="p">,</span>
                <span class="s1">&#39;--wait-for-files </span><span class="si">{wait_for_files}</span><span class="s1"> --latency-wait </span><span class="si">{latency_wait}</span><span class="s1"> &#39;</span><span class="p">,</span>
                <span class="s1">&#39; --attempt </span><span class="si">{attempt}</span><span class="s1"> </span><span class="si">{use_threads}</span><span class="s1"> &#39;</span><span class="p">,</span>
                <span class="s1">&#39;--wrapper-prefix </span><span class="si">{workflow.wrapper_prefix}</span><span class="s1"> &#39;</span><span class="p">,</span>
                <span class="s1">&#39;</span><span class="si">{overwrite_workdir}</span><span class="s1"> </span><span class="si">{overwrite_config}</span><span class="s1"> </span><span class="si">{printshellcmds}</span><span class="s1"> </span><span class="si">{rules}</span><span class="s1"> &#39;</span>
                <span class="s1">&#39;--nocolor --notemp --no-hooks --nolock &#39;</span><span class="p">,</span>
                <span class="s1">&#39;--mode </span><span class="si">{}</span><span class="s1"> &#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">Mode</span><span class="o">.</span><span class="n">cluster</span><span class="p">)))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">exec_job</span> <span class="o">=</span> <span class="n">exec_job</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">workflow</span><span class="o">.</span><span class="n">shadow_prefix</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">exec_job</span> <span class="o">+=</span> <span class="s2">&quot; --shadow-prefix </span><span class="si">{}</span><span class="s2"> &quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">workflow</span><span class="o">.</span><span class="n">shadow_prefix</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">workflow</span><span class="o">.</span><span class="n">use_conda</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">exec_job</span> <span class="o">+=</span> <span class="s2">&quot; --use-conda &quot;</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">workflow</span><span class="o">.</span><span class="n">conda_prefix</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">exec_job</span> <span class="o">+=</span> <span class="s2">&quot; --conda-prefix </span><span class="si">{}</span><span class="s2"> &quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">workflow</span><span class="o">.</span><span class="n">conda_prefix</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">workflow</span><span class="o">.</span><span class="n">use_singularity</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">exec_job</span> <span class="o">+=</span> <span class="s2">&quot; --use-singularity &quot;</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">workflow</span><span class="o">.</span><span class="n">singularity_prefix</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">exec_job</span> <span class="o">+=</span> <span class="s2">&quot; --singularity-prefix </span><span class="si">{}</span><span class="s2"> &quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">workflow</span><span class="o">.</span><span class="n">singularity_prefix</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">workflow</span><span class="o">.</span><span class="n">singularity_args</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">exec_job</span> <span class="o">+=</span> <span class="s2">&quot; --singularity-args </span><span class="se">\&quot;</span><span class="si">{}</span><span class="se">\&quot;</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">workflow</span><span class="o">.</span><span class="n">singularity_args</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">exec_job</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_default_remote_provider_args</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">exec_job</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_default_resources_args</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">jobname</span> <span class="o">=</span> <span class="n">jobname</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_tmpdir</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cores</span> <span class="o">=</span> <span class="n">cores</span> <span class="k">if</span> <span class="n">cores</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cluster_config</span> <span class="o">=</span> <span class="n">cluster_config</span> <span class="k">if</span> <span class="n">cluster_config</span> <span class="k">else</span> <span class="nb">dict</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">restart_times</span> <span class="o">=</span> <span class="n">restart_times</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">active_jobs</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lock</span> <span class="o">=</span> <span class="n">threading</span><span class="o">.</span><span class="n">Lock</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">wait</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">wait_thread</span> <span class="o">=</span> <span class="n">threading</span><span class="o">.</span><span class="n">Thread</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_wait_for_jobs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">wait_thread</span><span class="o">.</span><span class="n">daemon</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">wait_thread</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">max_status_checks_per_second</span> <span class="o">=</span> <span class="n">max_status_checks_per_second</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">status_rate_limiter</span> <span class="o">=</span> <span class="n">RateLimiter</span><span class="p">(</span>
            <span class="n">max_calls</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">max_status_checks_per_second</span><span class="p">,</span>
            <span class="n">period</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

<div class="viewcode-block" id="ClusterExecutor.shutdown"><a class="viewcode-back" href="../../api_reference/internal/snakemake.html#snakemake.executors.ClusterExecutor.shutdown">[docs]</a>    <span class="k">def</span> <span class="nf">shutdown</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">lock</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">wait</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">wait_thread</span><span class="o">.</span><span class="n">join</span><span class="p">()</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">workflow</span><span class="o">.</span><span class="n">immediate_submit</span><span class="p">:</span>
            <span class="c1"># Only delete tmpdir (containing jobscripts) if not using</span>
            <span class="c1"># immediate_submit. With immediate_submit, jobs can be scheduled</span>
            <span class="c1"># after this method is completed. Hence we have to keep the</span>
            <span class="c1"># directory.</span>
            <span class="n">shutil</span><span class="o">.</span><span class="n">rmtree</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tmpdir</span><span class="p">)</span></div>

<div class="viewcode-block" id="ClusterExecutor.cancel"><a class="viewcode-back" href="../../api_reference/internal/snakemake.html#snakemake.executors.ClusterExecutor.cancel">[docs]</a>    <span class="k">def</span> <span class="nf">cancel</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">shutdown</span><span class="p">()</span></div>

    <span class="k">def</span> <span class="nf">_run</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">job</span><span class="p">,</span> <span class="n">callback</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">error_callback</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">assume_shared_fs</span><span class="p">:</span>
            <span class="n">job</span><span class="o">.</span><span class="n">remove_existing_output</span><span class="p">()</span>
            <span class="n">job</span><span class="o">.</span><span class="n">download_remote_input</span><span class="p">()</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">_run</span><span class="p">(</span><span class="n">job</span><span class="p">,</span> <span class="n">callback</span><span class="o">=</span><span class="n">callback</span><span class="p">,</span> <span class="n">error_callback</span><span class="o">=</span><span class="n">error_callback</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">tmpdir</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_tmpdir</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_tmpdir</span> <span class="o">=</span> <span class="n">mkdtemp</span><span class="p">(</span><span class="nb">dir</span><span class="o">=</span><span class="s2">&quot;.snakemake&quot;</span><span class="p">,</span> <span class="n">prefix</span><span class="o">=</span><span class="s2">&quot;tmp.&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_tmpdir</span><span class="p">)</span>

<div class="viewcode-block" id="ClusterExecutor.get_jobscript"><a class="viewcode-back" href="../../api_reference/internal/snakemake.html#snakemake.executors.ClusterExecutor.get_jobscript">[docs]</a>    <span class="k">def</span> <span class="nf">get_jobscript</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">job</span><span class="p">):</span>
        <span class="n">f</span> <span class="o">=</span> <span class="n">job</span><span class="o">.</span><span class="n">format_wildcards</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">jobname</span><span class="p">,</span>
                             <span class="n">cluster</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">cluster_wildcards</span><span class="p">(</span><span class="n">job</span><span class="p">))</span>

        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">sep</span> <span class="ow">in</span> <span class="n">f</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">WorkflowError</span><span class="p">(</span><span class="s2">&quot;Path separator (</span><span class="si">{}</span><span class="s2">) found in job name </span><span class="si">{}</span><span class="s2">. &quot;</span>
                                <span class="s2">&quot;This is not supported.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                                <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">sep</span><span class="p">,</span> <span class="n">f</span><span class="p">))</span>

        <span class="k">return</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tmpdir</span><span class="p">,</span> <span class="n">f</span><span class="p">)</span></div>

<div class="viewcode-block" id="ClusterExecutor.format_job"><a class="viewcode-back" href="../../api_reference/internal/snakemake.html#snakemake.executors.ClusterExecutor.format_job">[docs]</a>    <span class="k">def</span> <span class="nf">format_job</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pattern</span><span class="p">,</span> <span class="n">job</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">wait_for_files</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">assume_shared_fs</span><span class="p">:</span>
            <span class="n">wait_for_files</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tmpdir</span><span class="p">)</span>
            <span class="n">wait_for_files</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">job</span><span class="o">.</span><span class="n">get_wait_for_files</span><span class="p">())</span>

        <span class="n">format_p</span> <span class="o">=</span> <span class="n">partial</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">format_job_pattern</span><span class="p">,</span>
                           <span class="n">job</span><span class="o">=</span><span class="n">job</span><span class="p">,</span>
                           <span class="n">properties</span><span class="o">=</span><span class="n">job</span><span class="o">.</span><span class="n">properties</span><span class="p">(</span>
                               <span class="n">cluster</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">cluster_params</span><span class="p">(</span><span class="n">job</span><span class="p">)),</span>
                           <span class="n">latency_wait</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">latency_wait</span><span class="p">,</span>
                           <span class="n">wait_for_files</span><span class="o">=</span><span class="n">wait_for_files</span><span class="p">,</span>
                           <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">format_p</span><span class="p">(</span><span class="n">pattern</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">KeyError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">WorkflowError</span><span class="p">(</span>
                <span class="s2">&quot;Error formatting jobscript: </span><span class="si">{}</span><span class="s2"> not found</span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="s2">&quot;Make sure that your custom jobscript is up to date.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">e</span><span class="p">))</span></div>

<div class="viewcode-block" id="ClusterExecutor.write_jobscript"><a class="viewcode-back" href="../../api_reference/internal/snakemake.html#snakemake.executors.ClusterExecutor.write_jobscript">[docs]</a>    <span class="k">def</span> <span class="nf">write_jobscript</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">job</span><span class="p">,</span> <span class="n">jobscript</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="c1"># only force threads if this is not a group job</span>
        <span class="c1"># otherwise we want proper process handling</span>
        <span class="n">use_threads</span> <span class="o">=</span> <span class="s2">&quot;--force-use-threads&quot;</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">job</span><span class="o">.</span><span class="n">is_group</span><span class="p">()</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span>
        <span class="n">exec_job</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">format_job</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">exec_job</span><span class="p">,</span>
                                   <span class="n">job</span><span class="p">,</span>
                                   <span class="n">_quote_all</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                   <span class="n">use_threads</span><span class="o">=</span><span class="n">use_threads</span><span class="p">,</span>
                                   <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="n">content</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">format_job</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">jobscript</span><span class="p">,</span>
                                  <span class="n">job</span><span class="p">,</span>
                                  <span class="n">exec_job</span><span class="o">=</span><span class="n">exec_job</span><span class="p">,</span>
                                  <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Jobscript:</span><span class="se">\n</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">content</span><span class="p">))</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">jobscript</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">content</span><span class="p">,</span> <span class="n">file</span><span class="o">=</span><span class="n">f</span><span class="p">)</span>
        <span class="n">os</span><span class="o">.</span><span class="n">chmod</span><span class="p">(</span><span class="n">jobscript</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">stat</span><span class="p">(</span><span class="n">jobscript</span><span class="p">)</span><span class="o">.</span><span class="n">st_mode</span> <span class="o">|</span> <span class="n">stat</span><span class="o">.</span><span class="n">S_IXUSR</span><span class="p">)</span></div>

<div class="viewcode-block" id="ClusterExecutor.cluster_params"><a class="viewcode-back" href="../../api_reference/internal/snakemake.html#snakemake.executors.ClusterExecutor.cluster_params">[docs]</a>    <span class="k">def</span> <span class="nf">cluster_params</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">job</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return wildcards object for job from cluster_config.&quot;&quot;&quot;</span>
        <span class="n">cluster</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cluster_config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;__default__&quot;</span><span class="p">,</span> <span class="nb">dict</span><span class="p">())</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">cluster</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cluster_config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">job</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="nb">dict</span><span class="p">()))</span>
        <span class="c1"># Format values with available parameters from the job.</span>
        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">cluster</span><span class="o">.</span><span class="n">items</span><span class="p">()):</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">cluster</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">job</span><span class="o">.</span><span class="n">format_wildcards</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">NameError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">job</span><span class="o">.</span><span class="n">is_group</span><span class="p">():</span>
                        <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;Failed to format cluster config for group job. &quot;</span>
                               <span class="s2">&quot;You have to ensure that your default entry &quot;</span>
                               <span class="s2">&quot;does not contain any items that group jobs &quot;</span>
                               <span class="s2">&quot;cannot provide, like </span><span class="si">{rule}</span><span class="s2">, </span><span class="si">{wildcards}</span><span class="s2">.&quot;</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;Failed to format cluster config &quot;</span>
                               <span class="s2">&quot;entry for job </span><span class="si">{}</span><span class="s2">.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">job</span><span class="o">.</span><span class="n">rule</span><span class="o">.</span><span class="n">name</span><span class="p">))</span>
                    <span class="k">raise</span> <span class="n">WorkflowError</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">cluster</span></div>

<div class="viewcode-block" id="ClusterExecutor.cluster_wildcards"><a class="viewcode-back" href="../../api_reference/internal/snakemake.html#snakemake.executors.ClusterExecutor.cluster_wildcards">[docs]</a>    <span class="k">def</span> <span class="nf">cluster_wildcards</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">job</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">Wildcards</span><span class="p">(</span><span class="n">fromdict</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">cluster_params</span><span class="p">(</span><span class="n">job</span><span class="p">))</span></div>

<div class="viewcode-block" id="ClusterExecutor.handle_job_success"><a class="viewcode-back" href="../../api_reference/internal/snakemake.html#snakemake.executors.ClusterExecutor.handle_job_success">[docs]</a>    <span class="k">def</span> <span class="nf">handle_job_success</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">job</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">handle_job_success</span><span class="p">(</span><span class="n">job</span><span class="p">,</span> <span class="n">upload_remote</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                                   <span class="n">handle_log</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">handle_touch</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span></div>

<div class="viewcode-block" id="ClusterExecutor.handle_job_error"><a class="viewcode-back" href="../../api_reference/internal/snakemake.html#snakemake.executors.ClusterExecutor.handle_job_error">[docs]</a>    <span class="k">def</span> <span class="nf">handle_job_error</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">job</span><span class="p">):</span>
        <span class="c1"># TODO what about removing empty remote dirs?? This cannot be decided</span>
        <span class="c1"># on the cluster node.</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">handle_job_error</span><span class="p">(</span><span class="n">job</span><span class="p">,</span> <span class="n">upload_remote</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Cleanup job metadata.&quot;</span><span class="p">)</span>
        <span class="c1"># We have to remove metadata here as well.</span>
        <span class="c1"># It will be removed by the CPUExecutor in case of a shared FS,</span>
        <span class="c1"># but we might not see the removal due to filesystem latency.</span>
        <span class="c1"># By removing it again, we make sure that it is gone on the host FS.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">workflow</span><span class="o">.</span><span class="n">persistence</span><span class="o">.</span><span class="n">cleanup</span><span class="p">(</span><span class="n">job</span><span class="p">)</span></div>

<div class="viewcode-block" id="ClusterExecutor.print_cluster_job_error"><a class="viewcode-back" href="../../api_reference/internal/snakemake.html#snakemake.executors.ClusterExecutor.print_cluster_job_error">[docs]</a>    <span class="k">def</span> <span class="nf">print_cluster_job_error</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">job_info</span><span class="p">,</span> <span class="n">jobid</span><span class="p">):</span>
        <span class="n">job</span> <span class="o">=</span> <span class="n">job_info</span><span class="o">.</span><span class="n">job</span>
        <span class="n">kind</span> <span class="o">=</span> <span class="s2">&quot;rule </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">job</span><span class="o">.</span><span class="n">rule</span><span class="o">.</span><span class="n">name</span><span class="p">)</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">job</span><span class="o">.</span><span class="n">is_group</span><span class="p">()</span> <span class="k">else</span> <span class="s2">&quot;group job </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">job</span><span class="o">.</span><span class="n">groupid</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Error executing </span><span class="si">{}</span><span class="s2"> on cluster (jobid: </span><span class="si">{}</span><span class="s2">, external: &quot;</span>
                     <span class="s2">&quot;</span><span class="si">{}</span><span class="s2">, jobscript: </span><span class="si">{}</span><span class="s2">). For error details see the cluster &quot;</span>
                     <span class="s2">&quot;log and the log files of the involved rule(s).&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">kind</span><span class="p">,</span>
                                   <span class="n">jobid</span><span class="p">,</span> <span class="n">job_info</span><span class="o">.</span><span class="n">jobid</span><span class="p">,</span> <span class="n">job_info</span><span class="o">.</span><span class="n">jobscript</span><span class="p">))</span></div></div>


<span class="n">GenericClusterJob</span> <span class="o">=</span> <span class="n">namedtuple</span><span class="p">(</span><span class="s2">&quot;GenericClusterJob&quot;</span><span class="p">,</span> <span class="s2">&quot;job jobid callback error_callback jobscript jobfinished jobfailed&quot;</span><span class="p">)</span>


<div class="viewcode-block" id="GenericClusterExecutor"><a class="viewcode-back" href="../../api_reference/internal/snakemake.html#snakemake.executors.GenericClusterExecutor">[docs]</a><span class="k">class</span> <span class="nc">GenericClusterExecutor</span><span class="p">(</span><span class="n">ClusterExecutor</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">workflow</span><span class="p">,</span> <span class="n">dag</span><span class="p">,</span> <span class="n">cores</span><span class="p">,</span>
                 <span class="n">submitcmd</span><span class="o">=</span><span class="s2">&quot;qsub&quot;</span><span class="p">,</span>
                 <span class="n">statuscmd</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">cluster_config</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">jobname</span><span class="o">=</span><span class="s2">&quot;snakejob.</span><span class="si">{rulename}</span><span class="s2">.</span><span class="si">{jobid}</span><span class="s2">.sh&quot;</span><span class="p">,</span>
                 <span class="n">printreason</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                 <span class="n">quiet</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                 <span class="n">printshellcmds</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                 <span class="n">latency_wait</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span>
                 <span class="n">restart_times</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                 <span class="n">assume_shared_fs</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                 <span class="n">max_status_checks_per_second</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">submitcmd</span> <span class="o">=</span> <span class="n">submitcmd</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">assume_shared_fs</span> <span class="ow">and</span> <span class="n">statuscmd</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">WorkflowError</span><span class="p">(</span><span class="s2">&quot;When no shared filesystem can be assumed, a &quot;</span>
                <span class="s2">&quot;status command must be given.&quot;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">statuscmd</span> <span class="o">=</span> <span class="n">statuscmd</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">external_jobid</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>

        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">workflow</span><span class="p">,</span> <span class="n">dag</span><span class="p">,</span> <span class="n">cores</span><span class="p">,</span>
                         <span class="n">jobname</span><span class="o">=</span><span class="n">jobname</span><span class="p">,</span>
                         <span class="n">printreason</span><span class="o">=</span><span class="n">printreason</span><span class="p">,</span>
                         <span class="n">quiet</span><span class="o">=</span><span class="n">quiet</span><span class="p">,</span>
                         <span class="n">printshellcmds</span><span class="o">=</span><span class="n">printshellcmds</span><span class="p">,</span>
                         <span class="n">latency_wait</span><span class="o">=</span><span class="n">latency_wait</span><span class="p">,</span>
                         <span class="n">cluster_config</span><span class="o">=</span><span class="n">cluster_config</span><span class="p">,</span>
                         <span class="n">restart_times</span><span class="o">=</span><span class="n">restart_times</span><span class="p">,</span>
                         <span class="n">assume_shared_fs</span><span class="o">=</span><span class="n">assume_shared_fs</span><span class="p">,</span>
                         <span class="n">max_status_checks_per_second</span><span class="o">=</span><span class="n">max_status_checks_per_second</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">statuscmd</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">exec_job</span> <span class="o">+=</span> <span class="s1">&#39; &amp;&amp; exit 0 || exit 1&#39;</span>
        <span class="k">elif</span> <span class="n">assume_shared_fs</span><span class="p">:</span>
            <span class="c1"># TODO wrap with watch and touch {jobrunning}</span>
            <span class="c1"># check modification date of {jobrunning} in the wait_for_job method</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">exec_job</span> <span class="o">+=</span> <span class="s1">&#39; &amp;&amp; touch &quot;</span><span class="si">{jobfinished}</span><span class="s1">&quot; || (touch &quot;</span><span class="si">{jobfailed}</span><span class="s1">&quot;; exit 1)&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">WorkflowError</span><span class="p">(</span><span class="s2">&quot;If no shared filesystem is used, you have to &quot;</span>
                                <span class="s2">&quot;specify a cluster status command.&quot;</span><span class="p">)</span>


<div class="viewcode-block" id="GenericClusterExecutor.cancel"><a class="viewcode-back" href="../../api_reference/internal/snakemake.html#snakemake.executors.GenericClusterExecutor.cancel">[docs]</a>    <span class="k">def</span> <span class="nf">cancel</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Will exit after finishing currently running jobs.&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">shutdown</span><span class="p">()</span></div>

<div class="viewcode-block" id="GenericClusterExecutor.register_job"><a class="viewcode-back" href="../../api_reference/internal/snakemake.html#snakemake.executors.GenericClusterExecutor.register_job">[docs]</a>    <span class="k">def</span> <span class="nf">register_job</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">job</span><span class="p">):</span>
        <span class="c1"># Do not register job here.</span>
        <span class="c1"># Instead do it manually once the jobid is known.</span>
        <span class="k">pass</span></div>

<div class="viewcode-block" id="GenericClusterExecutor.run"><a class="viewcode-back" href="../../api_reference/internal/snakemake.html#snakemake.executors.GenericClusterExecutor.run">[docs]</a>    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">job</span><span class="p">,</span>
            <span class="n">callback</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="n">submit_callback</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="n">error_callback</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">_run</span><span class="p">(</span><span class="n">job</span><span class="p">)</span>
        <span class="n">workdir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">()</span>
        <span class="n">jobid</span> <span class="o">=</span> <span class="n">job</span><span class="o">.</span><span class="n">jobid</span>

        <span class="n">jobscript</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_jobscript</span><span class="p">(</span><span class="n">job</span><span class="p">)</span>
        <span class="n">jobfinished</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tmpdir</span><span class="p">,</span> <span class="s2">&quot;</span><span class="si">{}</span><span class="s2">.jobfinished&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">jobid</span><span class="p">))</span>
        <span class="n">jobfailed</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tmpdir</span><span class="p">,</span> <span class="s2">&quot;</span><span class="si">{}</span><span class="s2">.jobfailed&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">jobid</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">write_jobscript</span><span class="p">(</span><span class="n">job</span><span class="p">,</span> <span class="n">jobscript</span><span class="p">,</span>
                             <span class="n">jobfinished</span><span class="o">=</span><span class="n">jobfinished</span><span class="p">,</span>
                             <span class="n">jobfailed</span><span class="o">=</span><span class="n">jobfailed</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">statuscmd</span><span class="p">:</span>
            <span class="n">ext_jobid</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dag</span><span class="o">.</span><span class="n">incomplete_external_jobid</span><span class="p">(</span><span class="n">job</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">ext_jobid</span><span class="p">:</span>
                <span class="c1"># Job is incomplete and still running.</span>
                <span class="c1"># We simply register it and wait for completion or failure.</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                    <span class="s2">&quot;Resuming incomplete job </span><span class="si">{}</span><span class="s2"> with external jobid &#39;</span><span class="si">{}</span><span class="s2">&#39;.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="n">jobid</span><span class="p">,</span> <span class="n">ext_jobid</span><span class="p">))</span>
                <span class="n">submit_callback</span><span class="p">(</span><span class="n">job</span><span class="p">)</span>
                <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">lock</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">active_jobs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                        <span class="n">GenericClusterJob</span><span class="p">(</span><span class="n">job</span><span class="p">,</span>
                                          <span class="n">ext_jobid</span><span class="p">,</span>
                                          <span class="n">callback</span><span class="p">,</span>
                                          <span class="n">error_callback</span><span class="p">,</span>
                                          <span class="n">jobscript</span><span class="p">,</span>
                                          <span class="n">jobfinished</span><span class="p">,</span>
                                          <span class="n">jobfailed</span><span class="p">))</span>
                <span class="k">return</span>

        <span class="n">deps</span> <span class="o">=</span> <span class="s2">&quot; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">external_jobid</span><span class="p">[</span><span class="n">f</span><span class="p">]</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">job</span><span class="o">.</span><span class="n">input</span>
                        <span class="k">if</span> <span class="n">f</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">external_jobid</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">submitcmd</span> <span class="o">=</span> <span class="n">job</span><span class="o">.</span><span class="n">format_wildcards</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">submitcmd</span><span class="p">,</span>
                <span class="n">dependencies</span><span class="o">=</span><span class="n">deps</span><span class="p">,</span>
                <span class="n">cluster</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">cluster_wildcards</span><span class="p">(</span><span class="n">job</span><span class="p">))</span>
        <span class="k">except</span> <span class="ne">AttributeError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">WorkflowError</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">),</span>
                                <span class="n">rule</span><span class="o">=</span><span class="n">job</span><span class="o">.</span><span class="n">rule</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">job</span><span class="o">.</span><span class="n">is_group</span><span class="p">()</span> <span class="k">else</span> <span class="kc">None</span><span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">ext_jobid</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">check_output</span><span class="p">(</span>
                <span class="s1">&#39;</span><span class="si">{submitcmd}</span><span class="s1"> &quot;</span><span class="si">{jobscript}</span><span class="s1">&quot;&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">submitcmd</span><span class="o">=</span><span class="n">submitcmd</span><span class="p">,</span>
                                                   <span class="n">jobscript</span><span class="o">=</span><span class="n">jobscript</span><span class="p">),</span>
                <span class="n">shell</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">decode</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">CalledProcessError</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Error submitting jobscript (exit code </span><span class="si">{}</span><span class="s2">):</span><span class="se">\n</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="n">ex</span><span class="o">.</span><span class="n">returncode</span><span class="p">,</span> <span class="n">ex</span><span class="o">.</span><span class="n">output</span><span class="o">.</span><span class="n">decode</span><span class="p">()))</span>
            <span class="n">error_callback</span><span class="p">(</span><span class="n">job</span><span class="p">)</span>
            <span class="k">return</span>
        <span class="k">if</span> <span class="n">ext_jobid</span> <span class="ow">and</span> <span class="n">ext_jobid</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
            <span class="n">ext_jobid</span> <span class="o">=</span> <span class="n">ext_jobid</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">external_jobid</span><span class="o">.</span><span class="n">update</span><span class="p">((</span><span class="n">f</span><span class="p">,</span> <span class="n">ext_jobid</span><span class="p">)</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">job</span><span class="o">.</span><span class="n">output</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Submitted </span><span class="si">{}</span><span class="s2"> </span><span class="si">{}</span><span class="s2"> with external jobid &#39;</span><span class="si">{}</span><span class="s2">&#39;.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="s2">&quot;group job&quot;</span> <span class="k">if</span> <span class="n">job</span><span class="o">.</span><span class="n">is_group</span><span class="p">()</span> <span class="k">else</span> <span class="s2">&quot;job&quot;</span><span class="p">,</span>
                <span class="n">jobid</span><span class="p">,</span> <span class="n">ext_jobid</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">workflow</span><span class="o">.</span><span class="n">persistence</span><span class="o">.</span><span class="n">started</span><span class="p">(</span>
                <span class="n">job</span><span class="p">,</span> <span class="n">external_jobid</span><span class="o">=</span><span class="n">ext_jobid</span><span class="p">)</span>

        <span class="n">submit_callback</span><span class="p">(</span><span class="n">job</span><span class="p">)</span>

        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">lock</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">active_jobs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">GenericClusterJob</span><span class="p">(</span>
                <span class="n">job</span><span class="p">,</span> <span class="n">ext_jobid</span><span class="p">,</span> <span class="n">callback</span><span class="p">,</span> <span class="n">error_callback</span><span class="p">,</span> <span class="n">jobscript</span><span class="p">,</span>
                <span class="n">jobfinished</span><span class="p">,</span> <span class="n">jobfailed</span><span class="p">))</span></div>

    <span class="k">def</span> <span class="nf">_wait_for_jobs</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">success</span> <span class="o">=</span> <span class="s2">&quot;success&quot;</span>
        <span class="n">failed</span> <span class="o">=</span> <span class="s2">&quot;failed&quot;</span>
        <span class="n">running</span> <span class="o">=</span> <span class="s2">&quot;running&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">statuscmd</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">def</span> <span class="nf">job_status</span><span class="p">(</span><span class="n">job</span><span class="p">):</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="c1"># this command shall return &quot;success&quot;, &quot;failed&quot; or &quot;running&quot;</span>
                    <span class="k">return</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">check_output</span><span class="p">(</span>
                        <span class="s1">&#39;</span><span class="si">{statuscmd}</span><span class="s1"> </span><span class="si">{jobid}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">jobid</span><span class="o">=</span><span class="n">job</span><span class="o">.</span><span class="n">jobid</span><span class="p">,</span>
                                                     <span class="n">statuscmd</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">statuscmd</span><span class="p">),</span>
                        <span class="n">shell</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">decode</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
                <span class="k">except</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">CalledProcessError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">e</span><span class="o">.</span><span class="n">returncode</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="c1"># Ignore SIGINT and all other issues due to signals</span>
                        <span class="c1"># because it will be caused by hitting e.g.</span>
                        <span class="c1"># Ctrl-C on the main process or sending killall to</span>
                        <span class="c1"># snakemake.</span>
                        <span class="c1"># Snakemake will handle the signal in</span>
                        <span class="c1"># the master process.</span>
                        <span class="k">pass</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">raise</span> <span class="n">WorkflowError</span><span class="p">(</span><span class="s2">&quot;Failed to obtain job status. &quot;</span>
                                            <span class="s2">&quot;See above for error message.&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">def</span> <span class="nf">job_status</span><span class="p">(</span><span class="n">job</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">active_job</span><span class="o">.</span><span class="n">jobfinished</span><span class="p">):</span>
                    <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">active_job</span><span class="o">.</span><span class="n">jobfinished</span><span class="p">)</span>
                    <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">active_job</span><span class="o">.</span><span class="n">jobscript</span><span class="p">)</span>
                    <span class="k">return</span> <span class="n">success</span>
                <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">active_job</span><span class="o">.</span><span class="n">jobfailed</span><span class="p">):</span>
                    <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">active_job</span><span class="o">.</span><span class="n">jobfailed</span><span class="p">)</span>
                    <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">active_job</span><span class="o">.</span><span class="n">jobscript</span><span class="p">)</span>
                    <span class="k">return</span> <span class="n">failed</span>
                <span class="k">return</span> <span class="n">running</span>

        <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
            <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">lock</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">wait</span><span class="p">:</span>
                    <span class="k">return</span>
                <span class="n">active_jobs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">active_jobs</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">active_jobs</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
                <span class="n">still_running</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Checking status of </span><span class="si">{}</span><span class="s2"> jobs.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">active_jobs</span><span class="p">)))</span>
            <span class="k">for</span> <span class="n">active_job</span> <span class="ow">in</span> <span class="n">active_jobs</span><span class="p">:</span>
                <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">status_rate_limiter</span><span class="p">:</span>
                    <span class="n">status</span> <span class="o">=</span> <span class="n">job_status</span><span class="p">(</span><span class="n">active_job</span><span class="p">)</span>

                    <span class="k">if</span> <span class="n">status</span> <span class="o">==</span> <span class="n">success</span><span class="p">:</span>
                        <span class="n">active_job</span><span class="o">.</span><span class="n">callback</span><span class="p">(</span><span class="n">active_job</span><span class="o">.</span><span class="n">job</span><span class="p">)</span>
                    <span class="k">elif</span> <span class="n">status</span> <span class="o">==</span> <span class="n">failed</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">print_job_error</span><span class="p">(</span>
                            <span class="n">active_job</span><span class="o">.</span><span class="n">job</span><span class="p">,</span>
                            <span class="n">cluster_jobid</span><span class="o">=</span><span class="n">active_job</span><span class="o">.</span><span class="n">jobid</span> <span class="k">if</span> <span class="n">active_job</span><span class="o">.</span><span class="n">jobid</span> <span class="k">else</span> <span class="s2">&quot;unknown&quot;</span><span class="p">,</span>
                        <span class="p">)</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">print_cluster_job_error</span><span class="p">(</span>
                            <span class="n">active_job</span><span class="p">,</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">dag</span><span class="o">.</span><span class="n">jobid</span><span class="p">(</span><span class="n">active_job</span><span class="o">.</span><span class="n">job</span><span class="p">))</span>
                        <span class="n">active_job</span><span class="o">.</span><span class="n">error_callback</span><span class="p">(</span><span class="n">active_job</span><span class="o">.</span><span class="n">job</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">still_running</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">active_job</span><span class="p">)</span>
            <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">lock</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">active_jobs</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">still_running</span><span class="p">)</span>
            <span class="n">sleep</span><span class="p">()</span></div>


<span class="n">SynchronousClusterJob</span> <span class="o">=</span> <span class="n">namedtuple</span><span class="p">(</span><span class="s2">&quot;SynchronousClusterJob&quot;</span><span class="p">,</span> <span class="s2">&quot;job jobid callback error_callback jobscript process&quot;</span><span class="p">)</span>


<div class="viewcode-block" id="SynchronousClusterExecutor"><a class="viewcode-back" href="../../api_reference/internal/snakemake.html#snakemake.executors.SynchronousClusterExecutor">[docs]</a><span class="k">class</span> <span class="nc">SynchronousClusterExecutor</span><span class="p">(</span><span class="n">ClusterExecutor</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    invocations like &quot;qsub -sync y&quot; (SGE) or &quot;bsub -K&quot; (LSF) are</span>
<span class="sd">    synchronous, blocking the foreground thread and returning the</span>
<span class="sd">    remote exit code at remote exit.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">workflow</span><span class="p">,</span> <span class="n">dag</span><span class="p">,</span> <span class="n">cores</span><span class="p">,</span>
                 <span class="n">submitcmd</span><span class="o">=</span><span class="s2">&quot;qsub&quot;</span><span class="p">,</span>
                 <span class="n">cluster_config</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">jobname</span><span class="o">=</span><span class="s2">&quot;snakejob.</span><span class="si">{rulename}</span><span class="s2">.</span><span class="si">{jobid}</span><span class="s2">.sh&quot;</span><span class="p">,</span>
                 <span class="n">printreason</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                 <span class="n">quiet</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                 <span class="n">printshellcmds</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                 <span class="n">latency_wait</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span>
                 <span class="n">restart_times</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                 <span class="n">assume_shared_fs</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">workflow</span><span class="p">,</span> <span class="n">dag</span><span class="p">,</span> <span class="n">cores</span><span class="p">,</span>
                         <span class="n">jobname</span><span class="o">=</span><span class="n">jobname</span><span class="p">,</span>
                         <span class="n">printreason</span><span class="o">=</span><span class="n">printreason</span><span class="p">,</span>
                         <span class="n">quiet</span><span class="o">=</span><span class="n">quiet</span><span class="p">,</span>
                         <span class="n">printshellcmds</span><span class="o">=</span><span class="n">printshellcmds</span><span class="p">,</span>
                         <span class="n">latency_wait</span><span class="o">=</span><span class="n">latency_wait</span><span class="p">,</span>
                         <span class="n">cluster_config</span><span class="o">=</span><span class="n">cluster_config</span><span class="p">,</span>
                         <span class="n">restart_times</span><span class="o">=</span><span class="n">restart_times</span><span class="p">,</span>
                         <span class="n">assume_shared_fs</span><span class="o">=</span><span class="n">assume_shared_fs</span><span class="p">,</span>
                         <span class="n">max_status_checks_per_second</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">submitcmd</span> <span class="o">=</span> <span class="n">submitcmd</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">external_jobid</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>

<div class="viewcode-block" id="SynchronousClusterExecutor.cancel"><a class="viewcode-back" href="../../api_reference/internal/snakemake.html#snakemake.executors.SynchronousClusterExecutor.cancel">[docs]</a>    <span class="k">def</span> <span class="nf">cancel</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Will exit after finishing currently running jobs.&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">shutdown</span><span class="p">()</span></div>

<div class="viewcode-block" id="SynchronousClusterExecutor.run"><a class="viewcode-back" href="../../api_reference/internal/snakemake.html#snakemake.executors.SynchronousClusterExecutor.run">[docs]</a>    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">job</span><span class="p">,</span>
            <span class="n">callback</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="n">submit_callback</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="n">error_callback</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">_run</span><span class="p">(</span><span class="n">job</span><span class="p">)</span>
        <span class="n">workdir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">()</span>
        <span class="n">jobid</span> <span class="o">=</span> <span class="n">job</span><span class="o">.</span><span class="n">jobid</span>

        <span class="n">jobscript</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_jobscript</span><span class="p">(</span><span class="n">job</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">write_jobscript</span><span class="p">(</span><span class="n">job</span><span class="p">,</span> <span class="n">jobscript</span><span class="p">)</span>

        <span class="n">deps</span> <span class="o">=</span> <span class="s2">&quot; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">external_jobid</span><span class="p">[</span><span class="n">f</span><span class="p">]</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">job</span><span class="o">.</span><span class="n">input</span>
                        <span class="k">if</span> <span class="n">f</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">external_jobid</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">submitcmd</span> <span class="o">=</span> <span class="n">job</span><span class="o">.</span><span class="n">format_wildcards</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">submitcmd</span><span class="p">,</span>
                <span class="n">dependencies</span><span class="o">=</span><span class="n">deps</span><span class="p">,</span>
                <span class="n">cluster</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">cluster_wildcards</span><span class="p">(</span><span class="n">job</span><span class="p">))</span>
        <span class="k">except</span> <span class="ne">AttributeError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">WorkflowError</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">),</span>
                                <span class="n">rule</span><span class="o">=</span><span class="n">job</span><span class="o">.</span><span class="n">rule</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">job</span><span class="o">.</span><span class="n">is_group</span><span class="p">()</span> <span class="k">else</span> <span class="kc">None</span><span class="p">)</span>

        <span class="n">process</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">Popen</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{submitcmd}</span><span class="s1"> &quot;</span><span class="si">{jobscript}</span><span class="s1">&quot;&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">submitcmd</span><span class="o">=</span><span class="n">submitcmd</span><span class="p">,</span>
                                           <span class="n">jobscript</span><span class="o">=</span><span class="n">jobscript</span><span class="p">),</span> <span class="n">shell</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">submit_callback</span><span class="p">(</span><span class="n">job</span><span class="p">)</span>

        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">lock</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">active_jobs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">SynchronousClusterJob</span><span class="p">(</span>
                <span class="n">job</span><span class="p">,</span> <span class="n">process</span><span class="o">.</span><span class="n">pid</span><span class="p">,</span> <span class="n">callback</span><span class="p">,</span> <span class="n">error_callback</span><span class="p">,</span> <span class="n">jobscript</span><span class="p">,</span>
                <span class="n">process</span><span class="p">))</span></div>

    <span class="k">def</span> <span class="nf">_wait_for_jobs</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
            <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">lock</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">wait</span><span class="p">:</span>
                    <span class="k">return</span>
                <span class="n">active_jobs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">active_jobs</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">active_jobs</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
                <span class="n">still_running</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">active_job</span> <span class="ow">in</span> <span class="n">active_jobs</span><span class="p">:</span>
                <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">status_rate_limiter</span><span class="p">:</span>
                    <span class="n">exitcode</span> <span class="o">=</span> <span class="n">active_job</span><span class="o">.</span><span class="n">process</span><span class="o">.</span><span class="n">poll</span><span class="p">()</span>
                    <span class="k">if</span> <span class="n">exitcode</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="c1"># job not yet finished</span>
                        <span class="n">still_running</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">active_job</span><span class="p">)</span>
                    <span class="k">elif</span> <span class="n">exitcode</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="c1"># job finished successfully</span>
                        <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">active_job</span><span class="o">.</span><span class="n">jobscript</span><span class="p">)</span>
                        <span class="n">active_job</span><span class="o">.</span><span class="n">callback</span><span class="p">(</span><span class="n">active_job</span><span class="o">.</span><span class="n">job</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="c1"># job failed</span>
                        <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">active_job</span><span class="o">.</span><span class="n">jobscript</span><span class="p">)</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">print_job_error</span><span class="p">(</span><span class="n">active_job</span><span class="o">.</span><span class="n">job</span><span class="p">)</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">print_cluster_job_error</span><span class="p">(</span>
                            <span class="n">active_job</span><span class="p">,</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">dag</span><span class="o">.</span><span class="n">jobid</span><span class="p">(</span><span class="n">active_job</span><span class="o">.</span><span class="n">job</span><span class="p">))</span>
                        <span class="n">active_job</span><span class="o">.</span><span class="n">error_callback</span><span class="p">(</span><span class="n">active_job</span><span class="o">.</span><span class="n">job</span><span class="p">)</span>
            <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">lock</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">active_jobs</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">still_running</span><span class="p">)</span>
            <span class="n">sleep</span><span class="p">()</span></div>


<span class="n">DRMAAClusterJob</span> <span class="o">=</span> <span class="n">namedtuple</span><span class="p">(</span><span class="s2">&quot;DRMAAClusterJob&quot;</span><span class="p">,</span> <span class="s2">&quot;job jobid callback error_callback jobscript&quot;</span><span class="p">)</span>


<div class="viewcode-block" id="DRMAAExecutor"><a class="viewcode-back" href="../../api_reference/internal/snakemake.html#snakemake.executors.DRMAAExecutor">[docs]</a><span class="k">class</span> <span class="nc">DRMAAExecutor</span><span class="p">(</span><span class="n">ClusterExecutor</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">workflow</span><span class="p">,</span> <span class="n">dag</span><span class="p">,</span> <span class="n">cores</span><span class="p">,</span>
                 <span class="n">jobname</span><span class="o">=</span><span class="s2">&quot;snakejob.</span><span class="si">{rulename}</span><span class="s2">.</span><span class="si">{jobid}</span><span class="s2">.sh&quot;</span><span class="p">,</span>
                 <span class="n">printreason</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                 <span class="n">quiet</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                 <span class="n">printshellcmds</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                 <span class="n">drmaa_args</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span>
                 <span class="n">drmaa_log_dir</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">latency_wait</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span>
                 <span class="n">cluster_config</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">restart_times</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                 <span class="n">assume_shared_fs</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                 <span class="n">max_status_checks_per_second</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">workflow</span><span class="p">,</span> <span class="n">dag</span><span class="p">,</span> <span class="n">cores</span><span class="p">,</span>
                         <span class="n">jobname</span><span class="o">=</span><span class="n">jobname</span><span class="p">,</span>
                         <span class="n">printreason</span><span class="o">=</span><span class="n">printreason</span><span class="p">,</span>
                         <span class="n">quiet</span><span class="o">=</span><span class="n">quiet</span><span class="p">,</span>
                         <span class="n">printshellcmds</span><span class="o">=</span><span class="n">printshellcmds</span><span class="p">,</span>
                         <span class="n">latency_wait</span><span class="o">=</span><span class="n">latency_wait</span><span class="p">,</span>
                         <span class="n">cluster_config</span><span class="o">=</span><span class="n">cluster_config</span><span class="p">,</span>
                         <span class="n">restart_times</span><span class="o">=</span><span class="n">restart_times</span><span class="p">,</span>
                         <span class="n">assume_shared_fs</span><span class="o">=</span><span class="n">assume_shared_fs</span><span class="p">,</span>
                         <span class="n">max_status_checks_per_second</span><span class="o">=</span><span class="n">max_status_checks_per_second</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="kn">import</span> <span class="nn">drmaa</span>
        <span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">WorkflowError</span><span class="p">(</span>
                <span class="s2">&quot;Python support for DRMAA is not installed. &quot;</span>
                <span class="s2">&quot;Please install it, e.g. with easy_install3 --user drmaa&quot;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">RuntimeError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">WorkflowError</span><span class="p">(</span><span class="s2">&quot;Error loading drmaa support:</span><span class="se">\n</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">e</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">session</span> <span class="o">=</span> <span class="n">drmaa</span><span class="o">.</span><span class="n">Session</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">drmaa_args</span> <span class="o">=</span> <span class="n">drmaa_args</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">drmaa_log_dir</span> <span class="o">=</span> <span class="n">drmaa_log_dir</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">initialize</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">submitted</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>

<div class="viewcode-block" id="DRMAAExecutor.cancel"><a class="viewcode-back" href="../../api_reference/internal/snakemake.html#snakemake.executors.DRMAAExecutor.cancel">[docs]</a>    <span class="k">def</span> <span class="nf">cancel</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="kn">from</span> <span class="nn">drmaa.const</span> <span class="k">import</span> <span class="n">JobControlAction</span>
        <span class="kn">from</span> <span class="nn">drmaa.errors</span> <span class="k">import</span> <span class="n">InvalidJobException</span><span class="p">,</span> <span class="n">InternalException</span>
        <span class="k">for</span> <span class="n">jobid</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">submitted</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">control</span><span class="p">(</span><span class="n">jobid</span><span class="p">,</span> <span class="n">JobControlAction</span><span class="o">.</span><span class="n">TERMINATE</span><span class="p">)</span>
            <span class="k">except</span> <span class="p">(</span><span class="n">InvalidJobException</span><span class="p">,</span> <span class="n">InternalException</span><span class="p">):</span>
                <span class="c1">#This is common - logging a warning would probably confuse the user.</span>
                <span class="k">pass</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">shutdown</span><span class="p">()</span></div>

<div class="viewcode-block" id="DRMAAExecutor.run"><a class="viewcode-back" href="../../api_reference/internal/snakemake.html#snakemake.executors.DRMAAExecutor.run">[docs]</a>    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">job</span><span class="p">,</span>
            <span class="n">callback</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="n">submit_callback</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="n">error_callback</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">_run</span><span class="p">(</span><span class="n">job</span><span class="p">)</span>
        <span class="n">jobscript</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_jobscript</span><span class="p">(</span><span class="n">job</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">write_jobscript</span><span class="p">(</span><span class="n">job</span><span class="p">,</span> <span class="n">jobscript</span><span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">drmaa_args</span> <span class="o">=</span> <span class="n">job</span><span class="o">.</span><span class="n">format_wildcards</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">drmaa_args</span><span class="p">,</span>
                <span class="n">cluster</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">cluster_wildcards</span><span class="p">(</span><span class="n">job</span><span class="p">))</span>
        <span class="k">except</span> <span class="ne">AttributeError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">WorkflowError</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">),</span> <span class="n">rule</span><span class="o">=</span><span class="n">job</span><span class="o">.</span><span class="n">rule</span><span class="p">)</span>

        <span class="kn">import</span> <span class="nn">drmaa</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">drmaa_log_dir</span><span class="p">:</span>
            <span class="n">makedirs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">drmaa_log_dir</span><span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">jt</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">createJobTemplate</span><span class="p">()</span>
            <span class="n">jt</span><span class="o">.</span><span class="n">remoteCommand</span> <span class="o">=</span> <span class="n">jobscript</span>
            <span class="n">jt</span><span class="o">.</span><span class="n">nativeSpecification</span> <span class="o">=</span> <span class="n">drmaa_args</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">drmaa_log_dir</span><span class="p">:</span>
                <span class="n">jt</span><span class="o">.</span><span class="n">outputPath</span> <span class="o">=</span> <span class="s2">&quot;:&quot;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">drmaa_log_dir</span>
                <span class="n">jt</span><span class="o">.</span><span class="n">errorPath</span> <span class="o">=</span> <span class="s2">&quot;:&quot;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">drmaa_log_dir</span>
            <span class="n">jt</span><span class="o">.</span><span class="n">jobName</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">jobscript</span><span class="p">)</span>

            <span class="n">jobid</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">runJob</span><span class="p">(</span><span class="n">jt</span><span class="p">)</span>
        <span class="k">except</span> <span class="p">(</span><span class="n">drmaa</span><span class="o">.</span><span class="n">DeniedByDrmException</span><span class="p">,</span>
                <span class="n">drmaa</span><span class="o">.</span><span class="n">InternalException</span><span class="p">,</span>
                <span class="n">drmaa</span><span class="o">.</span><span class="n">InvalidAttributeValueException</span><span class="p">)</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">print_exception</span><span class="p">(</span><span class="n">WorkflowError</span><span class="p">(</span><span class="s2">&quot;DRMAA Error: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">e</span><span class="p">)),</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">workflow</span><span class="o">.</span><span class="n">linemaps</span><span class="p">)</span>
            <span class="n">error_callback</span><span class="p">(</span><span class="n">job</span><span class="p">)</span>
            <span class="k">return</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Submitted DRMAA job </span><span class="si">{}</span><span class="s2"> with external jobid </span><span class="si">{}</span><span class="s2">.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">job</span><span class="o">.</span><span class="n">jobid</span><span class="p">,</span> <span class="n">jobid</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">submitted</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">jobid</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">deleteJobTemplate</span><span class="p">(</span><span class="n">jt</span><span class="p">)</span>

        <span class="n">submit_callback</span><span class="p">(</span><span class="n">job</span><span class="p">)</span>

        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">lock</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">active_jobs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">DRMAAClusterJob</span><span class="p">(</span>
                <span class="n">job</span><span class="p">,</span> <span class="n">jobid</span><span class="p">,</span> <span class="n">callback</span><span class="p">,</span> <span class="n">error_callback</span><span class="p">,</span> <span class="n">jobscript</span><span class="p">))</span></div>

<div class="viewcode-block" id="DRMAAExecutor.shutdown"><a class="viewcode-back" href="../../api_reference/internal/snakemake.html#snakemake.executors.DRMAAExecutor.shutdown">[docs]</a>    <span class="k">def</span> <span class="nf">shutdown</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">shutdown</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">exit</span><span class="p">()</span></div>

    <span class="k">def</span> <span class="nf">_wait_for_jobs</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="kn">import</span> <span class="nn">drmaa</span>
        <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
            <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">lock</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">wait</span><span class="p">:</span>
                    <span class="k">return</span>
                <span class="n">active_jobs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">active_jobs</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">active_jobs</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
                <span class="n">still_running</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">active_job</span> <span class="ow">in</span> <span class="n">active_jobs</span><span class="p">:</span>
                <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">status_rate_limiter</span><span class="p">:</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">retval</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">wait</span><span class="p">(</span><span class="n">active_job</span><span class="o">.</span><span class="n">jobid</span><span class="p">,</span>
                                                   <span class="n">drmaa</span><span class="o">.</span><span class="n">Session</span><span class="o">.</span><span class="n">TIMEOUT_NO_WAIT</span><span class="p">)</span>
                    <span class="k">except</span> <span class="n">drmaa</span><span class="o">.</span><span class="n">ExitTimeoutException</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                        <span class="c1"># job still active</span>
                        <span class="n">still_running</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">active_job</span><span class="p">)</span>
                        <span class="k">continue</span>
                    <span class="k">except</span> <span class="p">(</span><span class="n">drmaa</span><span class="o">.</span><span class="n">InternalException</span><span class="p">,</span> <span class="ne">Exception</span><span class="p">)</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                        <span class="n">print_exception</span><span class="p">(</span><span class="n">WorkflowError</span><span class="p">(</span><span class="s2">&quot;DRMAA Error: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">e</span><span class="p">)),</span>
                                        <span class="bp">self</span><span class="o">.</span><span class="n">workflow</span><span class="o">.</span><span class="n">linemaps</span><span class="p">)</span>
                        <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">active_job</span><span class="o">.</span><span class="n">jobscript</span><span class="p">)</span>
                        <span class="n">active_job</span><span class="o">.</span><span class="n">error_callback</span><span class="p">(</span><span class="n">active_job</span><span class="o">.</span><span class="n">job</span><span class="p">)</span>
                        <span class="k">continue</span>
                    <span class="c1"># job exited</span>
                    <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">active_job</span><span class="o">.</span><span class="n">jobscript</span><span class="p">)</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">retval</span><span class="o">.</span><span class="n">wasAborted</span> <span class="ow">and</span> <span class="n">retval</span><span class="o">.</span><span class="n">hasExited</span> <span class="ow">and</span> <span class="n">retval</span><span class="o">.</span><span class="n">exitStatus</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="n">active_job</span><span class="o">.</span><span class="n">callback</span><span class="p">(</span><span class="n">active_job</span><span class="o">.</span><span class="n">job</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">print_job_error</span><span class="p">(</span><span class="n">active_job</span><span class="o">.</span><span class="n">job</span><span class="p">)</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">print_cluster_job_error</span><span class="p">(</span>
                            <span class="n">active_job</span><span class="p">,</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">dag</span><span class="o">.</span><span class="n">jobid</span><span class="p">(</span><span class="n">active_job</span><span class="o">.</span><span class="n">job</span><span class="p">))</span>
                        <span class="n">active_job</span><span class="o">.</span><span class="n">error_callback</span><span class="p">(</span><span class="n">active_job</span><span class="o">.</span><span class="n">job</span><span class="p">)</span>
            <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">lock</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">active_jobs</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">still_running</span><span class="p">)</span>
            <span class="n">sleep</span><span class="p">()</span></div>


<div class="viewcode-block" id="change_working_directory"><a class="viewcode-back" href="../../api_reference/internal/snakemake.html#snakemake.executors.change_working_directory">[docs]</a><span class="nd">@contextlib</span><span class="o">.</span><span class="n">contextmanager</span>
<span class="k">def</span> <span class="nf">change_working_directory</span><span class="p">(</span><span class="n">directory</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Change working directory in execution context if provided. &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">directory</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">saved_directory</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">()</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Changing to shadow directory: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">directory</span><span class="p">))</span>
            <span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="n">directory</span><span class="p">)</span>
            <span class="k">yield</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="n">saved_directory</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">yield</span></div>


<span class="n">KubernetesJob</span> <span class="o">=</span> <span class="n">namedtuple</span><span class="p">(</span><span class="s2">&quot;KubernetesJob&quot;</span><span class="p">,</span> <span class="s2">&quot;job jobid callback error_callback kubejob jobscript&quot;</span><span class="p">)</span>


<div class="viewcode-block" id="KubernetesExecutor"><a class="viewcode-back" href="../../api_reference/internal/snakemake.html#snakemake.executors.KubernetesExecutor">[docs]</a><span class="k">class</span> <span class="nc">KubernetesExecutor</span><span class="p">(</span><span class="n">ClusterExecutor</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">workflow</span><span class="p">,</span> <span class="n">dag</span><span class="p">,</span> <span class="n">namespace</span><span class="p">,</span> <span class="n">envvars</span><span class="p">,</span>
                 <span class="n">container_image</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">jobname</span><span class="o">=</span><span class="s2">&quot;</span><span class="si">{rulename}</span><span class="s2">.</span><span class="si">{jobid}</span><span class="s2">&quot;</span><span class="p">,</span>
                 <span class="n">printreason</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                 <span class="n">quiet</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                 <span class="n">printshellcmds</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                 <span class="n">latency_wait</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span>
                 <span class="n">cluster_config</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">local_input</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">restart_times</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>

        <span class="n">exec_job</span> <span class="o">=</span> <span class="p">(</span>
            <span class="s1">&#39;cp -rf /source/. . &amp;&amp; &#39;</span>
            <span class="s1">&#39;snakemake </span><span class="si">{target}</span><span class="s1"> --snakefile </span><span class="si">{snakefile}</span><span class="s1"> &#39;</span>
            <span class="s1">&#39;--force -j</span><span class="si">{cores}</span><span class="s1"> --keep-target-files  --keep-remote &#39;</span>
            <span class="s1">&#39;--latency-wait 0 &#39;</span>
            <span class="s1">&#39; --attempt </span><span class="si">{attempt}</span><span class="s1"> </span><span class="si">{use_threads}</span><span class="s1"> &#39;</span>
            <span class="s1">&#39;--wrapper-prefix </span><span class="si">{workflow.wrapper_prefix}</span><span class="s1"> &#39;</span>
            <span class="s1">&#39;</span><span class="si">{overwrite_config}</span><span class="s1"> </span><span class="si">{printshellcmds}</span><span class="s1"> </span><span class="si">{rules}</span><span class="s1"> --nocolor &#39;</span>
            <span class="s1">&#39;--notemp --no-hooks --nolock &#39;</span><span class="p">)</span>

        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">workflow</span><span class="p">,</span> <span class="n">dag</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span>
                         <span class="n">jobname</span><span class="o">=</span><span class="n">jobname</span><span class="p">,</span>
                         <span class="n">printreason</span><span class="o">=</span><span class="n">printreason</span><span class="p">,</span>
                         <span class="n">quiet</span><span class="o">=</span><span class="n">quiet</span><span class="p">,</span>
                         <span class="n">printshellcmds</span><span class="o">=</span><span class="n">printshellcmds</span><span class="p">,</span>
                         <span class="n">latency_wait</span><span class="o">=</span><span class="n">latency_wait</span><span class="p">,</span>
                         <span class="n">cluster_config</span><span class="o">=</span><span class="n">cluster_config</span><span class="p">,</span>
                         <span class="n">local_input</span><span class="o">=</span><span class="n">local_input</span><span class="p">,</span>
                         <span class="n">restart_times</span><span class="o">=</span><span class="n">restart_times</span><span class="p">,</span>
                         <span class="n">exec_job</span><span class="o">=</span><span class="n">exec_job</span><span class="p">,</span>
                         <span class="n">assume_shared_fs</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                         <span class="n">max_status_checks_per_second</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
        <span class="c1"># use relative path to Snakefile</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">snakefile</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">relpath</span><span class="p">(</span><span class="n">workflow</span><span class="o">.</span><span class="n">snakefile</span><span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="kn">from</span> <span class="nn">kubernetes</span> <span class="k">import</span> <span class="n">config</span>
        <span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">WorkflowError</span><span class="p">(</span><span class="s2">&quot;The Python 3 package &#39;kubernetes&#39; &quot;</span>
                                <span class="s2">&quot;must be installed to use Kubernetes&quot;</span><span class="p">)</span>
        <span class="n">config</span><span class="o">.</span><span class="n">load_kube_config</span><span class="p">()</span>

        <span class="kn">import</span> <span class="nn">kubernetes.client</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">kubeapi</span> <span class="o">=</span> <span class="n">kubernetes</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">CoreV1Api</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">batchapi</span> <span class="o">=</span> <span class="n">kubernetes</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">BatchV1Api</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">namespace</span> <span class="o">=</span> <span class="n">namespace</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">envvars</span> <span class="o">=</span> <span class="n">envvars</span> <span class="ow">or</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">secret_files</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">run_namespace</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">uuid</span><span class="o">.</span><span class="n">uuid4</span><span class="p">())</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">secret_envvars</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">register_secret</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">container_image</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">container_image</span> <span class="ow">or</span>
            <span class="n">get_container_image</span><span class="p">())</span>

<div class="viewcode-block" id="KubernetesExecutor.register_secret"><a class="viewcode-back" href="../../api_reference/internal/snakemake.html#snakemake.executors.KubernetesExecutor.register_secret">[docs]</a>    <span class="k">def</span> <span class="nf">register_secret</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="kn">import</span> <span class="nn">kubernetes.client</span>

        <span class="n">secret</span> <span class="o">=</span> <span class="n">kubernetes</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">V1Secret</span><span class="p">()</span>
        <span class="n">secret</span><span class="o">.</span><span class="n">metadata</span> <span class="o">=</span> <span class="n">kubernetes</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">V1ObjectMeta</span><span class="p">()</span>
        <span class="c1"># create a random uuid</span>
        <span class="n">secret</span><span class="o">.</span><span class="n">metadata</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">run_namespace</span>
        <span class="n">secret</span><span class="o">.</span><span class="n">type</span> <span class="o">=</span> <span class="s2">&quot;Opaque&quot;</span>
        <span class="n">secret</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">f</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">workflow</span><span class="o">.</span><span class="n">get_sources</span><span class="p">()):</span>
            <span class="k">if</span> <span class="n">f</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;..&quot;</span><span class="p">):</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Ignoring source file </span><span class="si">{}</span><span class="s2">. Only files relative &quot;</span>
                               <span class="s2">&quot;to the working directory are allowed.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">f</span><span class="p">))</span>
                <span class="k">continue</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="s2">&quot;br&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">content</span><span class="p">:</span>
                <span class="n">key</span> <span class="o">=</span> <span class="s2">&quot;f</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">secret_files</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">f</span>
                <span class="n">secret</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">base64</span><span class="o">.</span><span class="n">b64encode</span><span class="p">(</span><span class="n">content</span><span class="o">.</span><span class="n">read</span><span class="p">())</span><span class="o">.</span><span class="n">decode</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">envvars</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">key</span> <span class="o">=</span> <span class="n">e</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
                <span class="n">secret</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">base64</span><span class="o">.</span><span class="n">b64encode</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="n">e</span><span class="p">]</span><span class="o">.</span><span class="n">encode</span><span class="p">())</span><span class="o">.</span><span class="n">decode</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">secret_envvars</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">e</span>
            <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                <span class="k">continue</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">kubeapi</span><span class="o">.</span><span class="n">create_namespaced_secret</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">namespace</span><span class="p">,</span> <span class="n">secret</span><span class="p">)</span></div>

<div class="viewcode-block" id="KubernetesExecutor.unregister_secret"><a class="viewcode-back" href="../../api_reference/internal/snakemake.html#snakemake.executors.KubernetesExecutor.unregister_secret">[docs]</a>    <span class="k">def</span> <span class="nf">unregister_secret</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="kn">import</span> <span class="nn">kubernetes.client</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">kubeapi</span><span class="o">.</span><span class="n">delete_namespaced_secret</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">run_namespace</span><span class="p">,</span>
                                              <span class="bp">self</span><span class="o">.</span><span class="n">namespace</span><span class="p">,</span>
                                              <span class="n">body</span><span class="o">=</span><span class="n">kubernetes</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">V1DeleteOptions</span><span class="p">())</span></div>

<div class="viewcode-block" id="KubernetesExecutor.shutdown"><a class="viewcode-back" href="../../api_reference/internal/snakemake.html#snakemake.executors.KubernetesExecutor.shutdown">[docs]</a>    <span class="k">def</span> <span class="nf">shutdown</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">unregister_secret</span><span class="p">()</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">shutdown</span><span class="p">()</span></div>

<div class="viewcode-block" id="KubernetesExecutor.cancel"><a class="viewcode-back" href="../../api_reference/internal/snakemake.html#snakemake.executors.KubernetesExecutor.cancel">[docs]</a>    <span class="k">def</span> <span class="nf">cancel</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="kn">import</span> <span class="nn">kubernetes.client</span>
        <span class="n">body</span> <span class="o">=</span> <span class="n">kubernetes</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">V1DeleteOptions</span><span class="p">()</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">lock</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">active_jobs</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">kubeapi</span><span class="o">.</span><span class="n">delete_namespaced_pod</span><span class="p">(</span>
                    <span class="n">j</span><span class="o">.</span><span class="n">jobid</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">namespace</span><span class="p">,</span> <span class="n">body</span><span class="o">=</span><span class="n">body</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">shutdown</span><span class="p">()</span></div>

<div class="viewcode-block" id="KubernetesExecutor.run"><a class="viewcode-back" href="../../api_reference/internal/snakemake.html#snakemake.executors.KubernetesExecutor.run">[docs]</a>    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">job</span><span class="p">,</span>
            <span class="n">callback</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="n">submit_callback</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="n">error_callback</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="kn">import</span> <span class="nn">kubernetes.client</span>

        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">_run</span><span class="p">(</span><span class="n">job</span><span class="p">)</span>
        <span class="n">exec_job</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">format_job</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">exec_job</span><span class="p">,</span> <span class="n">job</span><span class="p">,</span> <span class="n">_quote_all</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">use_threads</span><span class="o">=</span><span class="s2">&quot;--force-use-threads&quot;</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">job</span><span class="o">.</span><span class="n">is_group</span><span class="p">()</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
        <span class="c1"># Kubernetes silently does not submit a job if the name is too long</span>
        <span class="c1"># therefore, we ensure that it is not longer than snakejob+uuid.</span>
        <span class="n">jobid</span> <span class="o">=</span> <span class="s2">&quot;snakejob-</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="n">get_uuid</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{}</span><span class="s2">-</span><span class="si">{}</span><span class="s2">-</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">run_namespace</span><span class="p">,</span> <span class="n">job</span><span class="o">.</span><span class="n">jobid</span><span class="p">,</span> <span class="n">job</span><span class="o">.</span><span class="n">attempt</span><span class="p">)))</span>

        <span class="n">body</span> <span class="o">=</span> <span class="n">kubernetes</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">V1Pod</span><span class="p">()</span>
        <span class="n">body</span><span class="o">.</span><span class="n">metadata</span> <span class="o">=</span> <span class="n">kubernetes</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">V1ObjectMeta</span><span class="p">(</span><span class="n">labels</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;app&quot;</span><span class="p">:</span> <span class="s2">&quot;snakemake&quot;</span><span class="p">})</span>
        <span class="n">body</span><span class="o">.</span><span class="n">metadata</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">jobid</span>

        <span class="c1"># container</span>
        <span class="n">container</span> <span class="o">=</span> <span class="n">kubernetes</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">V1Container</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">jobid</span><span class="p">)</span>
        <span class="n">container</span><span class="o">.</span><span class="n">image</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">container_image</span>
        <span class="n">container</span><span class="o">.</span><span class="n">command</span> <span class="o">=</span> <span class="n">shlex</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;/bin/sh&quot;</span><span class="p">)</span>
        <span class="n">container</span><span class="o">.</span><span class="n">args</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;-c&quot;</span><span class="p">,</span> <span class="n">exec_job</span><span class="p">]</span>
        <span class="n">container</span><span class="o">.</span><span class="n">working_dir</span> <span class="o">=</span> <span class="s2">&quot;/workdir&quot;</span>
        <span class="n">container</span><span class="o">.</span><span class="n">volume_mounts</span> <span class="o">=</span> <span class="p">[</span><span class="n">kubernetes</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">V1VolumeMount</span><span class="p">(</span>
            <span class="n">name</span><span class="o">=</span><span class="s2">&quot;workdir&quot;</span><span class="p">,</span> <span class="n">mount_path</span><span class="o">=</span><span class="s2">&quot;/workdir&quot;</span><span class="p">)]</span>
        <span class="n">container</span><span class="o">.</span><span class="n">volume_mounts</span> <span class="o">=</span> <span class="p">[</span><span class="n">kubernetes</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">V1VolumeMount</span><span class="p">(</span>
            <span class="n">name</span><span class="o">=</span><span class="s2">&quot;source&quot;</span><span class="p">,</span> <span class="n">mount_path</span><span class="o">=</span><span class="s2">&quot;/source&quot;</span><span class="p">)]</span>

        <span class="n">body</span><span class="o">.</span><span class="n">spec</span> <span class="o">=</span> <span class="n">kubernetes</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">V1PodSpec</span><span class="p">(</span><span class="n">containers</span><span class="o">=</span><span class="p">[</span><span class="n">container</span><span class="p">])</span>
        <span class="c1"># fail on first error</span>
        <span class="n">body</span><span class="o">.</span><span class="n">spec</span><span class="o">.</span><span class="n">restart_policy</span> <span class="o">=</span> <span class="s2">&quot;Never&quot;</span>

        <span class="c1"># source files as a secret volume</span>
        <span class="c1"># we copy these files to the workdir before executing Snakemake</span>
        <span class="n">too_large</span> <span class="o">=</span> <span class="p">[</span><span class="n">path</span> <span class="k">for</span> <span class="n">path</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">secret_files</span><span class="o">.</span><span class="n">values</span><span class="p">()</span>
                     <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">getsize</span><span class="p">(</span><span class="n">path</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1000000</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">too_large</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">WorkflowError</span><span class="p">(</span><span class="s2">&quot;The following source files exceed the maximum &quot;</span>
                                <span class="s2">&quot;file size (1MB) that can be passed from host to &quot;</span>
                                <span class="s2">&quot;kubernetes. These are likely not source code &quot;</span>
                                <span class="s2">&quot;files. Consider adding them to your &quot;</span>
                                <span class="s2">&quot;remote storage instead or (if software) use &quot;</span>
                                <span class="s2">&quot;Conda packages or container images:</span><span class="se">\n</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                                <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">too_large</span><span class="p">)))</span>
        <span class="n">secret_volume</span> <span class="o">=</span> <span class="n">kubernetes</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">V1Volume</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;source&quot;</span><span class="p">)</span>
        <span class="n">secret_volume</span><span class="o">.</span><span class="n">secret</span> <span class="o">=</span> <span class="n">kubernetes</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">V1SecretVolumeSource</span><span class="p">()</span>
        <span class="n">secret_volume</span><span class="o">.</span><span class="n">secret</span><span class="o">.</span><span class="n">secret_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">run_namespace</span>
        <span class="n">secret_volume</span><span class="o">.</span><span class="n">secret</span><span class="o">.</span><span class="n">items</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">kubernetes</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">V1KeyToPath</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="n">key</span><span class="p">,</span> <span class="n">path</span><span class="o">=</span><span class="n">path</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">path</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">secret_files</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
        <span class="p">]</span>
        <span class="c1"># workdir as an emptyDir volume of undefined size</span>
        <span class="n">workdir_volume</span> <span class="o">=</span> <span class="n">kubernetes</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">V1Volume</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;workdir&quot;</span><span class="p">)</span>
        <span class="n">workdir_volume</span><span class="o">.</span><span class="n">empty_dir</span> <span class="o">=</span> <span class="n">kubernetes</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">V1EmptyDirVolumeSource</span><span class="p">()</span>
        <span class="n">body</span><span class="o">.</span><span class="n">spec</span><span class="o">.</span><span class="n">volumes</span> <span class="o">=</span> <span class="p">[</span><span class="n">secret_volume</span><span class="p">,</span> <span class="n">workdir_volume</span><span class="p">]</span>

        <span class="c1"># env vars</span>
        <span class="n">container</span><span class="o">.</span><span class="n">env</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">e</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">secret_envvars</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">envvar</span> <span class="o">=</span> <span class="n">kubernetes</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">V1EnvVar</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">e</span><span class="p">)</span>
            <span class="n">envvar</span><span class="o">.</span><span class="n">value_from</span> <span class="o">=</span> <span class="n">kubernetes</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">V1EnvVarSource</span><span class="p">()</span>
            <span class="n">envvar</span><span class="o">.</span><span class="n">value_from</span><span class="o">.</span><span class="n">secret_key_ref</span> <span class="o">=</span> <span class="n">kubernetes</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">V1SecretKeySelector</span><span class="p">(</span>
                <span class="n">key</span><span class="o">=</span><span class="n">key</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">run_namespace</span><span class="p">)</span>
            <span class="n">container</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">envvar</span><span class="p">)</span>

        <span class="c1"># request resources</span>
        <span class="n">container</span><span class="o">.</span><span class="n">resources</span> <span class="o">=</span> <span class="n">kubernetes</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">V1ResourceRequirements</span><span class="p">()</span>
        <span class="n">container</span><span class="o">.</span><span class="n">resources</span><span class="o">.</span><span class="n">requests</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">container</span><span class="o">.</span><span class="n">resources</span><span class="o">.</span><span class="n">requests</span><span class="p">[</span><span class="s2">&quot;cpu&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">job</span><span class="o">.</span><span class="n">resources</span><span class="p">[</span><span class="s2">&quot;_cores&quot;</span><span class="p">]</span>
        <span class="k">if</span> <span class="s2">&quot;mem_mb&quot;</span> <span class="ow">in</span> <span class="n">job</span><span class="o">.</span><span class="n">resources</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="n">container</span><span class="o">.</span><span class="n">resources</span><span class="o">.</span><span class="n">requests</span><span class="p">[</span><span class="s2">&quot;memory&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{}</span><span class="s2">M&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="n">job</span><span class="o">.</span><span class="n">resources</span><span class="p">[</span><span class="s2">&quot;mem_mb&quot;</span><span class="p">])</span>

        <span class="c1"># capabilities</span>
        <span class="k">if</span> <span class="n">job</span><span class="o">.</span><span class="n">needs_singularity</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">workflow</span><span class="o">.</span><span class="n">use_singularity</span><span class="p">:</span>
            <span class="c1"># TODO this should work, but it doesn&#39;t currently because of</span>
            <span class="c1"># missing loop devices</span>
            <span class="c1"># singularity inside docker requires SYS_ADMIN capabilities</span>
            <span class="c1"># see https://groups.google.com/a/lbl.gov/forum/#!topic/singularity/e9mlDuzKowc</span>
            <span class="c1"># container.capabilities = kubernetes.client.V1Capabilities()</span>
            <span class="c1"># container.capabilities.add = [&quot;SYS_ADMIN&quot;,</span>
            <span class="c1">#                               &quot;DAC_OVERRIDE&quot;,</span>
            <span class="c1">#                               &quot;SETUID&quot;,</span>
            <span class="c1">#                               &quot;SETGID&quot;,</span>
            <span class="c1">#                               &quot;SYS_CHROOT&quot;]</span>

            <span class="c1"># Running in priviledged mode always works</span>
            <span class="n">container</span><span class="o">.</span><span class="n">security_context</span> <span class="o">=</span> <span class="n">kubernetes</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">V1SecurityContext</span><span class="p">(</span>
                <span class="n">privileged</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="n">pod</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_kubernetes_retry</span><span class="p">(</span>
            <span class="k">lambda</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">kubeapi</span><span class="o">.</span><span class="n">create_namespaced_pod</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">namespace</span><span class="p">,</span> <span class="n">body</span><span class="p">))</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Get status with:</span><span class="se">\n</span><span class="s2">&quot;</span>
                    <span class="s2">&quot;kubectl describe pod </span><span class="si">{jobid}</span><span class="se">\n</span><span class="s2">&quot;</span>
                    <span class="s2">&quot;kubectl logs </span><span class="si">{jobid}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">jobid</span><span class="o">=</span><span class="n">jobid</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">active_jobs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">KubernetesJob</span><span class="p">(</span>
            <span class="n">job</span><span class="p">,</span> <span class="n">jobid</span><span class="p">,</span> <span class="n">callback</span><span class="p">,</span> <span class="n">error_callback</span><span class="p">,</span> <span class="n">pod</span><span class="p">,</span> <span class="kc">None</span><span class="p">))</span></div>

    <span class="k">def</span> <span class="nf">_kubernetes_retry</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">func</span><span class="p">):</span>
        <span class="kn">import</span> <span class="nn">kubernetes</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">lock</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">func</span><span class="p">()</span>
            <span class="k">except</span> <span class="n">kubernetes</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">rest</span><span class="o">.</span><span class="n">ApiException</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">e</span><span class="o">.</span><span class="n">status</span> <span class="o">==</span> <span class="mi">401</span><span class="p">:</span>
                    <span class="c1"># Unauthorized.</span>
                    <span class="c1"># Reload config in order to ensure token is</span>
                    <span class="c1"># refreshed. Then try again.</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;trying to reauthenticate&quot;</span><span class="p">)</span>
                    <span class="n">kubernetes</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">load_kube_config</span><span class="p">()</span>
                    <span class="n">subprocess</span><span class="o">.</span><span class="n">run</span><span class="p">([</span><span class="s1">&#39;kubectl&#39;</span><span class="p">,</span><span class="s1">&#39;get&#39;</span><span class="p">,</span><span class="s1">&#39;nodes&#39;</span><span class="p">])</span>

                    <span class="bp">self</span><span class="o">.</span><span class="n">kubeapi</span> <span class="o">=</span> <span class="n">kubernetes</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">CoreV1Api</span><span class="p">()</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">batchapi</span> <span class="o">=</span> <span class="n">kubernetes</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">BatchV1Api</span><span class="p">()</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">register_secret</span><span class="p">()</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="k">return</span> <span class="n">func</span><span class="p">()</span>
                    <span class="k">except</span> <span class="n">kubernetes</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">rest</span><span class="o">.</span><span class="n">ApiException</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                        <span class="c1"># Both attempts failed, raise error.</span>
                        <span class="k">raise</span> <span class="n">WorkflowError</span><span class="p">(</span><span class="n">e</span><span class="p">,</span>
                            <span class="s2">&quot;This is likely a bug in &quot;</span>
                            <span class="s2">&quot;https://github.com/kubernetes-client/python.&quot;</span><span class="p">)</span>
            <span class="c1">#Handling timeout that may occur in case of GKE master upgrade</span>
            <span class="k">except</span> <span class="n">urllib3</span><span class="o">.</span><span class="n">exceptions</span><span class="o">.</span><span class="n">MaxRetryError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                        <span class="s2">&quot;Request time out! &quot;</span>
                        <span class="s2">&quot;check your connection to Kubernetes master&quot;</span>
                        <span class="s2">&quot;Workflow will pause for 5 minutes to allow any update operations to complete&quot;</span><span class="p">)</span>
                <span class="n">time</span><span class="o">.</span><span class="n">sleep</span> <span class="p">(</span><span class="mi">300</span><span class="p">)</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="k">return</span> <span class="n">func</span><span class="p">()</span>
                <span class="k">except</span><span class="p">:</span>
                    <span class="c1">#Still can&#39;t reach the server after 5 minutes</span>
                    <span class="k">raise</span> <span class="n">WorkflowErroe</span><span class="p">(</span><span class="n">e</span><span class="p">,</span>
                            <span class="s2">&quot;Error 111 connection timeout, please check&quot;</span>
                            <span class="s2">&quot; that the k8 cluster master is reachable!&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_wait_for_jobs</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="kn">import</span> <span class="nn">kubernetes</span>
        <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
            <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">lock</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">wait</span><span class="p">:</span>
                    <span class="k">return</span>
                <span class="n">active_jobs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">active_jobs</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">active_jobs</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
                <span class="n">still_running</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">active_jobs</span><span class="p">:</span>
                <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">status_rate_limiter</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Checking status for pod </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">j</span><span class="o">.</span><span class="n">jobid</span><span class="p">))</span>
                    <span class="n">job_not_found</span> <span class="o">=</span> <span class="kc">False</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">res</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_kubernetes_retry</span><span class="p">(</span>
                            <span class="k">lambda</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">kubeapi</span><span class="o">.</span><span class="n">read_namespaced_pod_status</span><span class="p">(</span><span class="n">j</span><span class="o">.</span><span class="n">jobid</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">namespace</span><span class="p">))</span>
                    <span class="k">except</span> <span class="n">kubernetes</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">rest</span><span class="o">.</span><span class="n">ApiException</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">e</span><span class="o">.</span><span class="n">status</span> <span class="o">==</span> <span class="mi">404</span><span class="p">:</span>
                            <span class="c1"># Jobid not found</span>
                            <span class="c1"># The job is likely already done and was deleted on</span>
                            <span class="c1"># the server.</span>
                            <span class="n">j</span><span class="o">.</span><span class="n">callback</span><span class="p">(</span><span class="n">j</span><span class="o">.</span><span class="n">job</span><span class="p">)</span>
                            <span class="k">continue</span>
                    <span class="k">except</span> <span class="n">WorkflowError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                        <span class="n">print_exception</span><span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">workflow</span><span class="o">.</span><span class="n">linemaps</span><span class="p">)</span>
                        <span class="n">j</span><span class="o">.</span><span class="n">error_callback</span><span class="p">(</span><span class="n">j</span><span class="o">.</span><span class="n">job</span><span class="p">)</span>
                        <span class="k">continue</span>

                    <span class="k">if</span> <span class="n">res</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;Unknown pod </span><span class="si">{jobid}</span><span class="s2">. &quot;</span>
                               <span class="s2">&quot;Has the pod been deleted &quot;</span>
                               <span class="s2">&quot;manually?&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">jobid</span><span class="o">=</span><span class="n">j</span><span class="o">.</span><span class="n">jobid</span><span class="p">)</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">print_job_error</span><span class="p">(</span><span class="n">j</span><span class="o">.</span><span class="n">job</span><span class="p">,</span> <span class="n">msg</span><span class="o">=</span><span class="n">msg</span><span class="p">,</span> <span class="n">jobid</span><span class="o">=</span><span class="n">j</span><span class="o">.</span><span class="n">jobid</span><span class="p">)</span>
                        <span class="n">j</span><span class="o">.</span><span class="n">error_callback</span><span class="p">(</span><span class="n">j</span><span class="o">.</span><span class="n">job</span><span class="p">)</span>
                    <span class="k">elif</span> <span class="n">res</span><span class="o">.</span><span class="n">status</span><span class="o">.</span><span class="n">phase</span> <span class="o">==</span> <span class="s2">&quot;Failed&quot;</span><span class="p">:</span>
                        <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;For details, please issue:</span><span class="se">\n</span><span class="s2">&quot;</span>
                               <span class="s2">&quot;kubectl describe pod </span><span class="si">{jobid}</span><span class="se">\n</span><span class="s2">&quot;</span>
                               <span class="s2">&quot;kubectl logs </span><span class="si">{jobid}</span><span class="s2">&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">jobid</span><span class="o">=</span><span class="n">j</span><span class="o">.</span><span class="n">jobid</span><span class="p">)</span>
                        <span class="c1"># failed</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">print_job_error</span><span class="p">(</span><span class="n">j</span><span class="o">.</span><span class="n">job</span><span class="p">,</span> <span class="n">msg</span><span class="o">=</span><span class="n">msg</span><span class="p">,</span> <span class="n">jobid</span><span class="o">=</span><span class="n">j</span><span class="o">.</span><span class="n">jobid</span><span class="p">)</span>
                        <span class="n">j</span><span class="o">.</span><span class="n">error_callback</span><span class="p">(</span><span class="n">j</span><span class="o">.</span><span class="n">job</span><span class="p">)</span>
                    <span class="k">elif</span> <span class="n">res</span><span class="o">.</span><span class="n">status</span><span class="o">.</span><span class="n">phase</span> <span class="o">==</span> <span class="s2">&quot;Succeeded&quot;</span><span class="p">:</span>
                        <span class="c1"># finished</span>
                        <span class="n">j</span><span class="o">.</span><span class="n">callback</span><span class="p">(</span><span class="n">j</span><span class="o">.</span><span class="n">job</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="c1"># still active</span>
                        <span class="n">still_running</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">j</span><span class="p">)</span>
            <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">lock</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">active_jobs</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">still_running</span><span class="p">)</span>
            <span class="n">sleep</span><span class="p">()</span></div>


<div class="viewcode-block" id="run_wrapper"><a class="viewcode-back" href="../../api_reference/internal/snakemake.html#snakemake.executors.run_wrapper">[docs]</a><span class="k">def</span> <span class="nf">run_wrapper</span><span class="p">(</span><span class="n">job_rule</span><span class="p">,</span> <span class="nb">input</span><span class="p">,</span> <span class="n">output</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span> <span class="n">wildcards</span><span class="p">,</span> <span class="n">threads</span><span class="p">,</span> <span class="n">resources</span><span class="p">,</span> <span class="n">log</span><span class="p">,</span>
                <span class="n">benchmark</span><span class="p">,</span> <span class="n">benchmark_repeats</span><span class="p">,</span> <span class="n">conda_env</span><span class="p">,</span> <span class="n">singularity_img</span><span class="p">,</span>
                <span class="n">singularity_args</span><span class="p">,</span> <span class="n">use_singularity</span><span class="p">,</span> <span class="n">linemaps</span><span class="p">,</span> <span class="n">debug</span><span class="p">,</span>
                <span class="n">shadow_dir</span><span class="p">,</span> <span class="n">jobid</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Wrapper around the run method that handles exceptions and benchmarking.</span>

<span class="sd">    Arguments</span>
<span class="sd">    job_rule   -- the ``job.rule`` member</span>
<span class="sd">    input      -- list of input files</span>
<span class="sd">    output     -- list of output files</span>
<span class="sd">    wildcards  -- so far processed wildcards</span>
<span class="sd">    threads    -- usable threads</span>
<span class="sd">    log        -- list of log files</span>
<span class="sd">    shadow_dir -- optional shadow directory root</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># get shortcuts to job_rule members</span>
    <span class="n">run</span> <span class="o">=</span> <span class="n">job_rule</span><span class="o">.</span><span class="n">run_func</span>
    <span class="n">version</span> <span class="o">=</span> <span class="n">job_rule</span><span class="o">.</span><span class="n">version</span>
    <span class="n">rule</span> <span class="o">=</span> <span class="n">job_rule</span><span class="o">.</span><span class="n">name</span>
    <span class="n">is_shell</span> <span class="o">=</span> <span class="n">job_rule</span><span class="o">.</span><span class="n">shellcmd</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>

    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="s2">&quot;posix&quot;</span> <span class="ow">and</span> <span class="n">debug</span><span class="p">:</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">stdin</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="s1">&#39;/dev/stdin&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">benchmark</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="kn">from</span> <span class="nn">snakemake.benchmark</span> <span class="k">import</span> <span class="n">BenchmarkRecord</span><span class="p">,</span> <span class="n">benchmarked</span><span class="p">,</span> <span class="n">write_benchmark_records</span>

    <span class="c1"># Change workdir if shadow defined and not using singularity.</span>
    <span class="c1"># Otherwise, we do the change from inside the container.</span>
    <span class="n">passed_shadow_dir</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">if</span> <span class="n">use_singularity</span><span class="p">:</span>
        <span class="n">passed_shadow_dir</span> <span class="o">=</span> <span class="n">shadow_dir</span>
        <span class="n">shadow_dir</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="k">with</span> <span class="n">change_working_directory</span><span class="p">(</span><span class="n">shadow_dir</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">benchmark</span><span class="p">:</span>
                <span class="n">bench_records</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">for</span> <span class="n">bench_iteration</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">benchmark_repeats</span><span class="p">):</span>
                    <span class="c1"># Determine whether to benchmark this process or do not</span>
                    <span class="c1"># benchmarking at all.  We benchmark this process unless the</span>
                    <span class="c1"># execution is done through the ``shell:``, ``script:``, or</span>
                    <span class="c1"># ``wrapper:`` stanza.</span>
                    <span class="n">is_sub</span> <span class="o">=</span> <span class="p">(</span><span class="n">job_rule</span><span class="o">.</span><span class="n">shellcmd</span> <span class="ow">or</span> <span class="n">job_rule</span><span class="o">.</span><span class="n">script</span> <span class="ow">or</span>
                              <span class="n">job_rule</span><span class="o">.</span><span class="n">wrapper</span> <span class="ow">or</span> <span class="n">job_rule</span><span class="o">.</span><span class="n">cwl</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">is_sub</span><span class="p">:</span>
                        <span class="c1"># The benchmarking through ``benchmarked()`` is started</span>
                        <span class="c1"># in the execution of the shell fragment, script, wrapper</span>
                        <span class="c1"># etc, as the child PID is available there.</span>
                        <span class="n">bench_record</span> <span class="o">=</span> <span class="n">BenchmarkRecord</span><span class="p">()</span>
                        <span class="n">run</span><span class="p">(</span><span class="nb">input</span><span class="p">,</span> <span class="n">output</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span> <span class="n">wildcards</span><span class="p">,</span> <span class="n">threads</span><span class="p">,</span> <span class="n">resources</span><span class="p">,</span>
                            <span class="n">log</span><span class="p">,</span> <span class="n">version</span><span class="p">,</span> <span class="n">rule</span><span class="p">,</span> <span class="n">conda_env</span><span class="p">,</span> <span class="n">singularity_img</span><span class="p">,</span>
                            <span class="n">singularity_args</span><span class="p">,</span> <span class="n">use_singularity</span><span class="p">,</span> <span class="n">bench_record</span><span class="p">,</span>
                            <span class="n">jobid</span><span class="p">,</span> <span class="n">is_shell</span><span class="p">,</span> <span class="n">bench_iteration</span><span class="p">,</span> <span class="n">passed_shadow_dir</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="c1"># The benchmarking is started here as we have a run section</span>
                        <span class="c1"># and the generated Python function is executed in this</span>
                        <span class="c1"># process&#39; thread.</span>
                        <span class="k">with</span> <span class="n">benchmarked</span><span class="p">()</span> <span class="k">as</span> <span class="n">bench_record</span><span class="p">:</span>
                            <span class="n">run</span><span class="p">(</span><span class="nb">input</span><span class="p">,</span> <span class="n">output</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span> <span class="n">wildcards</span><span class="p">,</span> <span class="n">threads</span><span class="p">,</span> <span class="n">resources</span><span class="p">,</span>
                                <span class="n">log</span><span class="p">,</span> <span class="n">version</span><span class="p">,</span> <span class="n">rule</span><span class="p">,</span> <span class="n">conda_env</span><span class="p">,</span> <span class="n">singularity_img</span><span class="p">,</span>
                                <span class="n">singularity_args</span><span class="p">,</span> <span class="n">use_singularity</span><span class="p">,</span>
                                <span class="n">bench_record</span><span class="p">,</span> <span class="n">jobid</span><span class="p">,</span> <span class="n">is_shell</span><span class="p">,</span> <span class="n">bench_iteration</span><span class="p">,</span>
                                <span class="n">passed_shadow_dir</span><span class="p">)</span>
                    <span class="c1"># Store benchmark record for this iteration</span>
                    <span class="n">bench_records</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">bench_record</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">run</span><span class="p">(</span><span class="nb">input</span><span class="p">,</span> <span class="n">output</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span> <span class="n">wildcards</span><span class="p">,</span> <span class="n">threads</span><span class="p">,</span> <span class="n">resources</span><span class="p">,</span>
                    <span class="n">log</span><span class="p">,</span> <span class="n">version</span><span class="p">,</span> <span class="n">rule</span><span class="p">,</span> <span class="n">conda_env</span><span class="p">,</span> <span class="n">singularity_img</span><span class="p">,</span>
                    <span class="n">singularity_args</span><span class="p">,</span> <span class="n">use_singularity</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="n">jobid</span><span class="p">,</span> <span class="n">is_shell</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span>
                    <span class="n">passed_shadow_dir</span><span class="p">)</span>
    <span class="k">except</span> <span class="p">(</span><span class="ne">KeyboardInterrupt</span><span class="p">,</span> <span class="ne">SystemExit</span><span class="p">)</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="c1"># Re-raise the keyboard interrupt in order to record an error in the</span>
        <span class="c1"># scheduler but ignore it</span>
        <span class="k">raise</span> <span class="n">e</span>
    <span class="k">except</span> <span class="p">(</span><span class="ne">Exception</span><span class="p">,</span> <span class="ne">BaseException</span><span class="p">)</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
        <span class="n">log_verbose_traceback</span><span class="p">(</span><span class="n">ex</span><span class="p">)</span>
        <span class="c1"># this ensures that exception can be re-raised in the parent thread</span>
        <span class="n">lineno</span><span class="p">,</span> <span class="n">file</span> <span class="o">=</span> <span class="n">get_exception_origin</span><span class="p">(</span><span class="n">ex</span><span class="p">,</span> <span class="n">linemaps</span><span class="p">)</span>
        <span class="k">raise</span> <span class="n">RuleException</span><span class="p">(</span><span class="n">format_error</span><span class="p">(</span><span class="n">ex</span><span class="p">,</span> <span class="n">lineno</span><span class="p">,</span>
                                         <span class="n">linemaps</span><span class="o">=</span><span class="n">linemaps</span><span class="p">,</span>
                                         <span class="n">snakefile</span><span class="o">=</span><span class="n">file</span><span class="p">,</span>
                                         <span class="n">show_traceback</span><span class="o">=</span><span class="kc">True</span><span class="p">))</span>

    <span class="k">if</span> <span class="n">benchmark</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">write_benchmark_records</span><span class="p">(</span><span class="n">bench_records</span><span class="p">,</span> <span class="n">benchmark</span><span class="p">)</span>
        <span class="k">except</span> <span class="p">(</span><span class="ne">Exception</span><span class="p">,</span> <span class="ne">BaseException</span><span class="p">)</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">WorkflowError</span><span class="p">(</span><span class="n">ex</span><span class="p">)</span></div>
</pre></div>

           </div>
           
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2014-2016, Johannes Koester

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>